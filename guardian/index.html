<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#070711" />
  <title>$SOS ‚Äî Guardian Check</title>
  <meta name="description" content="Guardian Approved ‚Äî Solana token risk score + launch readiness checklist." />

  <style>
    :root{
      --bg:#070711;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);

      --g:#14F195;
      --c:#00D1FF;
      --p:#9945FF;

      --radius: 22px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --max: 1180px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font: 15.5px/1.55 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg);
      overflow-x:hidden;
      position:relative;
    }
    body::before{
      content:"";
      position:fixed; inset:0; z-index:-1; pointer-events:none;
      background:
        radial-gradient(1200px 700px at 10% 5%, rgba(153,69,255,.22), transparent 60%),
        radial-gradient(1000px 650px at 90% 10%, rgba(20,241,149,.18), transparent 55%),
        radial-gradient(900px 600px at 70% 85%, rgba(0,209,255,.14), transparent 55%),
        var(--bg);
      transform: translateZ(0);
    }

    a{color:inherit; text-decoration:none}
    .wrap{max-width:var(--max); margin:0 auto; padding:0 18px}

    .topbar{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(14px);
      background: rgba(7,7,17,.62);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .row{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:12px 0;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 260px;
      user-select:none;
    }
    .brand img{
      width:40px; height:40px; object-fit:contain;
      filter: drop-shadow(0 10px 25px rgba(0,0,0,.45));
    }
    .bt{display:flex; flex-direction:column; line-height:1.05}
    .bt .t{font-weight:1000; letter-spacing:-.2px; font-size:16px}
    .bt .s{font-weight:850; color:var(--muted); font-size:12.5px}

    .actions{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
      width:100%;
    }
    @media (min-width: 980px){ .actions{width:auto} }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
      font-weight:950;
      font-size:13px;
      transition: .15s ease;
      user-select:none;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
    }
    .btn:hover{background: rgba(255,255,255,.10); transform: translateY(-1px)}
    .btn.grad{
      border:0;
      background: linear-gradient(90deg, var(--g), var(--c), var(--p));
      color:#061012;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .btn[disabled]{opacity:.55; pointer-events:none}

    main{padding:22px 0 42px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .inner{padding:22px}

    .hero{
      position:relative;
      overflow:hidden;
      isolation:isolate;
    }
    .hero::before{
      content:"";
      position:absolute;
      inset:-70px -40px;
      background:
        radial-gradient(900px 520px at 18% 28%, rgba(20,241,149,.16), transparent 60%),
        radial-gradient(900px 520px at 82% 20%, rgba(0,209,255,.12), transparent 60%),
        radial-gradient(900px 520px at 70% 86%, rgba(153,69,255,.14), transparent 60%);
      z-index:0; pointer-events:none;
    }
    .hero > *{position:relative; z-index:1}

    .h1{
      margin:0;
      font-weight:1000;
      letter-spacing:-1px;
      line-height:1.05;
      font-size: clamp(36px, 4.6vw, 62px);
    }
    .gradText{
      background: linear-gradient(90deg, var(--g), var(--c), var(--p));
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .sub{
      margin-top:10px;
      color: rgba(255,255,255,.76);
      font-weight:850;
      max-width: 920px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
      margin-top:16px;
      align-items:start;
    }
    @media (max-width: 980px){ .grid2{grid-template-columns:1fr} }

    .panel{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      padding:16px;
    }

    label{
      display:block;
      font-weight:950;
      font-size:12.5px;
      letter-spacing:.35px;
      color: rgba(255,255,255,.82);
      margin-bottom:8px
    }
    input{
      width:100%;
      padding:14px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      outline:none;
      font-weight:900;
      letter-spacing:.2px;
      font-size:16px;
    }
    input:focus{
      border-color: rgba(0,209,255,.45);
      box-shadow: 0 0 0 3px rgba(0,209,255,.12);
    }

    .classified{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
    }
    .stamp{
      font-weight:1000;
      font-size:12px;
      letter-spacing: .45px;
      text-transform:uppercase;
      color: rgba(255,255,255,.76);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      padding:7px 10px;
    }

    .big{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      margin-top:10px;
    }
    .big .left{ min-width: 240px; }
    .title2{
      margin:0;
      font-weight:1000;
      font-size:22px;
      letter-spacing:-.4px;
    }
    .mono{
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-weight:900;
      color: rgba(255,255,255,.86);
      margin-top:6px;
      word-break: break-all;
    }

    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      padding:7px 11px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
    }
    .badge.good{border:0; background: linear-gradient(90deg,var(--g),var(--c),var(--p)); color:#061012}
    .badge.warn{border-color: rgba(255,220,130,.35); background: rgba(255,220,130,.08); color: rgba(255,240,210,.92)}
    .badge.bad{border-color: rgba(255,120,150,.35); background: rgba(255,120,150,.10); color: rgba(255,190,205,.95)}

    .kpiGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 980px){ .kpiGrid{grid-template-columns: repeat(2,1fr)} }
    @media (max-width: 520px){ .kpiGrid{grid-template-columns: 1fr} }

    .kpi{
      padding:14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .kpi .k{
      color: rgba(255,255,255,.70);
      font-weight:900;
      font-size:12px;
      letter-spacing:.45px;
      text-transform:uppercase;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .kpi .v{margin-top:8px; font-weight:1000; font-size:20px}
    .kpi .mini{margin-top:6px; font-weight:850; font-size:12px; color: rgba(255,255,255,.62)}

    .bar{
      margin-top:10px;
      height:12px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--g), var(--c), var(--p));
      border-radius:999px;
      transition: width .25s ease;
    }

    .statusLine{
      margin-top:12px;
      color: rgba(255,255,255,.72);
      font-weight:900;
      min-height: 18px;
      font-size:13px;
    }

    .list{
      margin:10px 0 0;
      padding:0;
      list-style:none;
      display:grid;
      gap:10px;
    }
    .li{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      border-radius: 16px;
      padding:12px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .li .left{
      min-width:0;
    }
    .li .t{
      font-weight:1000;
      font-size:13px;
      letter-spacing:.2px;
    }
    .li .d{
      margin-top:4px;
      color: rgba(255,255,255,.70);
      font-weight:750;
      font-size:12.5px;
      line-height:1.35;
    }
    .pill{
      flex:0 0 auto;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
    }
    .pill.ok{border:0; background: linear-gradient(90deg,var(--g),var(--c),var(--p)); color:#061012}
    .pill.warn{border-color: rgba(255,220,130,.35); background: rgba(255,220,130,.08); color: rgba(255,240,210,.92)}
    .pill.bad{border-color: rgba(255,120,150,.35); background: rgba(255,120,150,.10); color: rgba(255,190,205,.95)}

    .copyRow{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .copyBox{
      flex: 1 1 520px;
      min-width: 260px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      border-radius: 16px;
      padding:12px 12px;
    }
    .copyMono{
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-weight:900;
      color: rgba(255,255,255,.86);
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      max-width: 100%;
    }
    .hint{
      flex:0 0 auto;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
    }
    .hint.ok{border:0; background: linear-gradient(90deg,var(--g),var(--c),var(--p)); color:#061012}

    footer{
      padding: 18px 0 34px;
      color: rgba(255,255,255,.45);
      font-weight:650;
      text-align:center;
      font-size:12px;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <img id="brandLogo" src="../assets/logo.png" alt="$SOS" onerror="this.style.display='none'">
          <div class="bt">
            <div class="t">$SOS</div>
            <div class="s">Guardian Check ‚Ä¢ Token Risk</div>
          </div>
        </div>

        <div class="actions">
          <a class="btn" href="https://solanax1.com/" rel="noreferrer">‚Üê Back to Main</a>
          <button class="btn grad" id="btnScan">Run Guardian Check</button>
          <a class="btn" id="btnShare" href="#" target="_blank" rel="noreferrer" style="opacity:.55; pointer-events:none;">Share on X</a>
        </div>
      </div>
    </div>
  </div>

  <main class="wrap">
    <section class="card hero">
      <div class="inner">
        <div class="classified">
          <div class="stamp">GUARDIAN SYSTEM ‚Ä¢ MAINNET ‚Ä¢ TOKEN INTEL</div>
          <div class="stamp" id="stampTime">‚Äî</div>
        </div>

        <h1 class="h1" style="margin-top:12px;"><span class="gradText">Guardian Approved</span> Check</h1>
        <div class="sub">
          Solana-native token safety scan: authorities, concentration, program type ‚Äî plus a Launch Readiness checklist.
          (MVP uses verifiable on-chain RPC signals. No fake ‚Äúlocked LP‚Äù claims.)
        </div>

        <div class="grid2">
          <!-- Input -->
          <div class="panel">
            <label for="mint">Token Mint Address</label>
            <input id="mint" placeholder="Paste token mint (Solana)..." autocomplete="off" spellcheck="false" />
            <div class="statusLine" id="status"></div>

            <div class="copyRow">
              <div class="copyBox" id="badgeBox" role="button" tabindex="0" aria-label="Copy Guardian Badge HTML">
                <div style="min-width:0">
                  <div style="font-weight:1000; font-size:12px; letter-spacing:.35px; color:rgba(255,255,255,.78); text-transform:uppercase;">Badge Embed (HTML)</div>
                  <div class="copyMono" id="badgeHtml">Run a scan to generate‚Ä¶</div>
                </div>
                <div class="hint" id="badgeHint">Click to copy</div>
              </div>
            </div>
          </div>

          <!-- Headline -->
          <div class="panel">
            <div class="big">
              <div class="left">
                <h3 class="title2" id="verdictTitle">‚Äî</h3>
                <div class="mono" id="mintShort">‚Äî</div>
              </div>
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <span class="badge" id="verdictBadge">‚Äî</span>
                <span class="badge good" id="scoreBadge">‚Äî</span>
              </div>
            </div>

            <div class="kpiGrid">
              <div class="kpi">
                <div class="k">Risk Score</div>
                <div class="v" id="kScore">‚Äî</div>
                <div class="mini" id="kScoreM">‚Äî</div>
                <div class="bar"><div id="bScore"></div></div>
              </div>

              <div class="kpi">
                <div class="k">Authorities</div>
                <div class="v" id="kAuth">‚Äî</div>
                <div class="mini" id="kAuthM">‚Äî</div>
              </div>

              <div class="kpi">
                <div class="k">Top 20 Concentration</div>
                <div class="v" id="kTop20">‚Äî</div>
                <div class="mini" id="kTop20M">‚Äî</div>
                <div class="bar"><div id="bTop20"></div></div>
              </div>

              <div class="kpi">
                <div class="k">Program</div>
                <div class="v" id="kProg">‚Äî</div>
                <div class="mini" id="kProgM">‚Äî</div>
              </div>

              <div class="kpi">
                <div class="k">Supply</div>
                <div class="v" id="kSupply">‚Äî</div>
                <div class="mini" id="kSupplyM">‚Äî</div>
              </div>

              <div class="kpi">
                <div class="k">Decimals</div>
                <div class="v" id="kDec">‚Äî</div>
                <div class="mini" id="kDecM">‚Äî</div>
              </div>
            </div>

            <div class="statusLine" id="summary">‚Äî</div>
          </div>
        </div>

        <!-- Checks -->
        <div class="panel" style="margin-top:16px;">
          <div class="classified">
            <div class="stamp">GUARDIAN CHECKS</div>
            <div class="stamp" id="scanHint">‚Äî</div>
          </div>
          <ul class="list" id="checksList" style="margin-top:10px;">
            <li class="li">
              <div class="left">
                <div class="t">No scan yet</div>
                <div class="d">Paste a mint address and run the Guardian Check.</div>
              </div>
              <span class="pill">‚Äî</span>
            </li>
          </ul>
        </div>

        <!-- Launch readiness -->
        <div class="panel" style="margin-top:16px;">
          <div class="classified">
            <div class="stamp">LAUNCH READINESS</div>
            <div class="stamp">TO-DO LIST</div>
          </div>
          <ul class="list" id="todoList" style="margin-top:10px;">
            <li class="li">
              <div class="left">
                <div class="t">Waiting for scan</div>
                <div class="d">We generate a launch checklist after we read on-chain signals.</div>
              </div>
              <span class="pill">‚Äî</span>
            </li>
          </ul>
        </div>

      </div>
    </section>

    <footer>¬© <span id="y"></span> $SOS ‚Ä¢ Guardian Check</footer>
  </main>

<script>
/* ============================================================
   CONFIG
   ‚ö†Ô∏è If you keep a Helius key in a public static site, it is visible.
   Restrict it inside Helius dashboard (allowed domains + rate limits).
============================================================ */
const HELIUS_KEY = "a16897d9-ee14-46e0-aacd-7d3c7a7d3421";

// Token programs
const TOKEN_PROGRAM = "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA";
const TOKEN_2022_PROGRAM = "TokenzQdBNbLqP5VEhdkAS6EPFLC1PHnBqCXEpPxuEb";

const $ = (id)=>document.getElementById(id);
$("y").textContent = new Date().getFullYear();

function setStatus(msg){ const el = $("status"); if(el) el.textContent = msg || ""; }
function setText(id, v){ const el=$(id); if(el) el.textContent = v; }
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function pctBar(el, val){ if(el) el.style.width = clamp(val,0,100) + "%"; }

function looksBase58(s){
  return typeof s === "string"
    && s.length >= 32 && s.length <= 52
    && /^[1-9A-HJ-NP-Za-km-z]+$/.test(s);
}
function shortAddr(a){ return a ? (a.slice(0,4)+"‚Ä¶"+a.slice(-4)) : "‚Äî"; }
function fmtInt(n){
  if(n === null || n === undefined || Number.isNaN(n)) return "‚Äî";
  try { return new Intl.NumberFormat("en-US").format(Math.round(Number(n))); } catch { return String(n); }
}
function fmtPct(n){
  if(n === null || n === undefined || Number.isNaN(n)) return "‚Äî";
  return `${Number(n).toFixed(2)}%`;
}
function setBadge(el, txt, mode){
  if(!el) return;
  el.textContent = txt;
  el.classList.remove("good","warn","bad");
  if(mode) el.classList.add(mode);
}
function updateStampTime(){
  const el = $("stampTime");
  if(el) el.textContent = new Date().toISOString().replace("T"," ").slice(0,19) + " UTC";
}
updateStampTime();
setInterval(updateStampTime, 1000);

// --- clipboard helper
async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
    return true;
  }catch(e){
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.setAttribute("readonly","");
    ta.style.position="fixed";
    ta.style.top="-9999px";
    document.body.appendChild(ta);
    ta.select();
    try{
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      return ok;
    }catch(err){
      document.body.removeChild(ta);
      return false;
    }
  }
}
function hint(el, ok){
  if(!el) return;
  if(ok){
    el.textContent = "Copied!";
    el.classList.add("ok");
    setTimeout(()=>{ el.textContent="Click to copy"; el.classList.remove("ok"); }, 1200);
  }else{
    el.textContent = "Copy failed";
    setTimeout(()=>{ el.textContent="Click to copy"; }, 1200);
  }
}
$("badgeBox").addEventListener("click", async ()=>{
  const txt = $("badgeHtml").textContent || "";
  if(!txt || txt.includes("Run a scan")) return;
  const ok = await copyText(txt);
  hint($("badgeHint"), ok);
});
$("badgeBox").addEventListener("keydown", async (e)=>{
  if(e.key==="Enter" || e.key===" "){
    e.preventDefault();
    const txt = $("badgeHtml").textContent || "";
    if(!txt || txt.includes("Run a scan")) return;
    const ok = await copyText(txt);
    hint($("badgeHint"), ok);
  }
});

// --- RPC (Helius)
const HELIUS_RPC = ()=> `https://mainnet.helius-rpc.com/?api-key=${encodeURIComponent(HELIUS_KEY)}`;

async function rpc(method, params){
  if(!HELIUS_KEY || HELIUS_KEY.includes("PASTE_")) throw new Error("Helius key not set in CONFIG.");
  const res = await fetch(HELIUS_RPC(), {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ jsonrpc:"2.0", id:1, method, params })
  });
  if(!res.ok){
    const t = await res.text().catch(()=> "");
    throw new Error(`RPC HTTP ${res.status} ${t}`.slice(0,180));
  }
  const j = await res.json();
  if(j.error) throw new Error(j.error.message || "RPC error");
  return j.result;
}

async function getMintParsed(mint){
  const r = await rpc("getAccountInfo", [mint, { encoding:"jsonParsed", commitment:"confirmed" }]);
  const v = r?.value;
  if(!v) return null;
  const owner = v.owner;
  const data = v.data;
  const parsed = (data && typeof data === "object") ? data.parsed : null;
  const info = parsed?.info || null;
  return { owner, info };
}

async function getTokenSupply(mint){
  const r = await rpc("getTokenSupply", [mint]);
  return r?.value || null;
}
async function getLargest(mint){
  const r = await rpc("getTokenLargestAccounts", [mint]);
  return r?.value || [];
}

function verdictFrom(score, critical){
  if(critical) return {label:"FLAGGED", mode:"bad", title:"FLAGGED ‚Ä¢ High Risk"};
  if(score >= 80) return {label:"APPROVED", mode:"good", title:"APPROVED ‚Ä¢ Guardian Grade"};
  if(score >= 50) return {label:"OBSERVED", mode:"warn", title:"OBSERVED ‚Ä¢ Mixed Signals"};
  return {label:"FLAGGED", mode:"bad", title:"FLAGGED ‚Ä¢ High Risk"};
}

function scoreModel(sig){
  // sig = { mintAuthActive, freezeActive, top20, programType }
  let score = 100;
  const reasons = [];

  // critical authority risks
  if(sig.freezeActive){
    score -= 35;
    reasons.push({k:"Freeze Authority active", sev:"bad", d:"Freeze authority can block transfers. High-risk for buyers."});
  }else{
    reasons.push({k:"Freeze Authority removed", sev:"ok", d:"No freeze power detected (good)." });
  }

  if(sig.mintAuthActive){
    score -= 30;
    reasons.push({k:"Mint Authority active", sev:"bad", d:"Mint authority can increase supply. High-risk unless justified."});
  }else{
    reasons.push({k:"Mint Authority renounced", sev:"ok", d:"Supply cannot be minted further (good)." });
  }

  // concentration
  const t20 = Number(sig.top20 || 0);
  if(t20 >= 75){
    score -= 28;
    reasons.push({k:"Top 20 concentration very high", sev:"bad", d:`Top20 holds ~${t20.toFixed(2)}% of supply. Rug/sell risk.`});
  }else if(t20 >= 55){
    score -= 18;
    reasons.push({k:"Top 20 concentration high", sev:"warn", d:`Top20 holds ~${t20.toFixed(2)}% of supply. Watch distribution.`});
  }else if(t20 >= 35){
    score -= 8;
    reasons.push({k:"Top 20 concentration moderate", sev:"warn", d:`Top20 holds ~${t20.toFixed(2)}% of supply.`});
  }else{
    reasons.push({k:"Distribution looks healthier", sev:"ok", d:`Top20 holds ~${t20.toFixed(2)}% of supply.`});
  }

  // program type
  if(sig.programType === "TOKEN_2022"){
    score -= 8;
    reasons.push({k:"Token-2022 detected", sev:"warn", d:"Token-2022 can include advanced extensions (fees/delegates). Needs deeper checks (next phase)."});
  }else if(sig.programType === "SPL_TOKEN"){
    reasons.push({k:"SPL Token program", sev:"ok", d:"Standard SPL Token program detected."});
  }else{
    score -= 10;
    reasons.push({k:"Unknown token program", sev:"warn", d:"Mint is not owned by common token programs. Verify carefully."});
  }

  score = clamp(Math.round(score), 0, 100);

  const critical = !!(sig.freezeActive || sig.mintAuthActive);
  return { score, reasons, critical };
}

function buildTodo(sig){
  const todos = [];

  if(sig.freezeActive){
    todos.push({t:"Remove Freeze Authority", sev:"bad", d:"Freeze authority should be set to null for trust."});
  }else{
    todos.push({t:"Freeze Authority", sev:"ok", d:"Already removed (good)." });
  }

  if(sig.mintAuthActive){
    todos.push({t:"Renounce Mint Authority", sev:"bad", d:"Set mint authority to null so supply cannot be increased."});
  }else{
    todos.push({t:"Mint Authority", sev:"ok", d:"Already renounced (good)." });
  }

  const t20 = Number(sig.top20 || 0);
  if(t20 >= 55){
    todos.push({t:"Improve Distribution", sev:"warn", d:`Top20 holds ~${t20.toFixed(2)}%. Consider wider distribution / reduce concentration.`});
  }else{
    todos.push({t:"Distribution", sev:"ok", d:`Top20 concentration ~${t20.toFixed(2)}% (acceptable for MVP).`});
  }

  if(sig.programType === "TOKEN_2022"){
    todos.push({t:"Audit Token-2022 Extensions", sev:"warn", d:"Confirm no transfer fees / delegates / withholding extensions that harm buyers."});
  }else{
    todos.push({t:"Program Type", sev:"ok", d:"Standard token program detected."});
  }

  // Next phase placeholders (not lying; clearly labeled)
  todos.push({t:"Liquidity & Venues (Phase 2)", sev:"warn", d:"We‚Äôll add DEX liquidity + venue routing checks next (Jupiter/Orca/Raydium/Meteora)."});
  todos.push({t:"Metadata Immutability (Phase 2)", sev:"warn", d:"We‚Äôll add Metaplex metadata authority + mutability checks next."});

  return todos;
}

function renderList(el, items){
  el.innerHTML = "";
  for(const it of items){
    const li = document.createElement("li");
    li.className = "li";
    const pillCls = it.sev === "ok" ? "pill ok" : (it.sev === "bad" ? "pill bad" : "pill warn");
    const pillTxt = it.sev === "ok" ? "PASS" : (it.sev === "bad" ? "FAIL" : "WATCH");
    li.innerHTML = `
      <div class="left">
        <div class="t">${it.k || it.t}</div>
        <div class="d">${it.d}</div>
      </div>
      <span class="${pillCls}">${pillTxt}</span>
    `;
    el.appendChild(li);
  }
}

function setShareEnabled(enabled, url){
  const a = $("btnShare");
  if(!a) return;
  if(enabled){
    a.href = url;
    a.style.opacity = "1";
    a.style.pointerEvents = "auto";
  }else{
    a.href = "#";
    a.style.opacity = ".55";
    a.style.pointerEvents = "none";
  }
}

function buildShareText(mint, out){
  const link = location.origin + location.pathname + `?mint=${encodeURIComponent(mint)}`;
  const lines = [
    `üõ°Ô∏è GUARDIAN CHECK ‚Äî Token Risk`,
    ``,
    `Mint: ${shortAddr(mint)}`,
    `Verdict: ${out.verdict.label}`,
    `Score: ${out.score}/100`,
    `Authorities: ${out.authLine}`,
    `Top20: ${out.top20Text}`,
    `Program: ${out.programText}`,
    ``,
    `Run yours: ${link}`,
    `#Solana #Memecoins #Guardian`
  ];
  return lines.join("\n");
}

function badgeHtmlSnippet(mint, verdictLabel, score){
  const url = `https://solanax1.com/guardian?mint=${encodeURIComponent(mint)}`;
  // simple, embeddable badge (no external assets needed)
  return `<a href="${url}" target="_blank" rel="noreferrer" style="text-decoration:none">
  <span style="display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;font:700 12px ui-sans-serif,system-ui;letter-spacing:.3px;color:#061012;background:linear-gradient(90deg,#14F195,#00D1FF,#9945FF);box-shadow:0 10px 24px rgba(0,0,0,.25)">
    üõ°Ô∏è GUARDIAN ${verdictLabel} ‚Ä¢ ${score}/100
  </span>
</a>`;
}

async function scan(){
  const mint = $("mint").value.trim();
  setShareEnabled(false);

  if(!looksBase58(mint)){
    setStatus("Invalid mint address.");
    return;
  }
  if(!HELIUS_KEY || HELIUS_KEY.includes("PASTE_")){
    setStatus("Scanner not configured (Helius key missing).");
    return;
  }

  setStatus("Running Guardian Check‚Ä¶");
  setText("mintShort", shortAddr(mint));
  setText("verdictTitle", "‚Äî");
  setBadge($("verdictBadge"), "‚Äî");
  setText("scoreBadge", "‚Äî");

  try{
    const mintParsed = await getMintParsed(mint);
    if(!mintParsed || !mintParsed.info){
      throw new Error("Mint account not readable (not a token mint or RPC parsing failed).");
    }

    const owner = mintParsed.owner;
    const info = mintParsed.info;

    const mintAuthority = info.mintAuthority ?? null;
    const freezeAuthority = info.freezeAuthority ?? null;
    const decimals = Number(info.decimals ?? 0);

    const programType =
      owner === TOKEN_PROGRAM ? "SPL_TOKEN" :
      owner === TOKEN_2022_PROGRAM ? "TOKEN_2022" :
      "UNKNOWN";

    const [supply, largest] = await Promise.all([
      getTokenSupply(mint),
      getLargest(mint)
    ]);

    const uiSupply = supply ? Number(supply.uiAmount ?? 0) : Number(info.supply ?? 0);
    const top20 = (Array.isArray(largest) ? largest.slice(0,20) : []);
    const top20Sum = top20.reduce((acc,x)=> acc + Number(x.uiAmount || 0), 0);
    const conc = (uiSupply && uiSupply > 0) ? (top20Sum / uiSupply) * 100 : 0;

    const sig = {
      mintAuthActive: !!mintAuthority,
      freezeActive: !!freezeAuthority,
      top20: conc,
      programType
    };

    const model = scoreModel(sig);
    const verdict = verdictFrom(model.score, model.critical);

    // headline
    setText("verdictTitle", verdict.title);
    setBadge($("verdictBadge"), verdict.label, verdict.mode);

    setText("kScore", `${model.score}/100`);
    setText("kScoreM", verdict.label === "APPROVED" ? "Guardian-grade safety signals." :
                      verdict.label === "OBSERVED" ? "Mixed signals ‚Äî review checklist." :
                      "High-risk signals detected.");
    pctBar($("bScore"), model.score);
    $("scoreBadge").textContent = `SCORE ${model.score}`;

    const authLine = `${mintAuthority ? "MINT: ACTIVE" : "MINT: RENOUNCED"} ‚Ä¢ ${freezeAuthority ? "FREEZE: ACTIVE" : "FREEZE: REMOVED"}`;
    setText("kAuth", authLine);
    setText("kAuthM", mintAuthority || freezeAuthority ? "Authorities present = trust risk." : "No mint/freeze authority (good).");

    setText("kTop20", fmtPct(conc));
    setText("kTop20M", uiSupply ? `Top20: ${fmtInt(top20Sum)} / ${fmtInt(uiSupply)}` : "Supply not readable.");
    pctBar($("bTop20"), conc);

    const programText = programType === "SPL_TOKEN" ? "SPL Token" : (programType === "TOKEN_2022" ? "Token-2022" : "Unknown");
    setText("kProg", programText);
    setText("kProgM", owner ? `Owner: ${shortAddr(owner)}` : "‚Äî");

    setText("kSupply", uiSupply ? fmtInt(uiSupply) : "‚Äî");
    setText("kSupplyM", uiSupply ? "UI supply" : "‚Äî");
    setText("kDec", String(decimals));
    setText("kDecM", "Token decimals");

    // summary line
    const top20Text = fmtPct(conc);
    setText("summary", `${verdict.label} ‚Ä¢ Score ${model.score}/100 ‚Ä¢ ${authLine} ‚Ä¢ Top20 ${top20Text} ‚Ä¢ Program ${programText}`);
    setText("scanHint", `Mint: ${shortAddr(mint)}`);

    // render lists
    renderList($("checksList"), model.reasons.map(r=>({k:r.k, sev:r.sev, d:r.d})));
    renderList($("todoList"), buildTodo(sig));

    // badge embed
    const badge = badgeHtmlSnippet(mint, verdict.label, model.score);
    setText("badgeHtml", badge);

    // share
    const text = buildShareText(mint, {
      verdict,
      score: model.score,
      authLine,
      top20Text,
      programText
    });
    const u = new URL("https://x.com/intent/tweet");
    u.searchParams.set("text", text);
    setShareEnabled(true, u.toString());

    setStatus(`Guardian Check complete: ${verdict.label} ‚Ä¢ Score ${model.score}/100`);
  }catch(e){
    console.error(e);
    setStatus("Scan failed: " + (e?.message || "unknown error"));
  }
}

$("btnScan").addEventListener("click", scan);
$("mint").addEventListener("keydown", (e)=>{ if(e.key==="Enter") scan(); });

// auto-run if URL has ?mint=
(function(){
  const q = new URLSearchParams(location.search);
  const m = (q.get("mint") || "").trim();
  if(m){
    $("mint").value = m;
    // slight delay for UI
    setTimeout(()=>scan(), 150);
  }
})();
</script>
</body>
</html>
