<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#070711" />
  <title>$SOS â€” DEX Terminal (Multi-Chain)</title>
  <meta name="description" content="$SOS DEX Terminal â€” native chart + live trades across Solana, Ethereum, BNB, Base." />

  <style>
    :root{
      --bg:#070711;
      --bg2:#070711;
      --bg3:#070711;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.085);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --muted2: rgba(255,255,255,.55);
      --g:#14F195;
      --r:#FF4D6D;
      --c:#00D1FF;
      --p:#9945FF;
      --radius: 22px;
      --shadow: 0 14px 40px rgba(0,0,0,.55);
      --max: 1280px;
      --glass: blur(14px);
      --t: .18s ease;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
     margin:0;
     color:var(--text);
     font: 16px/1.6 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
     background: var(--bg);
     overflow-x:hidden;
     position: relative;
     }

    body::before{
     content:"";
     position: fixed;
     inset: 0;
     z-index: -1;
     pointer-events: none;
     background:
     radial-gradient(1200px 760px at 10% 5%, rgba(153,69,255,.24), transparent 60%),
     radial-gradient(1000px 720px at 90% 10%, rgba(20,241,149,.18), transparent 58%),
     radial-gradient(900px 640px at 72% 92%, rgba(0,209,255,.14), transparent 58%),
     radial-gradient(900px 640px at 0% 95%, rgba(0,209,255,.06), transparent 60%),
     var(--bg);
     transform: translateZ(0);
     }
a{color:inherit; text-decoration:none}
    button,input,select{font:inherit}

    .wrap{max-width:var(--max); margin:0 auto; padding: calc(var(--topbar-space, 84px) + 18px) 16px 28px}

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:12px 12px;
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border-radius: 26px;
      box-shadow: var(--shadow);
      backdrop-filter: var(--glass);
      position:fixed; top: calc(env(safe-area-inset-top) + 10px); left:50%; transform: translateX(-50%); width: min(var(--max), calc(100vw - 24px)); z-index:1000;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .topLogo{width:34px; height:34px; border-radius: 14px; object-fit:cover; box-shadow: 0 10px 24px rgba(0,0,0,.45)}
    .actions{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .pillRow{display:flex; gap:8px; flex-wrap:wrap}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 9px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.88);
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
      transition: transform var(--t), background var(--t), border-color var(--t);
      user-select:none;
    }
    .pill .dot{width:9px; height:9px; border-radius:999px; background: rgba(255,255,255,.35)}
    .pill.active{border-color: rgba(0,209,255,.55); background: rgba(0,209,255,.16)}
    .pill.active .dot{background: rgba(0,209,255,1)}
    .pill:active{transform: translateY(1px)}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding: 10px 14px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-weight: 950;
      font-size: 12px;
      cursor:pointer;
      transition: transform var(--t), background var(--t), border-color var(--t);
      user-select:none;
      white-space:nowrap;
    }
    .btn.primary{ background: linear-gradient(90deg, rgba(153,69,255,.95), rgba(0,209,255,.88)); border:0; color: rgba(7,7,17,.96) }
    .btn.ghost{ background: rgba(255,255,255,.04) }
    .btn:active{ transform: translateY(1px) }
    .xbtn{ padding: 10px 12px; }

    .panel{
      margin-top: 16px;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: 0 22px 70px rgba(0,0,0,.55);
      overflow:hidden;
      backdrop-filter: var(--glass);
    }

    .topBar{
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .topBarInner{display:flex; flex-direction:column; gap: 12px}
    .topRow{display:flex; align-items:center; justify-content:space-between; gap: 12px; flex-wrap:wrap}
    .hotBlock{
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 18px;
      background: rgba(0,0,0,.12);
      border: 1px solid rgba(255,255,255,.08);
      min-width: 210px;
      flex: 1 1 260px;
    }
    .hotLabel{
      display:flex; align-items:center; gap:8px;
      font-weight: 1000;
      font-size: 12px;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: rgba(255,255,255,.86);
      white-space:nowrap;
    }
    .hotFire{display:inline-block; transform: translateY(-1px)}
    .chainToggle{
      display:flex; gap:8px;
      padding: 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
    }
    .chainBtn{
      min-width: 56px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.86);
      font-weight: 1000;
      font-size: 12px;
      cursor:pointer;
      transition: background var(--t), border-color var(--t), transform var(--t);
      -webkit-tap-highlight-color: transparent;
    }
    .chainBtn.active{
      background: rgba(153,69,255,.20);
      border-color: rgba(153,69,255,.50);
      color: rgba(255,255,255,.92);
    }
    .chainBtn:active{ transform: translateY(1px); }

    .bottomRow{
      display:flex;
      align-items:stretch;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }

    .tickerWrap{
      flex: 1 1 520px;
      min-width: 260px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      overflow:hidden;
      position:relative;
    }
    .tickerTrack{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 0;
      will-change: transform;
    }
    .tickerItem{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.90);
      white-space:nowrap;
      cursor:pointer;
      transition: transform var(--t), background var(--t), border-color var(--t);
      font-size: 13px;
    }
    .tickerItem:hover{ background: rgba(255,255,255,.06) }
    .tickerItem:active{ transform: translateY(1px); }
    .tickerItem .rank{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 28px;
      height: 22px;
      padding: 0 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      font-weight: 1000;
      color: var(--netColor);
    }
    .tickerItem .sym{ font-weight: 950; }

    .tickerPct{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height: 22px;
      padding: 0 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      font-weight: 950;
      color: rgba(255,255,255,.90);
    }
    .tickerPct.up{ color: rgba(20,241,149,.98); background: rgba(20,241,149,.10); border-color: rgba(20,241,149,.22); }
    .tickerPct.down{ color: rgba(255,90,90,.96); background: rgba(255,90,90,.10); border-color: rgba(255,90,90,.22); }

    .tickerItem.top1{
      background: rgba(255,215,0,.10);
      border-color: rgba(255,215,0,.32);
      box-shadow: 0 0 0 1px rgba(255,215,0,.18) inset, 0 12px 30px rgba(0,0,0,.26);
    }
    .tickerItem.top1 .rank{
      background: linear-gradient(90deg, #F3BA2F, #FFD700, #FFF2B0);
      color: rgba(10,10,22,.92);
      border: 0;
      font-weight: 1100;
    }

    /* Search (styled like main page) */
    .dexSearch{position: relative; width: 360px; max-width: 44vw; z-index: 99999; isolation:isolate; }
    .dexSearchInner{
      display:flex;
      gap: 8px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
    }
    .dexInput{
      flex: 1;
      min-width: 0;
      background: transparent;
      border: 0;
      outline: none;
      color: rgba(255,255,255,.92);
      font-weight: 850;
      font-size: 13px;
    }
    .dexInput::placeholder{ color: rgba(255,255,255,.55); font-weight: 800; }
    .hint{
      font-size: 11px;
      opacity:.72;
      padding: 5px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      white-space:nowrap;
      user-select:none;
    }

    /* Re-skin existing results dropdown to match main page style */
    .results{
      z-index: 1000001;
display:none;
      position:absolute;
      top: calc(100% + 10px);
      right: 0;
      left: auto;
      width: min(560px, calc(100vw - 28px));
      max-height: 60vh;
      overflow:auto;
      padding: 10px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      /* IMPORTANT: fully readable dropdown (no chart bleed-through) */
      background: rgba(12,16,40,.98);
      box-shadow: 0 26px 90px rgba(0,0,0,.78);
      isolation: isolate;
      z-index: 999999;
    }

    /* Search modal scrim: blocks chart/trades from showing through while searching */
    .searchScrim{
      display:none;
      position:fixed;
      inset:0;
      background: rgba(7,7,17,.72);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 999990;
    }
    .dexSearch.open .searchScrim{ display:block; }

    .resItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
      margin-bottom: 8px;
    }
    .resItem:hover{ background: rgba(255,255,255,.05); }
    .resL{display:flex; align-items:center; gap: 12px; min-width:0}
    .resLogo{
      width: 40px; height: 40px; border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      display:grid; place-items:center;
      flex: 0 0 auto;
    }
    .resLogo img{width:100%; height:100%; object-fit:cover}
    .resLogo .fb{font-weight: 950; opacity:.9}
    .resTxt{min-width:0}
    .resName{font-weight: 950; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .resMeta{font-size: 12px; color: rgba(255,255,255,.65); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .resR{display:flex; align-items:center; gap: 8px; flex-wrap:wrap; justify-content:flex-end}
    .stat{
      display:inline-flex; align-items:center; gap: 6px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      font-size: 12px;
      color: rgba(255,255,255,.84);
      font-weight: 850;
    }
    .stat b{font-weight: 1000}
    .stat.up{color: rgba(20,241,149,.95); border-color: rgba(20,241,149,.22); background: rgba(20,241,149,.08)}
    .stat.down{color: rgba(255,77,109,.95); border-color: rgba(255,77,109,.22); background: rgba(255,77,109,.08)}

    /* Main grid */
    .grid{
      display:grid;
      grid-template-columns: 1.6fr .8fr;
      gap: 16px;
      padding: 16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr; padding: 14px;}
      .dexSearch{max-width: 100%; width: 100%;}
      .tickerWrap{flex: 1 1 100%}
    }

    .card{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.045);
      border-radius: 20px;
      overflow:hidden;
    }

    .cardHd{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:14px 14px;
      border-bottom:1px solid rgba(255,255,255,07);
    }
    .pair{display:flex; align-items:center; gap:10px; min-width:0}
    .tlogo{width:38px; height:38px; border-radius:14px; overflow:hidden; display:grid; place-items:center; background: rgba(255,255,255,06); border:1px solid rgba(255,255,255,10)}
    .tlogo img{width:100%; height:100%; object-fit:cover}
    .tlogo .fb{font-weight:900; opacity:.9}
    .pairTxt{min-width:0}
    .pairName{font-weight:950; letter-spacing:-.02em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .pairNameSub{font-size:12px; font-weight:800; opacity:.72; margin-left:8px; letter-spacing:0;}
    .pairMeta{font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .stats{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .statPill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      font-size:12px;
      color: rgba(255,255,255,.86);
      white-space:nowrap;
    }
    .statPill.up{border-color: rgba(20,241,149,.30); background: rgba(20,241,149,.10); color: rgba(20,241,149,.92)}
    .statPill.down{border-color: rgba(255,77,109,.28); background: rgba(255,77,109,.10); color: rgba(255,77,109,.92)}

    #chartWrap{height: clamp(380px, 52vh, 600px); position:relative; z-index:0}
    #chart{position:absolute; inset:0; z-index:1}
    /* Ensure dropdowns/menus always sit above the chart canvas */
    #chart canvas{position:relative; z-index:1}

    .controls{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-top:1px solid rgba(255,255,255,.07);
      background: rgba(0,0,0,.10);
      flex-wrap:wrap;
    }

    .tfRow{display:flex; gap:6px; flex-wrap:wrap}
    .tf{padding:8px 10px; border-radius: 999px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.05); cursor:pointer; font-weight:850; font-size:12px}
    .tf.active{border-color: rgba(0,209,255,.42); background: rgba(0,209,255,.14)}

    .rightCtl{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .sel{padding:9px 10px; border-radius: 999px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.05); color: var(--text)}

    .tableHd{
      display:flex; align-items:flex-end; justify-content:space-between;
      padding:14px 14px;
      border-bottom:1px solid rgba(255,255,255,.07);
    }
    .ttl{font-weight:950; letter-spacing:-.02em}
    .sub{font-size:12px; color:var(--muted)}

    .trades{
      height: 600px;
      overflow:auto;
    }

    .tradeHead, .tradeRow{
      display:grid;
      grid-template-columns: 90px 70px 90px 1fr 110px 1fr 34px;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,06);
      font-size:13px;
    }
    .tradeHead{
      position:sticky; top:0; z-index:5;
      background: rgba(12,12,20,92);
      backdrop-filter: blur(12px);
      font-size:12px;
      color: rgba(255,255,255,72);
      font-weight:900;
    }
    .tradeRow:hover{background: rgba(255,255,255,05)}
    .typeBadge{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px;
      border-radius:999px;
      font-weight:950;
      font-size:12px;
      letter-spacing:-.01em;
      border:1px solid rgba(255,255,255,10);
      width:fit-content;
    }
    .typeBadge.buy{background: rgba(20,241,149,10); border-color: rgba(20,241,149,30); color: rgba(20,241,149,95)}
    .typeBadge.sell{background: rgba(255,77,109,10); border-color: rgba(255,77,109,28); color: rgba(255,77,109,95)}

    .mono{font-variant-numeric: tabular-nums; font-feature-settings:"tnum" 1; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    .maker{display:flex; align-items:center; gap:8px; min-width:0}
    .addr{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 140px}
    .new{
      font-size:10px;
      font-weight:950;
      letter-spacing:.12em;
      padding:4px 7px;
      border-radius:999px;
      background: rgba(255,215,0,.15);
      border: 1px solid rgba(255,215,0,.25);
      color: rgba(255,215,0,.95);
    }

    .iconBtn{
      width:34px; height:34px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      display:inline-flex; align-items:center; justify-content:center;
      cursor:pointer;
      transition: transform var(--t), background var(--t), border-color var(--t);
    }
    .iconBtn:active{transform: translateY(1px)}
    .iconBtn:hover{background: rgba(255,255,255,.08)}

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(env(safe-area-inset-bottom) + 16px);
      transform: translateX(-50%);
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,10,22,.88);
      backdrop-filter: blur(12px);
      box-shadow: 0 16px 50px rgba(0,0,0,.65);
      font-weight: 900;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease, transform .2s ease;
      z-index: 2000;
    }
    .toast.show{opacity: 1; transform: translateX(-50%) translateY(-2px);}

    /* Mobile chart/trades tabs (legacy) */
    .mobileTabs{display:none;}
    @media (max-width: 740px){
      .mobileTabs{display:block; padding: 12px 12px 0;}
      .tabBar{
        display:flex; gap:8px;
        padding: 6px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,.10);
        background: rgba(0,0,0,.12);
      }
      .tab{
        flex: 1 1 0;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,.10);
        background: rgba(255,255,255,.04);
        color: rgba(255,255,255,.86);
        font-weight: 950;
        font-size: 12px;
        cursor:pointer;
      }
      .tab.active{
        background: rgba(0,209,255,.14);
        border-color: rgba(0,209,255,.42);
      }

      /* Make trades card full width on small screens */
      .tradeHead, .tradeRow{
        grid-template-columns: 70px 64px 84px 1fr 0 0 34px;
      }
      .hideM{display:none !important}
    }

    /* Split panel root injected by JS */
    .splitRoot{
      display:flex;
      flex-direction:column;
      min-height: 720px;
      height: 74vh;
      --split-bottom: 300px;
    }
    @media (max-width: 980px){
      .splitRoot{height: 78vh;}
    }
    .splitChart{
      display:flex;
      flex-direction:column;
      min-height: 260px;
      flex: 1 1 auto;
    }
    .splitHandle{
      height: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor: ns-resize;
      user-select:none;
      background: rgba(0,0,0,.10);
      border-top:1px solid rgba(255,255,255,.06);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .splitHandle::before{
      content:"";
      width: 44px;
      height: 4px;
      border-radius: 999px;
      background: rgba(255,255,255,.18);
      display:block;
    }
    .splitPanel{
      display:flex;
      flex-direction:column;
      height: var(--split-bottom);
      min-height: 160px;
      max-height: calc(100% - 240px);
      border-top:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.12);
    }
    .splitTabs{
      display:flex;
      gap:8px;
      padding: 12px 12px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .splitTab{
      flex:1 1 0;
      padding: 10px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.86);
      font-weight: 950;
      font-size: 12px;
      cursor:pointer;
      transition: background var(--t), border-color var(--t), transform var(--t);
    }
    .splitTab.active{
      background: rgba(0,209,255,.14);
      border-color: rgba(0,209,255,.42);
    }
    .splitTab:active{ transform: translateY(1px); }
    .splitBody{flex:1; overflow:auto; -webkit-overflow-scrolling:touch;}
    .tradeRow.enter{animation:tradeEnter .26s ease-out both;}
    @keyframes tradeEnter{from{opacity:0; transform:translateY(-10px);}to{opacity:1; transform:translateY(0);}}
/* Hide legacy mobile chart/trades tabs (split panel replaces them) */
.mobileTabs{display:none !important;}
#mobileTradesWrap{display:none !important;}



/* ================================
   DexGuard UI/UX Premium Patch (Design-only)
   ================================ */

/* Design tokens */
:root{
  --s-1:8px;
  --s-2:12px;
  --s-3:16px;
  --s-4:20px;
  --s-5:24px;
  --r-1:14px;
  --r-2:18px;
  --r-3:22px;
  --e-1: 0 10px 28px rgba(0,0,0,.36);
  --e-2: 0 18px 54px rgba(0,0,0,.55);
  --glassSm: blur(10px);
  --glassNone: blur(0px);
  --hit:44px;
}

/* Global polish + accessibility */
.btn, .pill, .chainBtn, .tf, .iconBtn, .tab{
  min-height: var(--hit);
}
.btn, .pill, .chainBtn, .tf, .sel{
  -webkit-tap-highlight-color: transparent;
}
.btn:focus-visible, .pill:focus-visible, .chainBtn:focus-visible, .tf:focus-visible, .dexInput:focus-visible, .iconBtn:focus-visible{
  outline: 2px solid rgba(0,209,255,.55);
  outline-offset: 2px;
}
.panel{
  /* Avoid expensive blur on large surfaces */
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  box-shadow: var(--e-2);
}
.topBar{
  /* Keep glass subtle (no heavy blur on wide area) */
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
}

/* Make typography feel more terminal-grade */
.pairName{
  font-size: 15px;
  line-height: 1.25;
}
.pairMeta{
  line-height: 1.35;
}

/* Search dropdown: no full-page dim/blur; keep dropdown crisp */
.searchScrim{
  display:none !important;
  background: transparent !important;
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
}
.dexSearch.open .searchScrim{ display:none !important; }
.results{
  left: 0 !important;
  right: 0 !important;
  width: min(560px, calc(100vw - 28px)) !important;
  transform: translateZ(0);
}
.resItem{
  min-height: 56px;
  padding: 12px 12px;
}
.resR .btn, .resR .iconBtn{
  min-height: 40px;
  height: 40px;
}

/* Token header + controls: tighter + consistent */
.cardHd{ padding: 14px 14px; }
.controls{
  padding: 10px 12px;
}
.tf{
  min-height: 40px;
  padding: 10px 12px;
  font-size: 12px;
}
.sel{ min-height: 40px; }

/* Table rows: smoother hover/tap */
.tradeRow{ transition: background var(--t); }
.tradeRow:active{ background: rgba(255,255,255,.07); }

/* ===== Mobile-first: compact sticky top bar + proper hierarchy ===== */
@media (max-width: 740px){
  .wrap{
    padding: calc(var(--topbar-space, 84px) + 10px) 10px 110px; /* reserve space for bottom sheet */
  }

  .topbar{
    position: fixed;
    top: calc(env(safe-area-inset-top) + 8px);
    left: 50%;
    transform: translateX(-50%);
    width: min(var(--max), calc(100vw - 20px));
    z-index: 1000;
    padding: 10px 10px;
    border-radius: var(--r-2);
    backdrop-filter: var(--glassSm);
    -webkit-backdrop-filter: var(--glassSm);
  }
  .brand{ gap: 10px; }
  #topDexguardBtn{
    min-height: var(--hit);
    padding: 8px 14px;
  }
  .actions{
    gap: 8px;
    flex-wrap: nowrap;
    justify-content: flex-end;
    width: auto;
  }
  #btnBack{
    min-height: var(--hit);
    padding: 10px 12px;
    font-size: 12px;
    white-space: nowrap;
  }
  #btnX{
    width: var(--hit);
    height: var(--hit);
    padding: 0;
    justify-content: center;
  }
  #btnX span{ display:none; }

  /* TOP BAR (trending + search) becomes stacked */
  .topRow{
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }
  .hotBlock{
    flex: 0 0 auto;
    width: 100%;
  }
  .chainToggle{
    width: 100%;
    justify-content: space-between;
  }
  .chainBtn{
    flex: 1 1 0;
    min-width: 0;
  }
  .bottomRow{
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }
  .dexSearch{
    width: 100%;
    max-width: 100%;
  }
  .dexSearchInner{
    border-radius: var(--r-2);
  }
  #btnGo{
    min-height: var(--hit);
    padding: 10px 14px;
  }

  /* ===== Live Trades bottom sheet ===== */
  #tradesCard{
    --sheetPeek: 58px;
    --sheetH: clamp(240px, 42vh, 420px);
    position: fixed !important;
    left: 10px;
    right: 10px;
    bottom: calc(env(safe-area-inset-bottom) + 10px);
    margin: 0 !important;
    height: var(--sheetH);
    max-height: 45vh;
    max-width: none !important;
    z-index: 95;
    box-shadow: var(--e-2);
    transform: translateY(calc(100% - var(--sheetPeek)));
    transition: transform .20s cubic-bezier(.2,.9,.2,1);
    will-change: transform;
    background: rgba(10,12,22,.72);
    backdrop-filter: var(--glassSm);
    -webkit-backdrop-filter: var(--glassSm);
    border-radius: 20px;
    overflow: hidden;
  }
  #tradesCard.open{
    transform: translateY(0);
  }
  #tradesCard .tableHd{
    padding: 10px 12px;
    border-bottom: 1px solid rgba(255,255,255,.08);
    background: rgba(10,12,22,.74);
    backdrop-filter: var(--glassSm);
    -webkit-backdrop-filter: var(--glassSm);
    cursor: pointer;
    user-select: none;
  }
  #tradesCard .tableHd::before{
    content:"";
    display:block;
    width: 46px;
    height: 4px;
    border-radius: 999px;
    background: rgba(255,255,255,.18);
    margin: 2px auto 8px;
  }
  #tradesCard .tableHd .ttl{
    font-size: 14px;
    letter-spacing: -.01em;
  }
  #tradesCard .tableHd .sub{
    font-size: 12px;
  }
  #tradesCard .tableHd{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
  }
  #tradesCard .tableHd .sheetRight{
    display:flex;
    align-items:center;
    gap: 8px;
  }
  #tradesCard:not(.open) .trades{
    display:none;
  }
  #tradesCard.open .trades{
    height: calc(var(--sheetH) - 78px);
    max-height: calc(45vh - 78px);
    overflow:auto;
    -webkit-overflow-scrolling: touch;
  }
  #tradesCard .sheetToggleBtn{
    width: 40px;
    height: 40px;
  }
  #tradesCard.open .sheetToggleBtn{
    transform: rotate(180deg);
  }


  /* Trades columns: reduce clutter on mobile */
  .tradeHead, .tradeRow{
    grid-template-columns: 64px 64px 84px 1fr 0 0 34px !important;
  }
  .maker .new{ display:none !important; }
}

/* Hide legacy mobile tabs wrapper entirely */
  .mobileTabs{ display:none !important; }
  #mobileTradesWrap{ display:none !important; }

  /* ===== Live Trades bottom sheet ===== */
  #tradesCard{
    --sheetPeek: 58px;
    --sheetH: clamp(240px, 42vh, 420px);
    position: fixed !important;
    left: 10px;
    right: 10px;
    bottom: calc(env(safe-area-inset-bottom) + 10px);
    margin: 0 !important;
    height: var(--sheetH);
    max-height: 45vh;
    max-width: none !important;
    z-index: 95;
    box-shadow: var(--e-2);
    transform: translateY(calc(100% - var(--sheetPeek)));
    transition: transform .20s cubic-bezier(.2,9,2,1);
    will-change: transform;
    background: rgba(10,12,22,72);
    backdrop-filter: var(--glassSm);
    -webkit-backdrop-filter: var(--glassSm);
    border-radius: 20px;
    overflow: hidden;
  }
  #tradesCard.open{
    transform: translateY(0);
  }
  #tradesCard .tableHd{
    padding: 10px 12px;
    border-bottom: 1px solid rgba(255,255,255,08);
    background: rgba(10,12,22,74);
    backdrop-filter: var(--glassSm);
    -webkit-backdrop-filter: var(--glassSm);
    cursor: pointer;
    user-select: none;
  }
  #tradesCard .tableHd::before{
    content:"";
    display:block;
    width: 46px;
    height: 4px;
    border-radius: 999px;
    background: rgba(255,255,255,18);
    margin: 2px auto 8px;
  }
  #tradesCard .tableHd .ttl{
    font-size: 14px;
    letter-spacing: -.01em;
  }
  #tradesCard .tableHd .sub{
    font-size: 12px;
  }
  #tradesCard .tableHd{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
  }
  #tradesCard .tableHd .sheetRight{
    display:flex;
    align-items:center;
    gap: 8px;
  }
  #tradesCard:not(.open) .trades{
    display:none;
  }
  #tradesCard.open .trades{
    height: calc(var(--sheetH) - 78px);
    max-height: calc(45vh - 78px);
    overflow:auto;
    -webkit-overflow-scrolling: touch;
  }
  #tradesCard .sheetToggleBtn{
    width: 40px;
    height: 40px;
  }
  #tradesCard.open .sheetToggleBtn{
    transform: rotate(180deg);
  }


  /* Trades columns: reduce clutter on mobile */
  .tradeHead, .tradeRow{
    grid-template-columns: 64px 64px 84px 1fr 0 0 34px !important;
  }
  .maker .new{ display:none !important; }



/* ================================
   TOP HEADER BAR FLOW PATCH (normal flow, not fixed/sticky)
   ================================ */
.wrap{
  padding: 18px 16px 28px !important;
}
@media (max-width: 640px){
  .wrap{ padding: 12px 10px 18px !important; }
}
.topbar{
  position: static !important;
  top: auto !important;
  left: auto !important;
  right: auto !important;
  transform: none !important;
  width: 100% !important;
  z-index: auto !important;
  margin: 12px 0 14px !important;
}
@media (max-width: 980px){
  .topbar{
    position: static !important;
    top: auto !important;
    left: auto !important;
    transform: none !important;
    width: 100% !important;
  }
}
@media (max-width: 740px){
  .topbar{
    position: static !important;
    top: auto !important;
    left: auto !important;
    transform: none !important;
    width: 100% !important;
  }
}
@media (max-width: 640px){
  .topbar{
    position: static !important;
    top: auto !important;
    left: auto !important;
    transform: none !important;
    width: 100% !important;
    margin: 10px 0 12px !important;
  }
}


/* ================================
   MOBILE NATIVE TRADING APP UI (CSS-ONLY, <=820px)
   Desktop/tablet unchanged.
   ================================ */
@media (max-width: 820px){
  :root{
    --m-bg:#060812;
    --m-panel:#0B0F1C;
    --m-panel2:#0E1426;
    --m-stroke: rgba(255,255,255,.10);
    --m-stroke2: rgba(255,255,255,.14);
    --m-text: rgba(255,255,255,.92);
    --m-muted: rgba(255,255,255,.68);
    --m-muted2: rgba(255,255,255,.52);
    --m-radius: 18px;
    --m-radius2: 22px;
    --m-shadow: 0 16px 44px rgba(0,0,0,.55);
    --m-gap: 8px;
    --m-gap2: 12px;
    --m-hit: 44px;
    --m-topbar-h: 108px; /* approx, used for padding */
  }

  /* Reduce background "glass"/blur + improve readability */
  body{
    background: var(--m-bg) !important;
  }
  body::before{
    background: var(--m-bg) !important;
  }

  /* Global spacing grid + avoid random floating blocks */
  .wrap{
    padding:
      calc(env(safe-area-inset-top) + 14px + 96px) /* space for fixed header */
      12px
      calc(env(safe-area-inset-bottom) + 18px + 76px) !important; /* room for bottom sheet peek */
  }

  /* Cards/panels: solid, subtle borders, minimal effects */
  .panel{
    background: transparent !important;
    border: 0 !important;
    box-shadow: none !important;
  }
  .card{
    background: var(--m-panel) !important;
    border: 1px solid var(--m-stroke) !important;
    border-radius: var(--m-radius2) !important;
    box-shadow: none !important;
  }

  /* ===== Sticky compact header (native-app style) ===== */
  .topbar{
    position: fixed !important;
    top: env(safe-area-inset-top) !important;
    left: 0 !important;
    right: 0 !important;
    transform: none !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 10px 12px 12px !important;
    border: 0 !important;
    border-bottom: 1px solid rgba(255,255,255,.08) !important;
    border-radius: 0 0 18px 18px !important;
    background: linear-gradient(180deg, rgba(12,14,26,.98), rgba(10,12,22,.92)) !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    box-shadow: 0 10px 28px rgba(0,0,0,.48) !important;
    z-index: 2000 !important;
  }
  .topbar .brand{
    display:flex !important;
    align-items:center !important;
    gap: 10px !important;
    min-width: 0 !important;
  }
  .topLogo{
    width: 28px !important;
    height: 28px !important;
    border-radius: 10px !important;
    object-fit: cover !important;
  }
  /* Add DexGuard text without changing HTML */
  .topbar .brand::after{
    content: "DexGuard";
    font-weight: 950;
    letter-spacing: -.02em;
    font-size: 16px;
    color: var(--m-text);
    white-space: nowrap;
  }

  /* Header actions: icon buttons + compact buy */
  .topbar .actions{
    display:flex !important;
    align-items:center !important;
    justify-content:flex-end !important;
    gap: 8px !important;
    flex-wrap: wrap !important;
  }
  #btnBack, #btnX{
    width: var(--m-hit) !important;
    height: var(--m-hit) !important;
    min-height: var(--m-hit) !important;
    padding: 0 !important;
    border-radius: 14px !important;
    display:inline-flex !important;
    align-items:center !important;
    justify-content:center !important;
    background: rgba(255,255,255,.06) !important;
    border: 1px solid rgba(255,255,255,.10) !important;
  }
  #btnBack{
    font-size: 0 !important; /* hide label but keep accessible */
    position: relative !important;
    overflow: hidden !important;
  }
  #btnBack::before{
    content:"";
    width: 18px;
    height: 18px;
    display:block;
    background: rgba(255,255,255,.92);
    -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23000' d='M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z'/%3E%3C/svg%3E") center/contain no-repeat;
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23000' d='M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z'/%3E%3C/svg%3E") center/contain no-repeat;
    opacity: .9;
  }
  #btnX span{ display:none !important; }
  #btnBuy{
    height: var(--m-hit) !important;
    min-height: var(--m-hit) !important;
    padding: 0 14px !important;
    border-radius: 14px !important;
    font-weight: 950 !important;
    letter-spacing: -.01em !important;
  }

  /* Chain selector (activeNet) â€” segmented pills on one line */
  #netPills{
    width: 100% !important;
    display:grid !important;
    grid-template-columns: repeat(4, 1fr) !important;
    gap: 8px !important;
    order: 10 !important;
    margin-top: 10px !important;
  }
  #netPills .pill{
    justify-content:center !important;
    min-height: var(--m-hit) !important;
    border-radius: 999px !important;
    background: rgba(255,255,255,.05) !important;
    border: 1px solid rgba(255,255,255,.10) !important;
    font-weight: 950 !important;
  }
  #netPills .pill.active{
    background: rgba(0,209,255,.16) !important;
    border-color: rgba(0,209,255,.42) !important;
    box-shadow: 0 0 0 1px rgba(0,209,255,.16) inset !important;
  }

  /* ===== Top trending/search panel: app sections ===== */
  #topBar{
    background: var(--m-panel) !important;
    border: 1px solid var(--m-stroke) !important;
    border-radius: var(--m-radius2) !important;
    box-shadow: none !important;
    overflow: hidden !important;
  }
  .topBarInner{
    padding: 12px !important;
    gap: 12px !important;
  }
  .topRow{
    display:flex !important;
    flex-direction: column !important;
    align-items: stretch !important;
    gap: 10px !important;
  }
  .hotBlock{
    padding: 10px 12px !important;
    border-radius: 16px !important;
    background: rgba(255,255,255,.04) !important;
    border: 1px solid rgba(255,255,255,.08) !important;
  }
  .hotLabel{
    font-size: 12px !important;
    letter-spacing: .08em !important;
    opacity: .9 !important;
  }

  /* Trending chain toggle: segmented control */
  #trendToggle{
    width: 100% !important;
    display:grid !important;
    grid-template-columns: repeat(4, 1fr) !important;
    gap: 8px !important;
    padding: 0 !important;
    background: transparent !important;
    border: 0 !important;
  }
  #trendToggle .chainBtn{
    min-height: var(--m-hit) !important;
    border-radius: 999px !important;
    background: rgba(255,255,255,.05) !important;
    border: 1px solid rgba(255,255,255,.10) !important;
    font-weight: 950 !important;
  }
  #trendToggle .chainBtn.active{
    background: rgba(153,69,255,.18) !important;
    border-color: rgba(153,69,255,.42) !important;
    box-shadow: 0 0 0 1px rgba(153,69,255,.18) inset !important;
  }

  /* Trending ticker: clean, thumb-friendly */
  .bottomRow{
    display:flex !important;
    flex-direction: column !important;
    gap: 12px !important;
  }
  .tickerWrap{
    border-radius: 16px !important;
    border: 1px solid rgba(255,255,255,.08) !important;
    background: rgba(255,255,255,.03) !important;
    overflow: hidden !important;
  }
  .tickerTrack{ padding: 8px 0 !important; }

  /* Primary search bar: full width, prominent */
  .dexSearch{
    width: 100% !important;
    max-width: none !important;
  }
  .dexSearchInner{
    border-radius: 18px !important;
    padding: 12px 12px !important;
    background: var(--m-panel2) !important;
    border: 1px solid var(--m-stroke2) !important;
    box-shadow: none !important;
    gap: 10px !important;
  }
  .dexInput{
    font-size: 15px !important;
    font-weight: 900 !important;
  }
  #btnGo{
    height: var(--m-hit) !important;
    min-height: var(--m-hit) !important;
    padding: 0 14px !important;
    border-radius: 14px !important;
    font-weight: 950 !important;
  }
  #modeHint{
    height: 28px !important;
    padding: 0 10px !important;
    border-radius: 999px !important;
    background: rgba(255,255,255,.06) !important;
    border: 1px solid rgba(255,255,255,.10) !important;
    font-size: 12px !important;
  }

  /* Search dropdown: app list */
  .results{
    left: 0 !important;
    right: 0 !important;
    width: 100% !important;
    top: calc(100% + 10px) !important;
    padding: 8px !important;
    border-radius: 18px !important;
    background: rgba(10,12,22,.98) !important;
    border: 1px solid rgba(255,255,255,.14) !important;
    box-shadow: 0 20px 60px rgba(0,0,0,.72) !important;
  }
  .resItem{
    border-radius: 14px !important;
    border: 1px solid rgba(255,255,255,.08) !important;
    background: rgba(255,255,255,.03) !important;
    padding: 12px !important;
    min-height: 64px !important;
    gap: 10px !important;
  }
  .resItem:active{
    background: rgba(255,255,255,.06) !important;
  }
  .resL{ gap: 10px !important; min-width:0 !important; }
  .resLogo{
    width: 44px !important;
    height: 44px !important;
    border-radius: 14px !important;
    border: 1px solid rgba(255,255,255,.10) !important;
    background: rgba(255,255,255,.04) !important;
  }
  .resName{ font-size: 14px !important; font-weight: 950 !important; }
  .resMeta{ font-size: 12px !important; color: var(--m-muted) !important; }

  /* ===== Token/Pair header block: hierarchy + stat grid ===== */
  #chartCard .cardHd{
    flex-direction: column !important;
    align-items: stretch !important;
    gap: 12px !important;
  }
  #chartCard .pair{
    gap: 12px !important;
  }
  #chartCard .tlogo{
    width: 44px !important;
    height: 44px !important;
    border-radius: 16px !important;
  }
  #chartCard .pairName{
    font-size: 18px !important;
    font-weight: 1000 !important;
    letter-spacing: -.03em !important;
  }
  #chartCard .pairMeta{
    font-size: 13px !important;
    color: var(--m-muted) !important;
  }
  #stats{
    display:grid !important;
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 8px !important;
    justify-content: stretch !important;
  }
  .statPill{
    width: 100% !important;
    justify-content: space-between !important;
    padding: 10px 12px !important;
    border-radius: 14px !important;
    background: rgba(255,255,255,.04) !important;
    border: 1px solid rgba(255,255,255,.10) !important;
  }

  /* ===== Chart hero area ===== */
  #chartWrap{
    height: clamp(360px, 48vh, 520px) !important;
    border-top: 1px solid rgba(255,255,255,.08) !important;
  }

  /* Timeframe pills: compact + scroll */
  .controls{
    padding: 12px !important;
    gap: 10px !important;
    background: rgba(255,255,255,.02) !important;
  }
  .tfRow{
    flex-wrap: nowrap !important;
    overflow:auto !important;
    -webkit-overflow-scrolling: touch !important;
    scrollbar-width: none;
  }
  .tfRow::-webkit-scrollbar{ display:none; }
  .tf{
    min-height: 36px !important;
    padding: 8px 12px !important;
    border-radius: 999px !important;
    background: rgba(255,255,255,.04) !important;
    border: 1px solid rgba(255,255,255,.10) !important;
    font-size: 12px !important;
    font-weight: 950 !important;
  }
  .tf.active{
    background: rgba(0,209,255,.16) !important;
    border-color: rgba(0,209,255,.42) !important;
  }
  .rightCtl{
    width: 100% !important;
    justify-content: space-between !important;
  }
  .sel{
    width: 100% !important;
    min-height: 44px !important;
    border-radius: 14px !important;
    background: rgba(255,255,255,.04) !important;
    border: 1px solid rgba(255,255,255,.10) !important;
  }

  /* Section switcher: style split panel tabs as segmented control */
  .splitTabs{
    position: sticky !important;
    top: calc(env(safe-area-inset-top) + 92px) !important; /* below header */
    z-index: 5 !important;
    background: rgba(11,15,28,.96) !important;
    border-bottom: 1px solid rgba(255,255,255,.08) !important;
    padding: 10px 12px !important;
  }
  .splitTabs{
    display:grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 8px !important;
  }
  .splitTab{
    min-height: 44px !important;
    border-radius: 999px !important;
    border: 1px solid rgba(255,255,255,.10) !important;
    background: rgba(255,255,255,.04) !important;
    font-weight: 950 !important;
  }
  .splitTab.active{
    background: rgba(153,69,255,.18) !important;
    border-color: rgba(153,69,255,.45) !important;
  }

  /* ===== Live Trades: collapsible bottom sheet (CSS-driven via .open class) ===== */
  #tradesCard{
    --sheetPeek: 64px;
    --sheetH: clamp(260px, 44vh, 460px);
    position: fixed !important;
    left: 12px !important;
    right: 12px !important;
    bottom: calc(env(safe-area-inset-bottom) + 12px) !important;
    margin: 0 !important;
    max-width: none !important;
    height: var(--sheetH) !important;
    z-index: 2500 !important;
    border-radius: 22px !important;
    overflow: hidden !important;
    background: rgba(11,15,28,.98) !important;
    border: 1px solid rgba(255,255,255,.12) !important;
    box-shadow: var(--m-shadow) !important;
    transform: translateY(calc(100% - var(--sheetPeek))) !important;
    transition: transform .22s cubic-bezier(.2,.9,.2,1) !important;
    will-change: transform;
  }
  #tradesCard.open{
    transform: translateY(0) !important;
  }
  #tradesCard .tableHd{
    cursor: pointer;
    user-select:none;
    padding: 10px 12px 12px !important;
    border-bottom: 1px solid rgba(255,255,255,.10) !important;
    background: rgba(11,15,28,.98) !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
  }
  #tradesCard .tableHd::before{
    content:"";
    display:block;
    width: 46px;
    height: 4px;
    border-radius: 999px;
    background: rgba(255,255,255,.18);
    margin: 2px auto 10px;
  }
  #tradesCard .ttl{ font-size: 14px !important; font-weight: 1000 !important; }
  #tradesCard .sub{ font-size: 12px !important; color: var(--m-muted) !important; }

  #tradesCard:not(.open) .trades{ display:none !important; }
  #tradesCard.open .trades{
    height: calc(var(--sheetH) - 84px) !important;
    overflow:auto !important;
    -webkit-overflow-scrolling: touch !important;
  }

  /* Trades rows: readable + aligned + lighter columns on mobile */
  .tradeHead, .tradeRow{
    grid-template-columns: 58px 64px 90px 1fr 0 0 34px !important;
    gap: 10px !important;
    padding: 10px 12px !important;
    font-size: 13px !important;
    border-bottom: 1px solid rgba(255,255,255,.08) !important;
  }
  .tradeHead{
    background: rgba(11,15,28,.98) !important;
    position: sticky !important;
    top: 0 !important;
    z-index: 2 !important;
  }
  .typeBadge{
    min-height: 28px !important;
    padding: 6px 10px !important;
    border-radius: 999px !important;
  }

  /* Active/tap states */
  .btn:active, .pill:active, .chainBtn:active, .tf:active, .splitTab:active, .iconBtn:active{
    transform: translateY(1px);
  }
}

</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <img class="topLogo" id="topLogo" src="dexguard.png" alt="DexGuard" loading="eager" decoding="async" />
      </div>

      <div class="actions">
        <div class="pillRow" id="netPills"></div>
        <a class="btn ghost" id="btnBack" href="/">Back to Main</a>
        <a class="btn xbtn" id="btnX" href="https://www.x.com/solana_x1" target="_blank" rel="noreferrer" aria-label="Twitter/X">
          <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" focusable="false" style="display:block">
            <path fill="currentColor" d="M18.9 2H22l-6.8 7.8L23 22h-6.2l-4.8-7.1L5.8 22H2l7.4-8.5L1 2h6.3l4.3 6.4L18.9 2Zm-1.1 18h1.7L6.2 3.9H4.4L17.8 20Z"/>
          </svg>
          <span>Twitter/X</span>
        </a>
        <a class="btn primary" id="btnBuy" href="#" target="_blank" rel="noreferrer">Buy</a>
      </div>
    </div>
    <div class="panel">
      <!-- TOP TRENDING BAR + SEARCH (MATCH MAIN PAGE) -->
      <div class="topBar" id="topBar">
        <div class="topBarInner">
          <div class="topRow">
            <div class="hotBlock" aria-label="Hot trending live">
              <div class="hotLabel" title="Live trending"><span class="hotFire">ðŸ”¥</span><span>LIVE TRENDING</span></div>
              <div id="status" style="display:none">Bootingâ€¦</div>
              <div id="clock" style="display:none"></div>
            </div>

            <div class="chainToggle" id="trendToggle" aria-label="Trending chain">
              <button class="chainBtn active" data-net="solana" type="button">SOL</button>
              <button class="chainBtn" data-net="eth" type="button">ETH</button>
              <button class="chainBtn" data-net="bsc" type="button">BNB</button>
              <button class="chainBtn" data-net="base" type="button">BASE</button>
            </div>
          </div>

          <div class="bottomRow">
            <div class="tickerWrap" aria-label="Trending tokens">
              <div class="tickerTrack" id="tickerTrack">
                <span class="tickerItem" style="opacity:.75"><span class="rank"><span class="logoBox" style="--netColor:#fff"><span class="fallback">â€¢</span></span></span><span class="sym">Trending</span></span>
                <span class="tickerItem" style="opacity:.75"><span class="rank"><span class="logoBox" style="--netColor:#fff"><span class="fallback">â€¢</span></span></span><span class="sym">Trending</span></span>
                <span class="tickerItem" style="opacity:.75"><span class="rank"><span class="logoBox" style="--netColor:#fff"><span class="fallback">â€¢</span></span></span><span class="sym">Trending</span></span>
                <span class="tickerItem" style="opacity:.75"><span class="rank"><span class="logoBox" style="--netColor:#fff"><span class="fallback">â€¢</span></span></span><span class="sym">Trending</span></span>
              </div>
            </div>

            <div class="dexSearch" role="search" aria-label="Search token by name or contract">
              <div class="dexSearchInner">
                <input class="dexInput" id="q" placeholder="Search token / paste contractâ€¦" autocomplete="off" spellcheck="false" />
                <div class="hint" id="modeHint">auto</div>
                <button class="btn" id="btnGo" type="button">Open</button>
              </div>

              <div class="results" id="results"></div>
              <div class="searchScrim" id="searchScrim" aria-hidden="true"></div>
            </div>
          </div>

          <div class="mobileTabs">
            <div class="tabBar">
              <button class="tab active" id="tabChart" type="button">Chart</button>
              <button class="tab" id="tabTrades" type="button">Trades</button>
            </div>
          </div>
        </div>

        <div class="card desktopOnly" id="tradesCard">
          <div class="tableHd" role="button" aria-label="Toggle Live Trades" aria-expanded="false">
            <div>
              <div class="ttl">Live Trades</div>
              <div class="sub" id="tradesSub">Buys / Sells (live)</div>
            </div>
            <div class="sheetRight">
              <div class="sub" id="tradesStat">â€”</div>
            </div>
          </div>

          <div class="trades" id="trades">
            <div class="tradeHead">
              <div class="col age">Age</div>
              <div class="col type">Type</div>
              <div class="col usd">USD</div>
              <div class="col amt">Amount</div>
              <div class="col price hideM">Price</div>
              <div class="col maker hideM">Maker</div>
              <div class="col links"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid">
        <div class="card" id="chartCard">
          <div class="cardHd">
            <div class="pair">
              <div class="tlogo" id="tokenLogo"><span class="fb" id="tokenLogoFb">$</span></div>
              <div class="pairTxt">
                <div class="pairName" id="pairName">â€”</div>
                <div class="pairMeta" id="pairMeta">Paste a token / choose a trending token</div>
              </div>
            </div>
            <div class="stats" id="stats"></div>
          </div>

          <div id="chartWrap"><div id="chart"></div></div>

          <div class="controls">
            <div class="tfRow" id="tfRow"></div>
            <div class="rightCtl">
              <select class="sel" id="poolSel" title="Pool"></select>
            </div>
          </div>
        </div>

        <div class="card desktopOnly" id="mobileTradesWrap">
          <!-- legacy wrapper kept for JS compatibility -->
        </div>
      </div>

    </div>

    <div class="toast" id="toast"></div>
  </div>

  <script src="https://unpkg.com/lightweight-charts@4.2.1/dist/lightweight-charts.standalone.production.js"></script>
  <script>
  (function(){
    // =========================================================
    //  $SOS DEX Terminal â€” from scratch
    //  Data sources:
    //   - Token discovery: DexScreener public API (search + token pairs)
    //   - OHLCV + trades: GeckoTerminal API (pools)
    //  No embeds. No third-party iframes.
    // =========================================================

    // -------------------- Constants
    const GECKO = 'https://api.geckoterminal.com/api/v2';
    const DS = 'https://api.dexscreener.com/latest/dex';

    const NET_LABEL = { solana:'SOL', eth:'ETH', bsc:'BNB', base:'BASE' };
    const NET_DS = { solana:'solana', eth:'ethereum', bsc:'bsc', base:'base' };
    const NET_GECKO = { solana:'solana', eth:'eth', bsc:'bsc', base:'base' };

    const DEFAULT_TOKEN = {
      solana: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', // USDC
      eth:    '0xA0b86991c6218b36c1d19d4a2e9eb0ce3606eb48',  // USDC
      bsc:    '0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d',  // USDC
      base:   '0x833589fCD6eDb6E08f4c7C32D4f71b54bda02913'   // USDC
    };

    const DEFAULT_MARKET_TOKEN = {
      solana: 'So11111111111111111111111111111111111111112', // wSOL
      eth:    '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2',   // WETH
      bsc:    '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c',   // WBNB
      base:   '0x4200000000000000000000000000000000000006'    // WETH on Base
    };

    const TF = [
      {k:'1m',  agg:60},
      {k:'5m',  agg:300},
      {k:'15m', agg:900},
      {k:'1h',  agg:3600},
      {k:'4h',  agg:14400},
      {k:'1d',  agg:86400},
      {k:'1w',  agg:604800},
      {k:'ALL', agg:0}
    ];

    // -------------------- DOM helpers
    const $ = (id)=>document.getElementById(id);
    const esc = (s)=>String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
    const num = (v)=>{ const n=Number(v); return Number.isFinite(n)?n:NaN; };

    const netPills = $('netPills');
    const q = $('q');
    const results = $('results');
    const searchScrim = $('searchScrim');
    const btnGo = $('btnGo');
    const modeHint = $('modeHint');

    const pairName = $('pairName');
    const pairMeta = $('pairMeta');
    const tokenLogo = $('tokenLogo');
    const tokenLogoFb = $('tokenLogoFb');
    const stats = $('stats');
    const poolSel = $('poolSel');

    const tradesCard = $('tradesCard');
    const tradesSub = $('tradesSub');
    const tradesStat = $('tradesStat');
    const tradesDesk = $('trades');

    const chartCard = $('chartCard');
    const mobileTradesWrap = $('mobileTradesWrap');

    const tfRow = $('tfRow');

    const tabChart = $('tabChart');
    const tabTrades = $('tabTrades');

    const btnBack = $('btnBack');
    const btnX = $('btnX');
    const btnBuy = $('btnBuy');

    // -------------------- Utils
    function toast(msg){
      const t = $('toast');
      if(!t) return;
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>t.classList.remove('show'), 1600);
    }

    function shortAddr(a){
      a = String(a||'');
      if(a.length<=12) return a;
      return a.slice(0,6)+'â€¦'+a.slice(-4);
    }

    function formatCompact(n){
      n = Number(n);
      if(!Number.isFinite(n)) return 'â€”';
      const abs = Math.abs(n);
      if(abs>=1e12) return (n/1e12).toFixed(2)+'T';
      if(abs>=1e9)  return (n/1e9).toFixed(2)+'B';
      if(abs>=1e6)  return (n/1e6).toFixed(2)+'M';
      if(abs>=1e3)  return (n/1e3).toFixed(2)+'K';
      if(abs>=1)    return n.toFixed(2);
      return n.toPrecision(3);
    }

    function formatPrice(n){
      n=Number(n);
      if(!Number.isFinite(n)) return 'â€”';
      if(n>=1000) return n.toFixed(2);
      if(n>=1) return n.toFixed(4);
      if(n>=0.01) return n.toFixed(6);
      return n.toPrecision(4);
    }

    function normalizeChain(net){
      net = String(net||'').toLowerCase();
      if(net==='bnb' || net==='bsc') return 'bsc';
      if(net==='ethereum') return 'eth';
      if(net==='sol') return 'solana';
      if(net==='base') return 'base';
      if(net==='solana') return 'solana';
      if(net==='eth') return 'eth';
      return net || 'solana';
    }

    function geckoNet(){
      return NET_GECKO[normalizeChain(activeNet)] || 'solana';
    }

    function isEvmAddr(s){
      return /^0x[a-fA-F0-9]{40}$/.test(String(s||'').trim());
    }

    function isSolAddr(s){
      s = String(s||'').trim();
      return s.length>=32 && s.length<=50 && /^[1-9A-HJ-NP-Za-km-z]+$/.test(s);
    }

    function poolAddressFromPool(p){
      const a = p?.attributes || {};
      if(a.address) return String(a.address);
      const id = String(p?.id||'');
      const last = id.split('_').pop();
      const last2 = last.split(':').pop();
      const last3 = last2.split('/').pop();
      return last3;
    }

    function tokenIdToAddr(id){
      id = String(id||'').trim();
      if(!id) return '';
      if(id.includes('_')) return id.split('_').pop();
      if(id.includes(':')) return id.split(':').pop();
      if(id.includes('/')) return id.split('/').pop();
      return id;
    }

    function tokenAddrFromPool(p, which){
      const a = p?.attributes || {};
      let v = a[`${which}_token_address`] || a[`${which}_token_id`] || '';
      if(!v){
        const rel = p?.relationships?.[`${which}_token`]?.data?.id || '';
        v = rel;
      }
      return tokenIdToAddr(v);
    }

    function tokenSymFromPool(p, which){
      const a = p?.attributes || {};
      const k = `${which}_token_symbol`;
      const sym = a[k] || a[`${which}_symbol`] || '';
      return String(sym||'').replace(/\s+/g,'').slice(0,12);
    }

    function tokenImgFromPool(p, which){
      const a = p?.attributes || {};
      const direct = a[`${which}_token_image_url`] || a[`${which}_token_logo`] || '';
      if(direct) return String(direct);
      const nested = a?.[`${which}_token`]?.data?.attributes?.image_url || a?.[`${which}_token`]?.data?.attributes?.imageUrl || '';
      return String(nested||'');
    }

    function tokenPriceFromPool(p, which){
      const a = p?.attributes || {};
      const v = (which==='base') ? (a.base_token_price_usd || a.token_price_usd || a.price_usd) : (a.quote_token_price_usd || a.quote_price_usd);
      const n = Number(v);
      return Number.isFinite(n) ? n : NaN;
    }

    function poolLiqUsd(p){
      const a = p?.attributes || {};
      const v = num(a.reserve_in_usd || a.liquidity_in_usd || a.liquidity_usd || a.reserveUsd);
      return Number.isFinite(v) ? v : 0;
    }

    function poolCreatedMs(p){
      const a = p?.attributes || {};
      const t = Date.parse(a.pool_created_at || a.created_at || a.createdAt || a.creation_time || '');
      return Number.isFinite(t) ? t : NaN;
    }

    function fmtAge(ms){
      if(!Number.isFinite(ms)) return 'â€”';
      const d = Math.max(0, Date.now()-ms);
      const s = Math.floor(d/1000);
      if(s<60) return s+'s';
      const m = Math.floor(s/60);
      if(m<60) return m+'m';
      const h = Math.floor(m/60);
      if(h<24) return h+'h';
      const days = Math.floor(h/24);
      return days+'d';
    }

    function explorerTx(net, sig){
      net = normalizeChain(net);
      if(net==='solana') return 'https://solscan.io/tx/'+sig;
      if(net==='eth') return 'https://etherscan.io/tx/'+sig;
      if(net==='bsc') return 'https://bscscan.com/tx/'+sig;
      if(net==='base') return 'https://basescan.org/tx/'+sig;
      return '#';
    }

    function explorerAddr(net, a){
      net = normalizeChain(net);
      if(net==='solana') return 'https://solscan.io/account/'+a;
      if(net==='eth') return 'https://etherscan.io/address/'+a;
      if(net==='bsc') return 'https://bscscan.com/address/'+a;
      if(net==='base') return 'https://basescan.org/address/'+a;
      return '#';
    }

    function buildBuyUrl(net, tokenAddr){
      net = normalizeChain(net);
      if(net==='solana') return 'https://jup.ag/swap/SOL-' + encodeURIComponent(tokenAddr);
      if(net==='eth') return 'https://app.uniswap.org/#/swap?outputCurrency=' + encodeURIComponent(tokenAddr);
      if(net==='bsc') return 'https://pancakeswap.finance/swap?outputCurrency=' + encodeURIComponent(tokenAddr);
      if(net==='base') return 'https://app.uniswap.org/#/swap?chain=base&outputCurrency=' + encodeURIComponent(tokenAddr);
      return '#';
    }

    // -------------------- State
    const qs = new URLSearchParams(location.search);
    let activeNet = normalizeChain(qs.get('chain') || 'solana');
    let addr = String(qs.get('addr')||'').trim();

    let activeTF = TF.find(x=>x.k==='15m') || TF[0];
    let poolChoices = [];
    let poolId = '';
    let poolAddr = '';
    let tokenSide = 'base';
    let curTokenSymbol = 'TOKEN';
    let curQuoteSymbol = '';
    let curTokenName = '';
    let curTokenImage = '';
    let curTokenAddr = '';
    let seenMakers = new Set();
    let tradesSeen = new Set();

    let pollTradesTimer = null;
    let pollMetaTimer = null;
    let pollCandleTimer = null;
    let trendingTimer = null;
    let ageTimer = null;

    // -------------------- Chart
    const chartEl = $('chart');
    const chart = LightweightCharts.createChart(chartEl, {
      width: chartEl.clientWidth || 800,
      height: chartEl.clientHeight || 520,
      layout: { background: { type:'solid', color:'rgba(0,0,0,0)' }, textColor:'rgba(255,255,255,86)' },
      grid: { vertLines:{color:'rgba(255,255,255,06)'}, horzLines:{color:'rgba(255,255,255,06)'} },
      rightPriceScale: { borderColor:'rgba(255,255,255,10)' },
      timeScale: { borderColor:'rgba(255,255,255,10)', rightOffset: 6, barSpacing: 8, fixLeftEdge: true },
      crosshair: { mode: 0 },
    });

    const candleSeries = chart.addCandlestickSeries({
      upColor: 'rgba(20,241,149,1)',
      downColor: 'rgba(255,77,109,1)',
      borderUpColor: 'rgba(20,241,149,1)',
      borderDownColor: 'rgba(255,77,109,1)',
      wickUpColor: 'rgba(20,241,149,1)',
      wickDownColor: 'rgba(255,77,109,1)'
    });

    const volumeSeries = chart.addHistogramSeries({
      priceFormat: { type:'volume' },
      priceScaleId: '',
      scaleMargins: { top: 0.8, bottom: 0 },
    });

    let rawCandles = [];

    function syncBarSpacing(){
      try{
        const ts = chart.timeScale();
        const w = chartEl.clientWidth || 600;
        const target = Math.max(5, Math.min(12, Math.round(w/110)));
        ts.applyOptions({ barSpacing: target });
      }catch(_){}
    }

    function applyDefaultViewport(){
      try{
        chart.timeScale().fitContent();
        syncBarSpacing();
      }catch(_){}
    }

    const ro = new ResizeObserver(()=>{
      chart.applyOptions({ width: chartEl.clientWidth, height: chartEl.clientHeight });
    });
    ro.observe(chartEl);

    /* Fit button removed (auto-fit handled) */

    // -------------------- UI boot
    function renderNetPills(){
      netPills.innerHTML='';
      const nets=[{k:'solana',label:'SOL'},{k:'eth',label:'ETH'},{k:'bsc',label:'BNB'},{k:'base',label:'BASE'}];
      nets.forEach(n=>{
        const b=document.createElement('div');
        b.className='pill'+(activeNet===n.k?' active':'');
        b.innerHTML = `<span class="dot"></span>${esc(n.label)}`;
        b.onclick=()=>{
          activeNet=n.k;
          renderNetPills();
          toast('Chain: '+n.label);
          if(!addr || (activeNet==='solana' ? !isSolAddr(addr) : !isEvmAddr(addr))){ addr = DEFAULT_MARKET_TOKEN[activeNet]; }
          navigate(activeNet, addr);
        };
        netPills.appendChild(b);
      });
    }

    function renderTimeframes(){
      tfRow.innerHTML='';
      TF.forEach(t=>{
        const b=document.createElement('button');
        b.className='tf'+(t.k===activeTF.k?' active':'');
        b.textContent=t.k;
        b.onclick=()=>{
          activeTF=t;
          [...tfRow.children].forEach(x=>x.classList.toggle('active', x.textContent===t.k));
          if(poolAddr){
            try{ if(typeof stopLiveLoops==='function') stopLiveLoops(); }catch(_){}
            loadCandles(true);
            startLiveLoops();
          }
        };
        tfRow.appendChild(b);
      });
    }

    // -------------------- Navigation
    function navigate(chain, token){
      const u = new URL(location.href);
      u.searchParams.set('chain', normalizeChain(chain));
      u.searchParams.set('addr', token);
      location.href = u.toString();
    }

    // -------------------- Fetch helpers
    async function fetchJson(url, {timeout=12000, retries=0}={}){
      for(let i=0;i<=retries;i++){
        const ac = new AbortController();
        const t = setTimeout(()=>ac.abort(), timeout);
        try{
          const r = await fetch(url, {signal: ac.signal, headers:{'accept':'application/json'}});
          clearTimeout(t);
          if(!r.ok) throw new Error('HTTP '+r.status);
          return await r.json();
        }catch(e){
          clearTimeout(t);
          if(i===retries) throw e;
          await new Promise(res=>setTimeout(res, 400 + i*300));
        }
      }
    }

    // -------------------- Search
    let searchTimer=null;
    let searchReq=0;

    function showResults(html){
      results.innerHTML = html;
      const open = !!html;
      results.style.display = open ? 'block' : 'none';
      if(searchScrim) searchScrim.style.display = open ? 'block' : 'none';
      const dexSearch = results.closest('.dexSearch');
      if(dexSearch) dexSearch.classList.toggle('open', open);
    }

    function hideResults(){
      results.style.display = 'none';
      if(searchScrim) searchScrim.style.display = 'none';
      const dexSearch = results.closest('.dexSearch');
      if(dexSearch) dexSearch.classList.remove('open');
    }

    if(searchScrim){
      searchScrim.addEventListener('click', hideResults);
    }

    async function dsSearch(query){
      const url = DS + '/search/?q=' + encodeURIComponent(query);
      const j = await fetchJson(url, {timeout:12000, retries:1});
      return Array.isArray(j?.pairs) ? j.pairs : [];
    }

    async function dsTokenPairsV1(net, tokenAddr){
      const chain = NET_DS[normalizeChain(net)] || 'solana';
      const url = `https://api.dexscreener.com/token-pairs/v1/${chain}/${encodeURIComponent(tokenAddr)}`;
      try{
        const j = await fetchJson(url, {timeout:14000, retries:1});
        return Array.isArray(j) ? j : [];
      }catch(_){
        return [];
      }
    }

    function bestPairAnyNet(pairs){
      const list = (pairs||[]).slice();
      if(!list.length) return null;
      list.sort((a,b)=>{
        const la = Number(a?.liquidity?.usd||0);
        const lb = Number(b?.liquidity?.usd||0);
        if(lb!==la) return lb-la;
        const va = Number(a?.volume?.h24||0);
        const vb = Number(b?.volume?.h24||0);
        return vb-va;
      });
      return list[0];
    }

    function renderSearchItem(p){
      const base = p?.baseToken || {};
      const quote = p?.quoteToken || {};
      const chain = normalizeChain(p?.chainId || p?.chain || activeNet);
      const addr = String(base?.address || p?.baseToken?.address || p?.baseTokenAddress || '').trim();
      const sym = (base?.symbol || '').toUpperCase();
      const name = base?.name || sym || 'Token';
      const liq = Number(p?.liquidity?.usd||0);
      const vol = Number(p?.volume?.h24||0);
      const chg = Number(p?.priceChange?.h24||0);
      const mcap = Number(p?.fdv||p?.marketCap||0);

      const logo = base?.logoURI || base?.logoUrl || base?.imageUrl || base?.image || p?.info?.imageUrl || '';
      const pctCls = chg>=0 ? 'up':'down';
      const pctTxt = (Number.isFinite(chg)? (chg>=0?'+':'')+chg.toFixed(2)+'%':'â€”');
      const liqTxt = '$'+formatCompact(liq);
      const mcTxt  = '$'+formatCompact(mcap);

      const secondary = `${NET_LABEL[chain]||chain.toUpperCase()} â€¢ ${addr?shortAddr(addr):'â€”'}`;

      const img = logo ? `<img src="${esc(logo)}" alt="" loading="lazy" decoding="async" />` : `<span class="fb">${esc((sym||name||'?').slice(0,1))}</span>`;

      return `
        <div class="resItem" data-addr="${esc(addr)}" data-chain="${esc(chain)}" role="button" tabindex="0">
          <div class="resL">
            <div class="resLogo">${img}</div>
            <div class="resTxt">
              <div class="resName">${esc(name)} ${sym?`<span style="opacity:.7">(${esc(sym)})</span>`:''}</div>
              <div class="resMeta">${esc(secondary)}</div>
            </div>
          </div>
          <div class="resR">
            <span class="stat ${pctCls}"><b>${esc(pctTxt)}</b></span>
            <span class="stat"><span style="opacity:.75">MCap</span> <b>${esc(mcTxt)}</b></span>
          </div>
        </div>
      `;
    }

    function bindSearchClicks(){
      [...results.querySelectorAll('.resItem')].forEach(el=>{
        const go = ()=>{
          const a = el.getAttribute('data-addr')||'';
          const c = el.getAttribute('data-chain')||activeNet;
          if(!a) return;
          hideResults();
          navigate(c, a);
        };
        el.addEventListener('click', go);
        el.addEventListener('keydown', (e)=>{ if(e.key==='Enter') go(); });
      });
    }

    async function doSearch(val){
      const query = String(val||'').trim();
      if(!query){
        showResults('');
        return;
      }

      const isAddr = (activeNet==='solana') ? isSolAddr(query) : isEvmAddr(query);
      if(isAddr){
        modeHint.textContent = 'addr';
      }else{
        modeHint.textContent = 'search';
      }

      const req = ++searchReq;

      try{
        let pairs = [];
        if(isAddr){
          pairs = await dsTokenPairsV1(activeNet, query);
          pairs = pairs.map(p=>({
            chainId: activeNet,
            baseToken: { address: query, symbol: p?.baseToken?.symbol||p?.baseTokenSymbol||'', name: p?.baseToken?.name||p?.baseTokenName||'', logoURI: p?.baseToken?.imageUrl||p?.baseTokenImageUrl||'' },
            quoteToken: { symbol: p?.quoteToken?.symbol||p?.quoteTokenSymbol||'' },
            liquidity: { usd: p?.liquidity?.usd||p?.liquidityUsd||0 },
            volume: { h24: p?.volume?.h24||p?.volumeH24||0 },
            priceChange: { h24: p?.priceChange?.h24||p?.priceChangeH24||0 },
            fdv: p?.fdv||0,
            info: { imageUrl: p?.info?.imageUrl||'' }
          })) : [];
          const best = bestPairAnyNet(pairs);
          if(best && req===searchReq){
            showResults(pairs.slice(0,8).map(renderSearchItem).join(''));
            bindSearchClicks();
          }else if(req===searchReq){
            showResults(`<div class="resItem" style="cursor:default"><div class="resL"><div class="resTxt"><div class="resName">No pairs found</div><div class="resMeta">Try another token</div></div></div></div>`);
          }
        }else{
          pairs = await dsSearch(query);
          if(req!==searchReq) return;
          const list = (pairs||[]).slice(0, 10);
          showResults(list.map(renderSearchItem).join(''));
          bindSearchClicks();
        }
      }catch(e){
        if(req!==searchReq) return;
        showResults(`<div class="resItem" style="cursor:default"><div class="resL"><div class="resTxt"><div class="resName">Search error</div><div class="resMeta">Try again</div></div></div></div>`);
      }
    }

    q.addEventListener('input', (e)=>{
      clearTimeout(searchTimer);
      searchTimer = setTimeout(()=>doSearch(e.target.value), 240);
    });

    q.addEventListener('focus', ()=>{ if(results.innerHTML.trim()) results.style.display='block'; });

    btnGo.addEventListener('click', ()=>{
      const val = String(q.value||'').trim();
      if(!val) return;
      const chain = activeNet;
      if(chain==='solana' ? isSolAddr(val) : isEvmAddr(val)){
        navigate(chain, val);
      }else{
        doSearch(val);
      }
    });

    document.addEventListener('keydown', (e)=>{
      if(e.key==='Escape') hideResults();
    }, {capture:true});

    if(searchScrim){
      searchScrim.style.display = 'none';
    }


    // Live Trades accordion (in-page; expands downward; never overlays chart)
    (function initTradesAccordion(){
      try{
        if(!tradesCard) return;
        const hd = tradesCard.querySelector('.tableHd');
        if(!hd) return;

        let btn = hd.querySelector('.sheetToggleBtn');
        if(!btn){
          btn = document.createElement('button');
          btn.type='button';
          btn.className='iconBtn sheetToggleBtn';
          btn.setAttribute('aria-label','Toggle Live Trades');
          btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M7.41 8.58 12 13.17l4.59-4.59L18 10l-6 6-6-6z"/></svg>';
          const right = hd.querySelector('.sheetRight') || hd;
          right.appendChild(btn);
        }

        function setOpen(open){
          const isOpen = !!open;
          tradesCard.classList.toggle('open', isOpen);
          hd.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        }

        function toggle(){
          setOpen(!tradesCard.classList.contains('open'));
        }

        const mq = window.matchMedia('(max-width: 740px)');
        setOpen(!mq.matches);
        if(mq && mq.addEventListener){ mq.addEventListener('change', ()=>{ setOpen(!mq.matches); }); }

        btn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); toggle(); });
        hd.addEventListener('click', (e)=>{ e.preventDefault(); toggle(); });

        document.addEventListener('keydown', (e)=>{
          if(e.key === 'Escape') setOpen(false);
        });
      }catch(_){}
    })();
  

    // ================================
    //  DexGuard Split Panel (Chart + Txns) + Drag Handle
    // ================================
    (function initSplitPanel(){
      try{
        const rootId = 'splitRoot';
        if(document.getElementById(rootId)) return;
        if(!chartCard || !tradesCard) return;

        try{ const btnFit = document.getElementById('btnFit'); if(btnFit) btnFit.remove(); }catch(_){}
        try{ const btnRefresh = document.getElementById('btnRefresh'); if(btnRefresh) btnRefresh.remove(); }catch(_){}

        try{ const mt = chartCard.querySelector('.mobileTabs'); if(mt) mt.remove(); }catch(_){}
        try{ if(mobileTradesWrap) mobileTradesWrap.style.display='none'; }catch(_){}

        const splitRoot = document.createElement('div');
        splitRoot.id = rootId;
        splitRoot.className = 'splitRoot';

        const splitChart = document.createElement('div');
        splitChart.className = 'splitChart';

        const splitHandle = document.createElement('div');
        splitHandle.className = 'splitHandle';
        splitHandle.setAttribute('role','separator');
        splitHandle.setAttribute('aria-orientation','horizontal');
        splitHandle.title = 'Drag to resize';

        const splitPanel = document.createElement('div');
        splitPanel.className = 'splitPanel';

        const splitTabs = document.createElement('div');
        splitTabs.className = 'splitTabs';

        const mkTab = (key, label)=>{
          const b=document.createElement('button');
          b.type='button';
          b.className='splitTab';
          b.dataset.key=key;
          b.textContent=label;
          return b;
        };

        const tabBoth = mkTab('both','Chart+Txns');
        const tabChartOnly = mkTab('chart','Chart');
        const tabTxnsOnly = mkTab('txns','Txns');
        splitTabs.appendChild(tabBoth);
        splitTabs.appendChild(tabChartOnly);
        splitTabs.appendChild(tabTxnsOnly);

        const splitBody = document.createElement('div');
        splitBody.className = 'splitBody';

        splitPanel.appendChild(splitTabs);
        splitPanel.appendChild(splitBody);

        const chartWrapEl = document.getElementById('chartWrap');
        const controlsEl = chartCard.querySelector('.controls');
        if(chartWrapEl) splitChart.appendChild(chartWrapEl);
        if(controlsEl) splitChart.appendChild(controlsEl);

        tradesCard.classList.remove('desktopOnly');
        splitBody.appendChild(tradesCard);

        const hd = chartCard.querySelector('.cardHd');
        if(hd && hd.parentNode){
          hd.parentNode.insertBefore(splitRoot, hd.nextSibling);
        }else{
          chartCard.appendChild(splitRoot);
        }
        splitRoot.appendChild(splitChart);
        splitRoot.appendChild(splitHandle);
        splitRoot.appendChild(splitPanel);

        const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
        const recompute = ()=>{
          const total = splitRoot.clientHeight || 0;
          const minBottom = 160;
          const maxBottom = Math.max(minBottom, total - 240);
          const cur = parseFloat(getComputedStyle(splitRoot).getPropertyValue('--split-bottom')) || 260;
          const next = clamp(cur, minBottom, maxBottom);
          splitRoot.style.setProperty('--split-bottom', next + 'px');
          requestAnimationFrame(()=>{ try{ chart.applyOptions({ width: chartEl.clientWidth, height: chartEl.clientHeight }); }catch(_){ } });
        };
        window.addEventListener('resize', recompute, {passive:true});
        requestAnimationFrame(recompute);

        const setMode = (mode)=>{
          tabBoth.classList.toggle('active', mode==='both');
          tabChartOnly.classList.toggle('active', mode==='chart');
          tabTxnsOnly.classList.toggle('active', mode==='txns');

          if(mode==='chart'){
            splitPanel.style.display = 'none';
            splitHandle.style.display = 'none';
            splitChart.style.flex = '1 1 auto';
          }else if(mode==='txns'){
            splitChart.style.display = 'none';
            splitHandle.style.display = 'none';
            splitPanel.style.display = 'flex';
          }else{
            splitChart.style.display = 'flex';
            splitPanel.style.display = 'flex';
            splitHandle.style.display = 'flex';
          }

          requestAnimationFrame(()=>{
            try{
              if(mode!=='txns'){
                chart.applyOptions({ width: chartEl.clientWidth, height: chartEl.clientHeight });
                chart.timeScale().fitContent();
              }
            }catch(_){}
          });
        };

        tabBoth.onclick = ()=>setMode('both');
        tabChartOnly.onclick = ()=>setMode('chart');
        tabTxnsOnly.onclick = ()=>setMode('txns');
        setMode('both');

        let dragging = false;
        let startY = 0;
        let startBottom = 0;

        const onMove = (clientY)=>{
          if(!dragging) return;
          const dy = clientY - startY;
          const total = splitRoot.clientHeight || 0;
          const minBottom = 160;
          const maxBottom = Math.max(minBottom, total - 240);
          const next = clamp(startBottom - dy, minBottom, maxBottom);
          splitRoot.style.setProperty('--split-bottom', next + 'px');
          requestAnimationFrame(()=>{ try{ chart.applyOptions({ width: chartEl.clientWidth, height: chartEl.clientHeight }); }catch(_){ } });
        };

        splitHandle.addEventListener('pointerdown', (e)=>{
          dragging = true;
          startY = e.clientY;
          startBottom = parseFloat(getComputedStyle(splitRoot).getPropertyValue('--split-bottom')) || 260;
          splitHandle.setPointerCapture(e.pointerId);
        });
        splitHandle.addEventListener('pointermove', (e)=>onMove(e.clientY));
        splitHandle.addEventListener('pointerup', (e)=>{ dragging=false; try{ splitHandle.releasePointerCapture(e.pointerId); }catch(_){ } });
      }catch(_){}
    })();

    // -------------------- Meta (refresh price/liquidity/24h)
    async function geckoPool(){
      const url = `${GECKO}/networks/${encodeURIComponent(geckoNet())}/pools/${encodeURIComponent(poolAddr)}?include=base_token,quote_token`;
      const j = await fetchJson(url, {timeout:14000, retries:1});
      return j?.data || null;
    }

    async function loadMeta(){
      if(!poolAddr) return;
      try{
        const p = await geckoPool();
        if(!p) return;
        applyPool(p);
      }catch(e){}
    }

    function applyPool(p){
      const a = p?.attributes || {};
      poolId = String(p?.id||'');
      poolAddr = poolAddressFromPool(p);
      tokenSide = 'base';

      curTokenAddr = tokenAddrFromPool(p,'base') || addr;
      curTokenSymbol = tokenSymFromPool(p,'base') || 'TOKEN';
      curQuoteSymbol = tokenSymFromPool(p,'quote') || '';
      curTokenName = String(a.base_token_name || a.token_name || curTokenSymbol || 'Token');
      curTokenImage = tokenImgFromPool(p,'base') || '';

      pairName.textContent = `${curTokenSymbol}${curQuoteSymbol?'/'+curQuoteSymbol:''}`;
      pairMeta.textContent = `${NET_LABEL[normalizeChain(activeNet)]||activeNet.toUpperCase()} â€¢ ${shortAddr(curTokenAddr)} â€¢ Pool ${shortAddr(poolAddr)} â€¢ Age ${fmtAge(poolCreatedMs(p))}`;

      if(curTokenImage){
        tokenLogo.innerHTML = `<img src="${esc(curTokenImage)}" alt="${esc(curTokenSymbol)}" loading="eager" decoding="async" />`;
      }else{
        tokenLogo.innerHTML = `<span class="fb" id="tokenLogoFb">${esc((curTokenSymbol||'?').slice(0,1))}</span>`;
      }

      const price = num(a.base_token_price_usd || a.token_price_usd || a.price_usd);
      const liq = poolLiqUsd(p);
      const chg = num(a.price_change_percentage?.h24 || a.price_change_percentage_24h || a.price_change_24h || a.price_change_percentage?.h24 || a.price_change_percentage_24h);
      const mc  = num(a.fdv_usd || a.market_cap_usd || a.fdv || a.market_cap);

      const pTxt = Number.isFinite(price) ? '$'+formatPrice(price) : 'â€”';
      const lTxt = '$'+formatCompact(liq);
      const mcTxt = '$'+formatCompact(mc);
      const hTxt = Number.isFinite(chg) ? (chg>=0?'+':'')+chg.toFixed(2)+'%' : 'â€”';

      const hCls = Number.isFinite(chg) ? (chg>=0?'up':'down') : '';

      stats.innerHTML = `
        <span class="statPill">Price <b class="mono">${esc(pTxt)}</b></span>
        <span class="statPill">Liquidity <b class="mono">${esc(lTxt)}</b></span>
        <span class="statPill">MCap <b class="mono">${esc(mcTxt)}</b></span>
        <span class="statPill ${hCls}">24h <b class="mono">${esc(hTxt)}</b></span>
      `;

      btnBuy.href = buildBuyUrl(activeNet, curTokenAddr);
    }

    // -------------------- Pools list
    async function geckoTokenPools(){
      const url = `${GECKO}/networks/${encodeURIComponent(geckoNet())}/tokens/${encodeURIComponent(addr)}/pools?include=base_token,quote_token&page=1&limit=20`;
      const j = await fetchJson(url, {timeout:14000, retries:1});
      return Array.isArray(j?.data) ? j.data : [];
    }

    function poolLabel(p){
      const a = p?.attributes || {};
      const bSym = tokenSymFromPool(p,'base') || a.base_token_symbol || '';
      const qSym = tokenSymFromPool(p,'quote') || a.quote_token_symbol || '';
      const liq = poolLiqUsd(p);
      const vol = num(a.volume_usd?.h24 || a.volume_usd_24h || a.volume_usd_h24 || a.volume_usd_24h);
      const addr = poolAddressFromPool(p);
      return `${bSym}/${qSym} â€¢ Liq $${formatCompact(liq)} â€¢ Vol $${formatCompact(vol||0)} â€¢ ${shortAddr(addr)}`;
    }

    function renderPoolSel(list){
      poolChoices = list || [];
      poolSel.innerHTML = '';
      poolChoices.forEach((p, i)=>{
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = poolLabel(p);
        poolSel.appendChild(opt);
      });
      poolSel.onchange = ()=>{
        const idx = Number(poolSel.value||0);
        const p = poolChoices[idx];
        if(!p) return;
        poolAddr = poolAddressFromPool(p);
        applyPool(p);
        loadCandles(true);
        loadTrades(true);
        startLiveLoops();
      };
    }

    // -------------------- Candles
    async function geckoOhlcv(){
      if(!poolAddr) return [];
      if(activeTF.k==='ALL'){
        const url = `${GECKO}/networks/${encodeURIComponent(geckoNet())}/pools/${encodeURIComponent(poolAddr)}/ohlcv/day?aggregate=1&limit=1000`;
        const j = await fetchJson(url, {timeout:14000, retries:1});
        return j?.data?.attributes?.ohlcv_list || [];
      }
      const frame = activeTF.agg;
      const gran = frame<=60 ? 'minute' : (frame<=3600 ? 'minute' : 'hour');
      const agg = gran==='minute' ? Math.max(1, Math.round(frame/60)) : Math.max(1, Math.round(frame/3600));
      const url = `${GECKO}/networks/${encodeURIComponent(geckoNet())}/pools/${encodeURIComponent(poolAddr)}/ohlcv/${gran}?aggregate=${encodeURIComponent(agg)}&limit=600`;
      const j = await fetchJson(url, {timeout:14000, retries:1});
      return j?.data?.attributes?.ohlcv_list || [];
    }

    function parseOhlcv(list){
      const out=[];
      for(const row of (list||[])){
        const time = Number(row[0]||0);
        const open = Number(row[1]);
        const high0 = Number(row[2]);
        const low0  = Number(row[3]);
        const close = Number(row[4]);
        const volume = Number(row[5]||0);
        if(!(time>0) || !Number.isFinite(open) || !Number.isFinite(close) || !Number.isFinite(high0) || !Number.isFinite(low0)) continue;
        const high = Math.max(high0, open, close);
        const low  = Math.min(low0, open, close);
        out.push({time, open, high, low, close, volume: Number.isFinite(volume)?volume:0});
      }
      return out;
    }

    function applyCandlesToChart(fit){
      const map = new Map();
      for(const c of (rawCandles||[])){
        if(!c || !(c.time>0)) continue;
        map.set(c.time, c);
      }
      rawCandles = Array.from(map.values()).sort((a,b)=>a.time-b.time);
      const src = rawCandles;

      candleSeries.setData(src.map(c=>({time:c.time, open:c.open, high:c.high, low:c.low, close:c.close})));
      volumeSeries.setData(src.map(c=>({time:c.time, value:c.volume||0, color:(c.close>=c.open)?'rgba(20,241,149,.35)':'rgba(255,77,109,.35)'})));

      if(fit){
        applyDefaultViewport();
      }else{
        syncBarSpacing();
      }
    }

    async function loadCandles(fit=false){
      if(!poolAddr) return;
      try{
        const list = await geckoOhlcv();
        rawCandles = parseOhlcv(list);
        applyCandlesToChart(fit);
      }catch(e){}
    }

    async function refreshLatestCandles(){
      await loadCandles(false);
    }

    function applyTradeToCandles(tr){
      if(!rawCandles || !rawCandles.length) return;
      if(!Number.isFinite(tr?.price)) return;
      if(!Number.isFinite(tr?.tsMs)) return;

      const tsSec = Math.floor(tr.tsMs/1000);
      const bucket = Math.floor(tsSec / activeTF.agg) * activeTF.agg;

      const last = rawCandles[rawCandles.length-1];
      const usdVol = Number.isFinite(tr.usd) ? tr.usd : 0;

      if(bucket < last.time - activeTF.agg*3){
        return;
      }

      if(bucket === last.time){
        last.close = tr.price;
        if(tr.price > last.high) last.high = tr.price;
        if(tr.price < last.low) last.low = tr.price;
        if(usdVol) last.volume = (Number.isFinite(last.volume)?last.volume:0) + usdVol;
        candleSeries.update({time:last.time, open:last.open, high:last.high, low:last.low, close:last.close});
        volumeSeries.update({time:last.time, value:last.volume, color:(last.close>=last.open)?'rgba(20,241,149,.35)':'rgba(255,77,109,.35)'});
        return;
      }

      if(bucket > last.time){
        const open = Number.isFinite(last.close) ? last.close : tr.price;
        const c = {
          time: bucket,
          open,
          high: Math.max(open, tr.price),
          low: Math.min(open, tr.price),
          close: tr.price,
          volume: usdVol
        };
        rawCandles.push(c);
        candleSeries.update({time:c.time, open:c.open, high:c.high, low:c.low, close:c.close});
        volumeSeries.update({time:c.time, value:c.volume, color:(c.close>=c.open)?'rgba(20,241,149,.35)':'rgba(255,77,109,.35)'});
      }
    }

    // -------------------- Trades
    function tradesContainer(){
      return [tradesDesk];
    }

    function timeAgo(tsMs){
      const d = Math.max(0, Date.now() - tsMs);
      const s = Math.floor(d/1000);
      if(s<60) return s+'s';
      const m = Math.floor(s/60);
      if(m<60) return m+'m';
      const h = Math.floor(m/60);
      if(h<24) return h+'h';
      const days = Math.floor(h/24);
      return days+'d';
    }

    function parseTrade(t){
      const a = t?.attributes || {};
      const id = String(t?.id || a.tx_hash || a.transaction_hash || a.signature || a.transaction_id || '') || '';
      const side = String(a.trade_type || a.side || a.taker_side || a.kind || '').toLowerCase();
      const type = side.includes('sell') ? 'sell' : (side.includes('buy') ? 'buy' : (a.is_buy===true?'buy':(a.is_sell===true?'sell':'')));

      const tx = String(a.tx_hash || a.transaction_hash || a.signature || a.transaction_id || id || '').trim();
      const maker = String(
        a.taker || a.trader || a.wallet_address || a.from_address || a.maker || a.maker_address || a.tx_from_address || a.user_address || ''
      ).trim();

      const rawTs = (a.block_timestamp ?? a.timestamp ?? a.time ?? a.created_at ?? a.mined_at ?? a.block_time ?? 0);
      let tsMs = NaN;
      if(typeof rawTs==='number'){
        tsMs = rawTs>1e12 ? rawTs : rawTs*1000;
      }else{
        const tsv = String(rawTs||'').trim();
        if(tsv && /^\d+(\.\d+)?$/.test(tsv)){
          const n = Number(tsv);
          tsMs = n>1e12 ? n : n*1000;
        }else{
          const d = Date.parse(tsv);
          if(Number.isFinite(d)) tsMs = d;
        }
      }
      if(!Number.isFinite(tsMs)) tsMs = Date.now();

      const usd = num(a.volume_in_usd || a.usd_value || a.volume_usd || a.amount_usd || a.total_usd);
      const price = num(a.price_in_usd || a.price_usd || a.price);
      const baseAmt = num(a.base_token_amount || a.amount_base || a.base_amount || a.base_token_volume || a.base_volume);
      const quoteAmt = num(a.quote_token_amount || a.amount_quote || a.quote_amount || a.quote_token_volume || a.quote_volume);
      const amount = Number.isFinite(baseAmt) ? baseAmt : (Number.isFinite(quoteAmt)? quoteAmt : NaN);

      return { id, type, tx, maker, tsMs, usd, price, amount };
    }

    function tradeRowHtml(tr){
      const age = timeAgo(tr.tsMs);
      const usdTxt = Number.isFinite(tr.usd) ? '$'+formatCompact(tr.usd) : 'â€”';
      const amtTxt = Number.isFinite(tr.amount) ? formatCompact(tr.amount)+' '+esc(curTokenSymbol) : 'â€”';
      const priceTxt = Number.isFinite(tr.price) ? '$'+formatPrice(tr.price) : 'â€”';

      const isNew = tr.maker ? (!seenMakers.has(tr.maker)) : false;
      if(tr.maker) seenMakers.add(tr.maker);

      const makerHtml = tr.maker
        ? `<div class="maker"><span class="addr mono" title="${esc(tr.maker)}">${esc(shortAddr(tr.maker))}</span>${isNew?'<span class="new">NEW</span>':''}</div>`
        : `<span class="mono" style="opacity:.7">â€”</span>`;

      const txUrl = tr.tx ? explorerTx(activeNet, tr.tx) : '#';

      return `
        <div class="tradeRow" data-id="${esc(tr.id)}" data-ts="${Number.isFinite(tr.tsMs)?tr.tsMs:0}" data-price="${Number.isFinite(tr.price)?tr.price:''}" data-usd="${Number.isFinite(tr.usd)?tr.usd:''}" data-type="${esc(tr.type||'')}">
          <div class="mono age">${esc(age)}</div>
          <div><span class="typeBadge ${tr.type==='sell'?'sell':'buy'}">${tr.type==='sell'?'SELL':'BUY'}</span></div>
          <div class="mono">${esc(usdTxt)}</div>
          <div class="mono">${amtTxt}</div>
          <div class="mono hideM">${esc(priceTxt)}</div>
          <div class="hideM">${makerHtml}</div>
          <div>
            <a class="iconBtn" href="${esc(txUrl)}" target="_blank" rel="noreferrer" title="Open Tx">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 3h7v7" stroke="rgba(255,255,255,80)" stroke-width="2" stroke-linecap="round"/><path d="M21 3 10 14" stroke="rgba(255,255,255,80)" stroke-width="2" stroke-linecap="round"/><path d="M10 5H7a4 4 0 0 0-4 4v8a4 4 0 0 0 4 4h8a4 4 0 0 0 4-4v-3" stroke="rgba(255,255,255,55)" stroke-width="2" stroke-linecap="round"/></svg>
            </a>
          </div>
        </div>
      `;
    }

    async function geckoTrades(limit=80){
      const base = `${GECKO}/networks/${encodeURIComponent(geckoNet())}/pools/${encodeURIComponent(poolAddr)}/trades`;
      try{
        const url1 = base + `?page=1&limit=${encodeURIComponent(limit)}`;
        const j1 = await fetchJson(url1, {timeout:14000, retries:1});
        if(Array.isArray(j1?.data) && j1.data.length) return j1.data;
      }catch(e){}

      try{
        const url2 = base + `?limit=${encodeURIComponent(limit)}`;
        const j2 = await fetchJson(url2, {timeout:14000, retries:1});
        if(Array.isArray(j2?.data)) return j2.data;
      }catch(e){}

      return [];
    }

    function renderTrades(trades, {reset=false}={}){
      const parsed = (trades||[]).map(parseTrade).filter(x=>x.id && Number.isFinite(x.tsMs));
      parsed.sort((a,b)=>b.tsMs-a.tsMs);

      if(reset){
        tradesSeen = new Set();
        seenMakers = new Set();
        tradesContainer().forEach(el=>{
          const head = el.querySelector('.tradeHead');
          el.innerHTML='';
          el.appendChild(head);
        });
      }

      const newly = [];
      for(const tr of parsed){
        if(tradesSeen.has(tr.id)) continue;
        tradesSeen.add(tr.id);
        newly.push(tr);
      }

      if(!newly.length) return [];

      newly.slice().sort((a,b)=>a.tsMs-b.tsMs);

      tradesContainer().forEach(el=>{
        for(const tr of newly){
          const tmp = document.createElement('div');
          tmp.innerHTML = tradeRowHtml(tr);
          const row = tmp.firstElementChild;
          if(row) row.classList.add('enter');
          el.insertBefore(row, el.children[1] || null);
        }
        while(el.children.length > 1 + 200){
          el.removeChild(el.lastElementChild);
        }
      });

      const buys = parsed.filter(x=>x.type==='buy').length;
      const sells = parsed.filter(x=>x.type==='sell').length;
      tradesStat.textContent = `${buys}B / ${sells}S`;

      return newly;
    }

    async function loadTrades(reset=false){
      if(!poolAddr) return;
      const _key0 = `${activeNet}|${poolAddr}`;
      const _reqId = (loadTrades._reqId = (loadTrades._reqId||0) + 1);
      const _my = _reqId;
      try{
        const data = await geckoTrades(80);
        if(_my !== loadTrades._reqId) return;
        if(_key0 !== `${activeNet}|${poolAddr}`) return;
        const newly = renderTrades(data, {reset}) || [];
        if(newly.length){
          newly.slice().sort((a,b)=>a.tsMs-b.tsMs).forEach(applyTradeToCandles);
        }
      }catch(e){}
    }

    function updateAges(){}

    function stopLiveLoops(){
      LIVE.gen++;
      const st = LIVE;
      if(st.tTrades){ clearTimeout(st.tTrades); st.tTrades=null; }
      if(st.tCandles){ clearTimeout(st.tCandles); st.tCandles=null; }
      if(st.tMeta){ clearTimeout(st.tMeta); st.tMeta=null; }
      if(st.tAges){ clearInterval(st.tAges); st.tAges=null; }
    }

    const LIVE = { gen:0, tTrades:null, tCandles:null, tMeta:null, tAges:null, failTrades:0, tradeDelay:1500 };

    function startLiveLoops(){
      stopLiveLoops();
      const gen = LIVE.gen;
      LIVE.failTrades = 0;
      LIVE.tradeDelay = 1500;

      const scheduleTrades = async ()=>{
        if(gen !== LIVE.gen) return;
        try{
          await loadTrades(false);
          LIVE.failTrades = 0;
          LIVE.tradeDelay = 1500;
        }catch(_){
          LIVE.failTrades = (LIVE.failTrades||0) + 1;
          LIVE.tradeDelay = Math.min(7000, Math.round(1500 * Math.pow(1.25, LIVE.failTrades)));
        }
        LIVE.tTrades = setTimeout(scheduleTrades, LIVE.tradeDelay);
      };

      const scheduleCandles = async ()=>{
        if(gen !== LIVE.gen) return;
        try{ await refreshLatestCandles(); }catch(_){}
        LIVE.tCandles = setTimeout(scheduleCandles, 9000);
      };

      const scheduleMeta = async ()=>{
        if(gen !== LIVE.gen) return;
        try{ await loadMeta(); }catch(_){}
        LIVE.tMeta = setTimeout(scheduleMeta, 15000);
      };

      LIVE.tAges = setInterval(()=>{ if(gen === LIVE.gen) updateAges(); }, 1000);

      scheduleTrades();
      scheduleCandles();
      scheduleMeta();
    }

    // -------------------- Trending (simple; can be replaced)
    async function dsTrending(net){
      const chain = NET_DS[normalizeChain(net)] || 'solana';
      const url = `${DS}/trending/${encodeURIComponent(chain)}`;
      try{
        const j = await fetchJson(url, {timeout:12000, retries:1});
        return Array.isArray(j?.pairs) ? j.pairs : [];
      }catch(_){
        return [];
      }
    }

    function pctClass(v){ return v>=0 ? 'up':'down'; }

    function netColor(net){
      net = normalizeChain(net);
      if(net==='solana') return '#14F195';
      if(net==='eth') return '#7aa2ff';
      if(net==='bsc') return '#F3BA2F';
      if(net==='base') return '#00D1FF';
      return '#fff';
    }

    function logoBox(p){
      const base = p?.baseToken || {};
      const sym = (base?.symbol||'').toUpperCase();
      const logo = base?.logoURI || base?.logoUrl || base?.imageUrl || base?.image || p?.info?.imageUrl || '';
      if(logo) return `<img src="${esc(logo)}" alt="" loading="lazy" decoding="async" style="width:18px;height:18px;border-radius:6px;object-fit:cover"/>`;
      return `<span class="fallback">${esc((sym||'?').slice(0,1))}</span>`;
    }

    function tickerItemHtml(p, i, net){
      const base = p?.baseToken || {};
      const sym = (base?.symbol||'').toUpperCase() || 'â€”';
      const chg = Number(p?.priceChange?.h24||0);
      const pct = Number.isFinite(chg) ? (chg>=0?'+':'')+chg.toFixed(2)+'%' : 'â€”';
      const cls = pctClass(chg);
      const color = netColor(net);
      const rank = i+1;

      const top1 = rank===1 ? ' top1' : '';

      return `
        <span class="tickerItem${top1}" data-addr="${esc(base?.address||'')}" data-net="${esc(net)}" style="--netColor:${esc(color)}">
          <span class="rank">${rank}</span>
          <span class="logoBox" style="display:inline-grid;place-items:center;width:18px;height:18px;border-radius:6px;overflow:hidden;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10)">${logoBox(p)}</span>
          <span class="sym">${esc(sym)}</span>
          <span class="tickerPct ${cls}">${esc(pct)}</span>
        </span>
      `;
    }

    let trendNet = normalizeChain('solana');
    const trendToggle = $('trendToggle');
    if(trendToggle){
      [...trendToggle.querySelectorAll('.chainBtn')].forEach(btn=>{
        btn.addEventListener('click', ()=>{
          [...trendToggle.querySelectorAll('.chainBtn')].forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          trendNet = normalizeChain(btn.dataset.net||'solana');
          loadTrending(true);
        });
      });
    }

    const tickerTrack = $('tickerTrack');

    let tickerX = 0;
    let tickerSpeed = 0.45;

    function animateTicker(){
      tickerX -= tickerSpeed;
      tickerTrack.style.transform = `translateX(${tickerX}px)`;
      const first = tickerTrack.firstElementChild;
      if(first){
        const w = first.getBoundingClientRect().width + 10;
        if(-tickerX > w){
          tickerX += w;
          tickerTrack.appendChild(first);
        }
      }
      requestAnimationFrame(animateTicker);
    }

    function bindTickerClicks(){
      [...tickerTrack.querySelectorAll('.tickerItem')].forEach(el=>{
        el.onclick = ()=>{
          const a = el.getAttribute('data-addr')||'';
          const n = el.getAttribute('data-net')||trendNet;
          if(a) navigate(n, a);
        };
      });
    }

    async function loadTrending(resetPos=false){
      const pairs = await dsTrending(trendNet);
      const list = (pairs||[]).slice(0,10);
      const html = list.map((p,i)=>tickerItemHtml(p,i,trendNet)).join('');
      tickerTrack.innerHTML = html + html;
      if(resetPos) tickerX = 0;
      bindTickerClicks();
    }

    // -------------------- Boot sequence
    async function boot(){
      renderNetPills();
      renderTimeframes();

      if(!addr){
        addr = DEFAULT_TOKEN[activeNet] || DEFAULT_TOKEN.solana;
      }

      btnBuy.href = buildBuyUrl(activeNet, addr);

      try{
        const pools = await geckoTokenPools();
        if(pools && pools.length){
          renderPoolSel(pools);
          const best = pools[0];
          poolAddr = poolAddressFromPool(best);
          applyPool(best);
          await loadCandles(true);
          await loadTrades(true);
          startLiveLoops();
        }else{
          toast('No pools found');
        }
      }catch(e){
        toast('Load error');
      }

      loadTrending(true);
      requestAnimationFrame(animateTicker);
    }

    boot();
  })();
  </script>
</body>
</html>
