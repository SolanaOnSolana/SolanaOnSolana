<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#070711" />
  <title>$SOS â€” DEX Terminal</title>

  <!-- Native chart (no TradingView iframe). -->
  <script defer src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    :root{
      --bg:#070711;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.085);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --g:#14F195;
      --c:#00D1FF;
      --p:#9945FF;
      --eth:#627EEA;
      --bnb:#F3BA2F;
      --base:#0052FF;
      --radius: 22px;
      --shadow2: 0 14px 44px rgba(0,0,0,.45);
      --shadowSoft: 0 10px 28px rgba(0,0,0,.28);
      --max: 1200px;
      --ring: 0 0 0 6px rgba(20,241,149,.08);

      /* ticker defaults (important so animation NEVER stops) */
      --tickerSpeed: 12.5s;
      --tickerDistance: 1400px;

      /* per-chain dynamic (set on body class) */
      --netColor: var(--p);
      --netGlow: rgba(153,69,255,.22);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font: 15.5px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: var(--bg);
      overflow-x:hidden;
      position:relative;
    }

    body::before{
      content:"";
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events:none;
      background:
        radial-gradient(1200px 760px at 10% 5%, rgba(153,69,255,.24), transparent 60%),
        radial-gradient(1000px 720px at 90% 10%, rgba(20,241,149,.18), transparent 58%),
        radial-gradient(900px 640px at 72% 92%, rgba(0,209,255,.14), transparent 58%),
        radial-gradient(900px 640px at 0% 95%, rgba(0,209,255,.06), transparent 60%),
        var(--bg);
      transform: translateZ(0);
    }

    a{color:inherit; text-decoration:none}
    img{max-width:100%; height:auto}

    :focus-visible{ outline:none; box-shadow: var(--ring); border-radius: 14px; }

    .wrap{max-width:var(--max); margin:0 auto; padding:0 16px;}

    .header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(14px);
      background: rgba(7,7,17,.68);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }

    .headerRow{
      display:grid;
      grid-template-columns: auto 1fr auto;
      align-items:center;
      gap:12px;
      padding:12px 0;
    }

    .brand{display:flex; align-items:center; gap:12px; min-width: 220px;}
    .brandLogo{
      width:42px; height:42px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 20%, rgba(20,241,149,.35), transparent 50%),
                  radial-gradient(circle at 70% 30%, rgba(0,209,255,.28), transparent 52%),
                  radial-gradient(circle at 45% 75%, rgba(153,69,255,.30), transparent 55%),
                  rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 12px 30px rgba(0,0,0,.28);
      display:grid; place-items:center;
      font-weight: 1100;
      letter-spacing:.2px;
    }
    .brandText{display:flex; flex-direction:column; line-height:1.06}
    .brandText .title{font-weight:1000; font-size:18px}
    .brandText .sub{color:var(--muted); font-weight:750; font-size:13.5px}

    .headerMid{display:flex; justify-content:center; gap:10px; min-width:0;}

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.90);
      font-weight:900;
      font-size:13px;
      transition: transform .15s ease, background .15s ease, box-shadow .15s ease, border-color .15s ease;
      white-space: nowrap;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{background: rgba(255,255,255,.10); transform: translateY(-1px)}
    .btn:active{transform: translateY(0px) scale(.99)}
    .btn.primary{
      border: 0;
      background: linear-gradient(90deg, var(--g), var(--c), var(--p));
      color: #061012;
      box-shadow: 0 14px 28px rgba(0,0,0,.28);
    }
    .btn.icon{ width:44px; padding:9px 0; font-size:16px; }

    .chainToggle{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      overflow:auto;
    }
    .chainBtn{
      display:inline-flex; align-items:center; justify-content:center;
      height: 36px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.88);
      font-weight: 1000;
      letter-spacing:.3px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .chainBtn .dot{width:10px; height:10px; border-radius:999px; background: rgba(255,255,255,.35); margin-right:8px;}
    .chainBtn.active{ border-color: rgba(255,255,255,.96); color: rgba(255,255,255,.98); }

    /* per-chain active fill (exact from main) */
    body.net-sol{ --netColor: var(--p); --netGlow: rgba(153,69,255,.22); }
    body.net-eth{ --netColor: var(--eth); --netGlow: rgba(98,126,234,.22); }
    body.net-bnb{ --netColor: var(--bnb); --netGlow: rgba(243,186,47,.20); }
    body.net-base{ --netColor: var(--base); --netGlow: rgba(0,82,255,.20); }

    body.net-sol .chainBtn.active{ background: linear-gradient(90deg, rgba(153,69,255,.96), rgba(153,69,255,.52)); border-color: rgba(255,255,255,.96); box-shadow: 0 0 0 1px rgba(153,69,255,.20) inset, 0 12px 30px rgba(153,69,255,.18), 0 16px 34px rgba(0,0,0,.34); }
    body.net-eth .chainBtn.active{ background: linear-gradient(90deg, rgba(98,126,234,.96), rgba(98,126,234,.52)); border-color: rgba(255,255,255,.96); box-shadow: 0 0 0 1px rgba(98,126,234,.20) inset, 0 12px 30px rgba(98,126,234,.18), 0 16px 34px rgba(0,0,0,.34); }
    body.net-bnb .chainBtn.active{ background: linear-gradient(90deg, rgba(243,186,47,.96), rgba(243,186,47,.50)); border-color: rgba(255,255,255,.96); box-shadow: 0 0 0 1px rgba(243,186,47,.20) inset, 0 12px 30px rgba(243,186,47,.16), 0 16px 34px rgba(0,0,0,.34); }
    body.net-base .chainBtn.active{ background: linear-gradient(90deg, rgba(0,82,255,.96), rgba(0,82,255,.50)); border-color: rgba(255,255,255,.96); box-shadow: 0 0 0 1px rgba(0,82,255,.20) inset, 0 12px 30px rgba(0,82,255,.16), 0 16px 34px rgba(0,0,0,.34); }

    /* Cards */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.075), rgba(255,255,255,.045));
      border: 1px solid rgba(255,255,255,.11);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      position: relative;
      overflow:hidden;
    }

    .card::before{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background:
        radial-gradient(600px 260px at 0% 0%, rgba(153,69,255,.10), transparent 60%),
        radial-gradient(540px 260px at 100% 0%, rgba(0,209,255,.08), transparent 62%);
      opacity:.9;
    }

    .cardInner{ position:relative; padding: 16px; }

    /* Trending block (same vibe as main) */
    .hotBlock{ margin: 16px 0 12px; }
    .hotRow{ display:flex; gap:12px; align-items:center; }
    .hotLabel{
      display:flex; align-items:center; gap:10px;
      padding:10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      font-weight:1000;
      white-space:nowrap;
    }
    .hotLabel .pill{
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.82);
      font-size: 12px;
      font-weight: 1000;
      letter-spacing:.2px;
    }
    .hotStatus{ margin-left: 6px; color: rgba(255,255,255,.70); font-weight:900; font-size: 13px; }

    .tickerWrap{
      flex: 1;
      min-width: 0;
      position: relative;
      overflow: hidden;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      padding: 10px 12px;
    }

    .tickerWrap:before,.tickerWrap:after{
      content:"";
      position:absolute;
      top:0; bottom:0;
      width: 44px;
      pointer-events:none;
      z-index: 2;
    }
    .tickerWrap:before{ left:0; background: linear-gradient(90deg, rgba(7,7,17,.95), rgba(7,7,17,0)); }
    .tickerWrap:after{ right:0; background: linear-gradient(270deg, rgba(7,7,17,.95), rgba(7,7,17,0)); }

    .tickerTrack{
      display:flex;
      gap: 10px;
      align-items:center;
      white-space: nowrap;
      will-change: transform;
      animation: tickerMarquee var(--tickerSpeed) linear infinite;
    }
    .tickerWrap:hover .tickerTrack{ animation-play-state: paused; }

    @keyframes tickerMarquee{
      0%{ transform: translateX(0); }
      100%{ transform: translateX(calc(-1 * var(--tickerDistance))); }
    }

    .tickerItem{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 0 0 1px var(--netGlow) inset;
      color: rgba(255,255,255,.92);
      font-weight: 900;
      font-size: 13px;
      letter-spacing: .1px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .tickerItem:active{ transform: scale(.995); }

    .tickerLogoWrap{
      width:28px;
      height:28px;
      flex:0 0 28px;
      border-radius: 6px;
      overflow:hidden;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 8px 18px rgba(0,0,0,.22);
    }
    .tickerLogo{ width:100%; height:100%; object-fit: cover; display:block; }
    .tickerLogoFallback{ font-size: 12px; font-weight: 1100; color: rgba(255,255,255,.90); line-height: 1; }

    .tickerItem.top1{ background: rgba(255,215,0,.10); border-color: rgba(255,215,0,.32); box-shadow: 0 0 0 1px rgba(255,215,0,.18) inset, 0 12px 30px rgba(0,0,0,.26); }
    .tickerItem.top1 .tickerLogoWrap{ border-color: rgba(255,215,0,.35); box-shadow: 0 0 0 1px rgba(255,215,0,.15) inset, 0 10px 22px rgba(0,0,0,.22); }

    .tickerItem .rank{
      display:inline-flex; align-items:center; justify-content:center;
      min-width: 28px; height: 22px; padding: 0 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      font-weight: 1000;
      color: var(--netColor);
    }
    .tickerItem.top1 .rank{ background: linear-gradient(90deg, #F3BA2F, #FFD700, #FFF2B0); color: rgba(10,10,22,.92); border:0; font-weight: 1100; }

    .tickerPct{
      display:inline-flex; align-items:center; justify-content:center;
      height: 22px; padding: 0 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      font-weight: 950;
      color: rgba(255,255,255,.90);
    }
    .tickerPct.up{ color: rgba(20,241,149,.98); background: rgba(20,241,149,.10); border-color: rgba(20,241,149,.22); }
    .tickerPct.down{ color: rgba(255,90,90,.96); background: rgba(255,90,90,.10); border-color: rgba(255,90,90,.22); }

    /* Search */
    .searchRow{ display:flex; gap:10px; align-items:center; margin-top: 12px; }
    .searchWrap{
      flex:1; display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
    }
    .searchWrap .icon{ opacity:.8; }
    .searchInput{
      flex:1;
      background: transparent;
      border:0;
      outline:none;
      color: rgba(255,255,255,.92);
      font-weight: 900;
      font-size: 14.5px;
      letter-spacing:.1px;
    }
    .searchInput::placeholder{ color: rgba(255,255,255,.55); font-weight: 800; }

    .pillAuto{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.82);
      font-size: 12px;
      font-weight: 1000;
      cursor:pointer;
      user-select:none;
    }

    /* Result dropdown */
    .resBox{
      margin-top: 10px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(7,7,17,.55);
      backdrop-filter: blur(10px);
      box-shadow: 0 16px 44px rgba(0,0,0,.40);
      overflow:hidden;
      display:none;
    }
    .resBox.show{ display:block; }

    .resRow{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 12px;
      border-top: 1px solid rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
    }
    .resRow:first-child{ border-top:0; }
    .resRow:hover{ background: rgba(255,255,255,.04); }

    .resLeft{ display:flex; gap:10px; align-items:center; min-width:0; }
    .resLogoWrap{
      width:34px; height:34px; border-radius: 10px;
      overflow:hidden;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 24px rgba(0,0,0,.22);
      display:grid; place-items:center;
      flex:0 0 34px;
    }
    .resLogo{ width:100%; height:100%; object-fit:cover; }
    .resLogoFallback{ font-weight:1100; font-size:13px; color: rgba(255,255,255,.9); }

    .resTitle{ font-weight: 1000; white-space:nowrap; overflow:hidden; text-overflow: ellipsis; }
    .resMeta{ color: rgba(255,255,255,.65); font-weight:900; font-size: 12px; }

    .resRight{ display:flex; gap:8px; align-items:center; }
    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      height: 22px;
      padding: 0 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      font-weight: 1000;
      color: rgba(255,255,255,.86);
      white-space:nowrap;
    }
    .pill.up{ color: rgba(20,241,149,.98); background: rgba(20,241,149,.10); border-color: rgba(20,241,149,.22); }
    .pill.down{ color: rgba(255,90,90,.96); background: rgba(255,90,90,.10); border-color: rgba(255,90,90,.22); }

    /* Token header */
    .tokenTop{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top: 12px; }
    .tokenInfo{ display:flex; align-items:center; gap:12px; min-width:0; }
    .tokenLogoWrap{ width:42px; height:42px; border-radius: 14px; overflow:hidden; background: rgba(255,255,255,.07); border: 1px solid rgba(255,255,255,.12); box-shadow: 0 12px 30px rgba(0,0,0,.28); display:grid; place-items:center; }
    .tokenLogo{ width:100%; height:100%; object-fit: cover; }
    .tokenLogoFallback{ font-weight: 1100; }

    .tokenNames{ display:flex; flex-direction:column; min-width:0; }
    .tokenNames .sym{ font-weight: 1100; font-size: 20px; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow: ellipsis; }
    .tokenNames .name{ color: rgba(255,255,255,.65); font-weight: 900; font-size: 13px; white-space:nowrap; overflow:hidden; text-overflow: ellipsis; }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .chip{
      display:inline-flex; align-items:center; justify-content:center;
      height: 34px;
      padding: 0 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-weight: 1000;
      color: rgba(255,255,255,.92);
      box-shadow: 0 0 0 1px rgba(255,255,255,.03) inset;
      white-space:nowrap;
    }
    .chip.negative{ color: rgba(255,90,90,.96); background: rgba(255,90,90,.10); border-color: rgba(255,90,90,.22); }
    .chip.positive{ color: rgba(20,241,149,.98); background: rgba(20,241,149,.10); border-color: rgba(20,241,149,.22); }

    /* Main grid */
    .grid{
      display:grid;
      grid-template-columns: 1.65fr 1fr;
      gap: 14px;
      margin-top: 12px;
    }

    .chartCard .cardInner{ padding: 12px; }
    .chartHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 8px;
    }

    .tfRow{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .tfBtn{ height: 30px; padding: 0 10px; font-size: 12px; font-weight: 1000; border-radius: 999px; border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.05); color: rgba(255,255,255,.86); cursor:pointer; }
    .tfBtn.active{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.18); box-shadow: 0 0 0 1px var(--netGlow) inset; }

    .chartArea{ height: 520px; border-radius: 16px; overflow:hidden; border: 1px solid rgba(255,255,255,.08); background: rgba(0,0,0,.10); }

    .chartFoot{ display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-top: 10px; }
    .miniBtn{ height: 34px; padding: 0 12px; }

    .tradesCard .cardInner{ padding: 12px; }
    .tradesHead{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 8px; }
    .tradesTitle{ font-weight: 1100; }
    .tradesStat{ color: rgba(255,255,255,.65); font-weight: 900; font-size: 12.5px; }

    .tradeTable{ width:100%; border-collapse: collapse; }
    .tradeTable th, .tradeTable td{ text-align:left; padding: 10px 10px; border-top: 1px solid rgba(255,255,255,.06); font-weight: 900; }
    .tradeTable th{ color: rgba(255,255,255,.62); font-weight: 1000; font-size: 12px; position: sticky; top: 0; background: rgba(7,7,17,.62); backdrop-filter: blur(10px); z-index: 2; }
    .tradeTable td{ font-size: 13px; color: rgba(255,255,255,.90); }
    .tradeTable tr:hover td{ background: rgba(255,255,255,.03); }

    .typeBuy{ color: rgba(20,241,149,.98); }
    .typeSell{ color: rgba(255,90,90,.96); }

    .addr{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; font-size: 12px; color: rgba(255,255,255,.72); }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      z-index: 999;
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(10,10,22,.76);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      color: rgba(255,255,255,.92);
      font-weight: 950;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-2px); }

    /* ===== MOBILE (clean, usable, NO chaos) ===== */
    .mobileTabs{ display:none; }

    @media (max-width: 980px){
      .headerRow{ grid-template-columns: 1fr; gap:10px; }
      .brand{ min-width: 0; justify-content:center; }
      .headerMid{ justify-content:center; }
      .headerActions{ display:flex; justify-content:center; gap:10px; }

      .hotRow{ flex-direction:column; align-items:stretch; }
      .hotLabel{ justify-content:space-between; }

      .searchRow{ flex-direction:column; align-items:stretch; }

      .tokenTop{ flex-direction:column; align-items:flex-start; }
      .chips{ justify-content:flex-start; }

      .grid{ grid-template-columns: 1fr; }
      .chartArea{ height: 420px; }

      .tradeTable th:nth-child(4), .tradeTable td:nth-child(4){ display:none; } /* hide Amount column on small screens */

      .mobileTabs{
        display:flex;
        position: sticky;
        bottom: 0;
        z-index: 60;
        gap: 8px;
        padding: 10px 12px calc(env(safe-area-inset-bottom) + 10px);
        background: rgba(7,7,17,.72);
        border-top: 1px solid rgba(255,255,255,.08);
        backdrop-filter: blur(14px);
      }
      .mTab{
        flex:1;
        height: 42px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,.10);
        background: rgba(255,255,255,.06);
        color: rgba(255,255,255,.90);
        font-weight: 1100;
        display:flex; align-items:center; justify-content:center;
        cursor:pointer;
        user-select:none;
        -webkit-tap-highlight-color: transparent;
      }
      .mTab.active{ background: rgba(255,255,255,.10); box-shadow: 0 0 0 1px var(--netGlow) inset; }

      .mobilePane{ display:none; }
      .mobilePane.show{ display:block; }

      /* panes spacing */
      .chartCard, .tradesCard{ margin-bottom: 10px; }
    }

  </style>
</head>
<body class="net-sol">

  <header class="header">
    <div class="wrap">
      <div class="headerRow">
        <div class="brand">
          <div class="brandLogo">SOS</div>
          <div class="brandText">
            <div class="title">$SOS â€” DEX Terminal</div>
            <div class="sub">Native chart + live trades â€¢ Multi-chain</div>
          </div>
        </div>

        <div class="headerMid">
          <div id="chainToggle" class="chainToggle" role="group" aria-label="Select chain">
            <button class="chainBtn active" data-net="solana" aria-pressed="true"><span class="dot" style="background:rgba(153,69,255,.85)"></span>SOL</button>
            <button class="chainBtn" data-net="eth" aria-pressed="false"><span class="dot" style="background:rgba(98,126,234,.85)"></span>ETH</button>
            <button class="chainBtn" data-net="bsc" aria-pressed="false"><span class="dot" style="background:rgba(243,186,47,.90)"></span>BNB</button>
            <button class="chainBtn" data-net="base" aria-pressed="false"><span class="dot" style="background:rgba(0,82,255,.90)"></span>BASE</button>
          </div>
        </div>

        <div class="headerActions" style="display:flex; justify-content:flex-end; gap:10px; min-width: 240px;">
          <a class="btn" href="./" id="backBtn">Back to Main</a>
          <button class="btn icon" id="closeBtn" title="Close">âœ•</button>
          <button class="btn primary" id="buyBtn">Buy</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">

    <section class="card hotBlock" aria-label="Hot trending live">
      <div class="cardInner">
        <div class="hotRow">
          <div class="hotLabel" title="Live trending">
            <span style="display:flex; gap:10px; align-items:center;">
              <span aria-hidden="true">ðŸ”¥</span>
              <span style="font-weight:1100">Live Trending</span>
            </span>
            <span class="pill" id="trendMode">auto</span>
          </div>
          <div class="tickerWrap" aria-label="Top 10 trending">
            <div id="trendTrack" class="tickerTrack" role="list"></div>
          </div>
          <div class="hotStatus" id="trendStatus">Loadingâ€¦</div>
        </div>

        <div class="searchRow">
          <div class="searchWrap">
            <span class="icon">ðŸ”Ž</span>
            <input id="q" class="searchInput" placeholder="Search token name or paste contract (SOL / ETH / BNB / BASE)â€¦" autocomplete="off" spellcheck="false" />
            <span class="pillAuto" id="autoPill">auto</span>
          </div>
          <button class="btn" id="openBtn">Open</button>
        </div>
        <div id="res" class="resBox" aria-label="Search results"></div>

        <div class="tokenTop" id="tokenTop" style="margin-top: 14px; display:none;">
          <div class="tokenInfo">
            <div class="tokenLogoWrap" id="tokenLogoWrap"><span class="tokenLogoFallback" id="tokenLogoFallback">T</span><img id="tokenLogo" class="tokenLogo" alt="" style="display:none" /></div>
            <div class="tokenNames">
              <div class="sym" id="tokenSym">$TOKEN</div>
              <div class="name" id="tokenName">Token</div>
            </div>
          </div>
          <div class="chips">
            <div class="chip" id="chipPrice">Price â€”</div>
            <div class="chip" id="chipLiq">Liq â€”</div>
            <div class="chip" id="chipMcap">MCap â€”</div>
            <div class="chip" id="chip24h">24h â€”</div>
          </div>
        </div>

      </div>
    </section>

    <section class="grid">
      <div class="card chartCard mobilePane show" id="paneChart">
        <div class="cardInner">
          <div class="chartHead">
            <div class="tfRow" id="tfRow">
              <button class="tfBtn" data-tf="1m">1m</button>
              <button class="tfBtn" data-tf="5m">5m</button>
              <button class="tfBtn active" data-tf="15m">15m</button>
              <button class="tfBtn" data-tf="1h">1h</button>
              <button class="tfBtn" data-tf="4h">4h</button>
              <button class="tfBtn" data-tf="1d">1D</button>
              <button class="tfBtn" data-tf="ALL">ALL</button>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <span style="color:rgba(255,255,255,.65); font-weight:900; font-size:12.5px;" id="chartStatus">â€”</span>
            </div>
          </div>
          <div id="chart" class="chartArea" aria-label="Candlestick chart"></div>
          <div class="chartFoot">
            <button class="btn miniBtn" id="fitBtn">Fit</button>
            <button class="btn miniBtn" id="refreshBtn">Refresh</button>
          </div>
        </div>
      </div>

      <div class="card tradesCard mobilePane show" id="paneTrades">
        <div class="cardInner">
          <div class="tradesHead">
            <div class="tradesTitle">Live Trades</div>
            <div class="tradesStat" id="tradesStat">â€”</div>
          </div>
          <div style="max-height: 520px; overflow:auto; border-radius: 16px; border: 1px solid rgba(255,255,255,.08);">
            <table class="tradeTable">
              <thead>
                <tr>
                  <th style="width:78px">Age</th>
                  <th style="width:68px">Type</th>
                  <th style="width:90px">USD</th>
                  <th style="width:110px">Amount</th>
                  <th style="width:110px">Price</th>
                  <th>Maker</th>
                </tr>
              </thead>
              <tbody id="tradeBody">
                <tr><td colspan="6" style="padding: 14px 10px; color: rgba(255,255,255,.65)">Paste a token / choose a trending token.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <div class="mobileTabs" id="mobileTabs">
      <div class="mTab active" data-tab="chart">Chart</div>
      <div class="mTab" data-tab="trades">Trades</div>
    </div>

  </main>

  <div class="toast" id="toast"></div>

<script>
(() => {
  'use strict';

  // -------------------------- Helpers
  const $ = (id)=>document.getElementById(id);
  const esc = (s)=>String(s??'').replace(/[&<>"]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]));
  const clamp = (n,a,b)=>Math.min(b,Math.max(a,n));

  function formatCompact(n){
    n = Number(n);
    if(!Number.isFinite(n)) return 'â€”';
    const abs = Math.abs(n);
    const fmt = (v, suf)=>{
      const d = v>=100 ? 0 : v>=10 ? 1 : 2;
      return v.toFixed(d).replace(/\.0+$|0+$/,'') + suf;
    };
    if(abs>=1e12) return fmt(n/1e12,'T');
    if(abs>=1e9) return fmt(n/1e9,'B');
    if(abs>=1e6) return fmt(n/1e6,'M');
    if(abs>=1e3) return fmt(n/1e3,'K');
    return String(Math.round(n));
  }

  function timeAgo(tsMs){
    const s = Math.max(0, Math.floor((Date.now()-tsMs)/1000));
    if(s<60) return s+'s';
    const m = Math.floor(s/60);
    if(m<60) return m+'m';
    const h = Math.floor(m/60);
    if(h<24) return h+'h';
    return Math.floor(h/24)+'d';
  }

  let toastT = null;
  function toast(msg){
    const el = $('toast');
    if(!el) return;
    el.textContent = msg;
    el.classList.add('show');
    clearTimeout(toastT);
    toastT = setTimeout(()=>el.classList.remove('show'), 2200);
  }

  // -------------------------- Fetch with CORS fallbacks
  const PROXIES = [
    (url)=>`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
    (url)=>`https://cors.isomorphic-git.org/${url}`,
    (url)=>`https://corsproxy.io/?${encodeURIComponent(url)}`,
    (url)=>`https://thingproxy.freeboard.io/fetch/${url}`
  ];

  async function fetchText(url, {timeoutMs=12000, retries=1, retryBaseMs=650}={}){
    let lastErr = null;
    for(let attempt=0; attempt<=retries; attempt++){
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), timeoutMs);
      try{
        const r = await fetch(url, {signal: ctrl.signal, headers:{'accept':'application/json,text/plain,*/*'}});
        clearTimeout(t);
        if(!r.ok) throw new Error('HTTP '+r.status);
        return await r.text();
      }catch(e){
        clearTimeout(t);
        lastErr = e;
        if(attempt<retries) await new Promise(res=>setTimeout(res, retryBaseMs * Math.pow(2, attempt)));
      }
    }
    throw lastErr || new Error('Fetch failed');
  }

  async function fetchJson(url, opts={}){
    // Try direct
    try{
      const txt = await fetchText(url, opts);
      return JSON.parse(txt);
    }catch(_e1){
      // Try proxies
      let last = _e1;
      for(const p of PROXIES){
        try{
          const txt = await fetchText(p(url), {...opts, timeoutMs: Math.max(9000, (opts.timeoutMs||12000))});
          return JSON.parse(txt);
        }catch(e){ last = e; }
      }
      throw last;
    }
  }

  // -------------------------- Networks
  const NETS = {
    solana: { dexChain:'solana', gecko:'solana', label:'SOL' },
    eth:    { dexChain:'ethereum', gecko:'eth', label:'ETH' },
    bsc:    { dexChain:'bsc', gecko:'bsc', label:'BNB' },
    base:   { dexChain:'base', gecko:'base', label:'BASE' },
  };

  let activeNet = 'solana';
  let selected = null; // {chainId, baseAddr, pairAddress, symbol, name, logo}
  let poolAddr = '';

  // -------------------------- UI Elements
  const trendTrack = $('trendTrack');
  const trendStatus = $('trendStatus');
  const q = $('q');
  const res = $('res');
  const openBtn = $('openBtn');
  const autoPill = $('autoPill');

  // Token header
  const tokenTop = $('tokenTop');
  const tokenSym = $('tokenSym');
  const tokenName = $('tokenName');
  const tokenLogo = $('tokenLogo');
  const tokenLogoFallback = $('tokenLogoFallback');
  const chipPrice = $('chipPrice');
  const chipLiq = $('chipLiq');
  const chipMcap = $('chipMcap');
  const chip24h = $('chip24h');

  // Trades
  const tradeBody = $('tradeBody');
  const tradesStat = $('tradesStat');

  // Chart
  const chartEl = $('chart');
  const chartStatus = $('chartStatus');
  const fitBtn = $('fitBtn');
  const refreshBtn = $('refreshBtn');

  // -------------------------- Chain toggle
  function applyNetUI(net){
    document.body.classList.remove('net-sol','net-eth','net-bnb','net-base');
    document.body.classList.add(net==='solana'?'net-sol':net==='eth'?'net-eth':net==='bsc'?'net-bnb':'net-base');

    document.querySelectorAll('#chainToggle .chainBtn').forEach(b=>{
      const on = b.getAttribute('data-net')===net;
      b.classList.toggle('active', on);
      b.setAttribute('aria-pressed', on?'true':'false');
    });
  }

  document.querySelectorAll('#chainToggle .chainBtn').forEach(b=>{
    b.addEventListener('click', ()=>{
      const net = b.getAttribute('data-net');
      setActiveNet(net);
    });
  });

  function setActiveNet(net){
    if(!NETS[net]) net='solana';
    activeNet = net;
    applyNetUI(net);
    // trending must switch to chain immediately
    startTrending(net);
    // clear results view
    hideResults();
  }

  // -------------------------- Trending (EXACT behavior: always moving, always looping)
  const TREND_TTL = 20*60*1000;
  let trendTimer = null;
  let trendReqId = 0;

  function trendCacheKey(net){ return `sos_dex_trend_v8_${net}`; }
  function readTrendCache(net){
    try{
      const raw = localStorage.getItem(trendCacheKey(net));
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !obj.html || !obj.ts) return null;
      if(Date.now()-obj.ts > TREND_TTL) return null;
      return obj;
    }catch(_){ return null; }
  }
  function writeTrendCache(net, html){
    try{ localStorage.setItem(trendCacheKey(net), JSON.stringify({ts: Date.now(), html})); }catch(_){ }
  }

  function syncTickerMarquee(){
    try{
      if(!trendTrack) return;
      const total = trendTrack.scrollWidth || 0;
      if(total < 40) return;
      const one = Math.max(1, Math.round(total/2));
      document.documentElement.style.setProperty('--tickerDistance', one+'px');
      const isMobile = window.matchMedia('(max-width: 860px)').matches;
      const pxPerSec = isMobile ? 120 : 95;
      const dur = Math.min(22, Math.max(6.5, one/pxPerSec));
      document.documentElement.style.setProperty('--tickerSpeed', dur.toFixed(2)+'s');
    }catch(_e){}
  }

  let _tickerResizeT = null;
  window.addEventListener('resize', ()=>{
    clearTimeout(_tickerResizeT);
    _tickerResizeT = setTimeout(syncTickerMarquee, 120);
  }, {passive:true});

  async function loadTrending(net){
    const myReq = ++trendReqId;
    trendStatus.textContent = 'Loadingâ€¦';

    // show cache instantly
    const cached = readTrendCache(net);
    if(cached && (!trendTrack.innerHTML || /unavailable|loading/i.test(trendTrack.textContent||''))){
      trendTrack.innerHTML = cached.html + cached.html;
      requestAnimationFrame(syncTickerMarquee);
      trendStatus.textContent = 'Live.';
    }

    try{
      // NOTE: GeckoTerminal trending endpoint. We include page size for stability.
      const url = `https://api.geckoterminal.com/api/v2/networks/${encodeURIComponent(net)}/trending_pools?include=base_token,quote_token&page[size]=10`;
      const data = await fetchJson(url, {timeoutMs: 12000, retries: 2, retryBaseMs: 900});
      if(myReq !== trendReqId) return;

      const pools = Array.isArray(data?.data) ? data.data.slice(0,10) : [];
      const included = Array.isArray(data?.included) ? data.included : [];

      const byKey = new Map();
      for(const inc of included){
        if(!inc || !inc.id) continue;
        const id = String(inc.id);
        byKey.set(id, inc);
        if(inc.type) byKey.set(String(inc.type)+':' + id, inc);
      }

      if(!pools.length) throw new Error('No trending');

      const items = pools.map((pool, i)=>{
        const a = pool?.attributes || {};
        const rel = pool?.relationships || {};

        const baseRef = rel?.base_token?.data || null;
        const baseId = baseRef?.id ? String(baseRef.id) : '';
        const baseType = baseRef?.type ? String(baseRef.type) : '';
        const baseT = baseId ? ((byKey.get(baseType+':' + baseId) || byKey.get(baseId))?.attributes || {}) : {};

        const sym = (baseT?.symbol || baseT?.name || (a?.name? String(a.name).split('/')[0] : 'TOKEN')).trim();
        const symClean = String(sym||'TOKEN').replace(/[^a-zA-Z0-9_$\.\-]/g,'').slice(0,24) || 'TOKEN';
        const symDisp = symClean.startsWith('$') ? symClean : ('$' + symClean.replace(/^\$/,''));

        const pctRaw = ((a?.price_change_percentage && (a.price_change_percentage.h24 ?? a.price_change_percentage['h24'] ?? a.price_change_percentage['24h'])) ?? a?.price_change_percentage_24h ?? a?.price_change_percentage_h24 ?? null);
        const pctNum = (pctRaw===null || pctRaw===undefined || pctRaw==='') ? NaN : Number(pctRaw);
        const pctTxt = Number.isFinite(pctNum) ? `${pctNum>0?'+':''}${pctNum.toFixed(2)}%` : '';
        const pctCls = Number.isFinite(pctNum) ? (pctNum>0?'up':(pctNum<0?'down':'')) : '';

        let logoUrl = String(baseT?.image_url || baseT?.imageUrl || baseT?.image || baseT?.logo_url || baseT?.logoUrl || '').trim();
        if(logoUrl && logoUrl.startsWith('/')) logoUrl = 'https://www.geckoterminal.com' + logoUrl;

        const first = (symClean || 'T').slice(0,1).toUpperCase();
        const top1 = (i===0);
        const addr = (a?.address || '').trim();

        const logo = logoUrl
          ? `<span class="tickerLogoWrap"><img class="tickerLogo" src="${esc(logoUrl)}" alt="" loading="lazy" referrerpolicy="no-referrer" onerror="this.remove(); var w=this.closest('.tickerLogoWrap'); if(w){w.innerHTML='<span class=tickerLogoFallback>${esc(first)}</span>';}" /></span>`
          : `<span class="tickerLogoWrap"><span class="tickerLogoFallback">${esc(first)}</span></span>`;

        return `<button class="tickerItem${top1?' top1':''}" type="button" data-pool="${esc(addr)}" title="${esc(symDisp)}">`+
          `<span class="rank">${top1?'ðŸ”¥ #1':'#'+(i+1)}</span>`+
          logo+
          `<span class="sym">${esc(symDisp)}</span>`+
          (pctTxt ? `<span class="tickerPct ${esc(pctCls)}">${esc(pctTxt)}</span>` : '')+
        `</button>`;
      }).join('');

      // Write + duplicate for seamless loop
      writeTrendCache(net, items);
      trendTrack.innerHTML = items + items;
      requestAnimationFrame(syncTickerMarquee);
      trendStatus.textContent = 'Live.';

    }catch(e){
      if(myReq !== trendReqId) return;
      const cached2 = readTrendCache(net);
      if(cached2){
        trendTrack.innerHTML = cached2.html + cached2.html;
        requestAnimationFrame(syncTickerMarquee);
        trendStatus.textContent = 'Live.';
        toast('Trending temporarily unavailable');
      }else{
        trendTrack.innerHTML = `<span class="tickerItem" style="opacity:.75"><span class="rank">!</span><span class="sym">Trending unavailable</span></span>`;
        requestAnimationFrame(syncTickerMarquee);
        trendStatus.textContent = 'Load error.';
      }
      // self-heal retry
      setTimeout(()=>{ if(activeNet===net) loadTrending(net); }, 4500);
    }
  }

  function startTrending(net){
    clearInterval(trendTimer);
    loadTrending(net);
    trendTimer = setInterval(()=>loadTrending(net), 30000);
  }

  // Trending click => open pool
  trendTrack.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('.tickerItem');
    if(!btn) return;
    const pool = btn.getAttribute('data-pool') || '';
    if(!pool) return;
    openPool(activeNet, pool);
  });

  // -------------------------- Search (DexScreener)
  const SEARCH_DEBOUNCE = 220;
  let searchT = null;
  let searchReq = 0;

  function hideResults(){
    res.classList.remove('show');
    res.innerHTML = '';
    res.dataset.best = '';
  }

  function showResults(){
    res.classList.add('show');
  }

  function parseChainToNet(chainId){
    const c = String(chainId||'').toLowerCase();
    if(c==='solana') return 'solana';
    if(c==='ethereum' || c==='eth') return 'eth';
    if(c==='bsc' || c==='bnb') return 'bsc';
    if(c==='base') return 'base';
    return null;
  }

  async function runSearch(query){
    const qv = (query||'').trim();
    const my = ++searchReq;
    if(!qv){ hideResults(); return; }

    try{
      const data = await fetchJson(`https://api.dexscreener.com/latest/dex/search?q=${encodeURIComponent(qv)}`, {timeoutMs: 12000, retries: 1});
      if(my!==searchReq) return;
      const pairs = Array.isArray(data?.pairs) ? data.pairs : [];
      const wantNet = activeNet;

      const filtered = pairs
        .map(p=>({p, net: parseChainToNet(p?.chainId)}))
        .filter(x=>!!x.net);

      const top = filtered.slice(0, 12);
      if(!top.length){
        res.innerHTML = `<div class="resRow" style="opacity:.75"><div class="resLeft"><div class="resLogoWrap"><span class="resLogoFallback">?</span></div><div><div class="resTitle">No results</div><div class="resMeta">Try symbol, name, or paste a contract.</div></div></div></div>`;
        showResults();
        res.dataset.best = '';
        return;
      }

      // pick best for current chain by liquidity then mcap
      const bestForChain = top
        .filter(x=>x.net===wantNet)
        .sort((a,b)=> (Number(b.p?.liquidity?.usd||0)-Number(a.p?.liquidity?.usd||0)) || (Number(b.p?.marketCap||b.p?.fdv||0)-Number(a.p?.marketCap||a.p?.fdv||0)) )[0] || top[0];
      res.dataset.best = JSON.stringify(bestForChain.p);

      res.innerHTML = top.map(({p,net})=>{
        const baseSym = p?.baseToken?.symbol || 'TOKEN';
        const baseName = p?.baseToken?.name || baseSym;
        const quoteSym = p?.quoteToken?.symbol || '';
        const title = quoteSym ? `${baseSym}/${quoteSym}` : `${baseSym}`;
        const logoUrl = p?.info?.imageUrl || p?.info?.image || p?.baseToken?.logoURI || '';
        const ch24 = p?.priceChange?.h24;
        const chTxt = (typeof ch24==='number') ? `${ch24>0?'+':''}${ch24.toFixed(2)}%` : 'â€”';
        const chClass = (typeof ch24==='number') ? (ch24>0?'up':(ch24<0?'down':'')) : '';
        const mcapVal = (p?.marketCap!=null ? Number(p.marketCap) : (p?.fdv!=null ? Number(p.fdv) : NaN));
        const mcapTxt = Number.isFinite(mcapVal) ? '$'+formatCompact(mcapVal) : 'â€”';

        const first = (baseSym||'T').slice(0,1).toUpperCase();
        return `<div class="resRow" data-p='${esc(JSON.stringify(p))}'>
          <div class="resLeft">
            <div class="resLogoWrap ${logoUrl?'':'noimg'}">
              ${logoUrl ? `<img class="resLogo" src="${esc(logoUrl)}" alt="" loading="lazy" referrerpolicy="no-referrer" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">` : ''}
              <span class="resLogoFallback" style="display:${logoUrl?'none':'block'}">${esc(first)}</span>
            </div>
            <div style="min-width:0">
              <div class="resTitle">${esc(title)}</div>
              <div class="resMeta">${esc(baseName)} â€¢ ${esc(String(p?.dexId||'DEX'))}</div>
            </div>
          </div>
          <div class="resRight">
            <span class="pill" style="color: var(--netColor)">${esc(NETS[net].label)}</span>
            <span class="pill ${esc(chClass)}">24h ${esc(chTxt)}</span>
            <span class="pill">MCap ${esc(mcapTxt)}</span>
          </div>
        </div>`;
      }).join('');

      showResults();

    }catch(e){
      if(my!==searchReq) return;
      res.innerHTML = `<div class="resRow" style="opacity:.75"><div class="resLeft"><div class="resLogoWrap"><span class="resLogoFallback">!</span></div><div><div class="resTitle">Search error</div><div class="resMeta">Temporary network / CORS issue. Try again.</div></div></div></div>`;
      showResults();
    }
  }

  q.addEventListener('input', ()=>{
    clearTimeout(searchT);
    searchT = setTimeout(()=>runSearch(q.value), SEARCH_DEBOUNCE);
  });

  document.addEventListener('click', (ev)=>{
    if(ev.target.closest('.searchRow') || ev.target.closest('#res')) return;
    hideResults();
  });

  res.addEventListener('click', (ev)=>{
    const row = ev.target.closest('.resRow');
    if(!row) return;
    const raw = row.getAttribute('data-p');
    if(!raw) return;
    try{
      const p = JSON.parse(raw);
      openFromDexPair(p);
      hideResults();
    }catch(_e){}
  });

  openBtn.addEventListener('click', ()=>{
    if(res.dataset.best){
      try{
        const p = JSON.parse(res.dataset.best);
        openFromDexPair(p);
        hideResults();
        return;
      }catch(_e){}
    }
    // If user pasted CA and there is no dropdown, attempt open directly
    const raw = (q.value||'').trim();
    if(raw) openByAddressGuess(raw);
  });

  // -------------------------- Pool resolution + meta
  const GECKO = 'https://api.geckoterminal.com/api/v2';

  function geckoNet(){
    return NETS[activeNet].gecko;
  }

  function setTokenHeader({symbol, name, logoUrl, priceUsd, liqUsd, mcapUsd, ch24}){
    tokenTop.style.display = 'flex';

    const symClean = (symbol||'TOKEN').trim();
    tokenSym.textContent = symClean.startsWith('$') ? symClean : ('$'+symClean.replace(/^\$/,''));
    tokenName.textContent = (name||'').trim() || symClean;

    const first = (symClean||'T').slice(0,1).toUpperCase();
    tokenLogoFallback.textContent = first;
    tokenLogo.style.display = 'none';

    if(logoUrl){
      tokenLogo.src = logoUrl;
      tokenLogo.onload = ()=>{ tokenLogo.style.display='block'; };
      tokenLogo.onerror = ()=>{ tokenLogo.style.display='none'; };
    }

    chipPrice.textContent = 'Price ' + (priceUsd!=null ? ('$'+Number(priceUsd).toLocaleString(undefined,{maximumFractionDigits:8})) : 'â€”');
    chipLiq.textContent = 'Liq ' + (liqUsd!=null ? ('$'+formatCompact(liqUsd)) : 'â€”');
    chipMcap.textContent = 'MCap ' + (mcapUsd!=null ? ('$'+formatCompact(mcapUsd)) : 'â€”');

    if(typeof ch24==='number' && Number.isFinite(ch24)){
      chip24h.textContent = '24h ' + (ch24>0?'+':'') + ch24.toFixed(2) + '%';
      chip24h.classList.remove('positive','negative');
      chip24h.classList.add(ch24>0?'positive':(ch24<0?'negative':''));
    }else{
      chip24h.textContent = '24h â€”';
      chip24h.classList.remove('positive','negative');
    }
  }

  async function openFromDexPair(p){
    const net = parseChainToNet(p?.chainId);
    if(!net) return toast('Unsupported chain');
    setActiveNet(net);

    selected = {
      chainId: p?.chainId,
      baseAddr: p?.baseToken?.address || '',
      pairAddress: p?.pairAddress || '',
      symbol: p?.baseToken?.symbol || '',
      name: p?.baseToken?.name || '',
      logo: p?.info?.imageUrl || p?.info?.image || p?.baseToken?.logoURI || ''
    };

    // show header instantly with Dex data
    setTokenHeader({
      symbol: selected.symbol,
      name: selected.name,
      logoUrl: selected.logo,
      priceUsd: p?.priceUsd ? Number(p.priceUsd) : null,
      liqUsd: p?.liquidity?.usd != null ? Number(p.liquidity.usd) : null,
      mcapUsd: p?.marketCap != null ? Number(p.marketCap) : (p?.fdv!=null?Number(p.fdv):null),
      ch24: (typeof p?.priceChange?.h24==='number') ? p.priceChange.h24 : null
    });

    // resolve pool on Gecko
    try{
      const resolved = await resolveBestPool(net, selected.baseAddr, selected.pairAddress);
      poolAddr = resolved.pool;
      // load chart + trades
      await bootstrapToken();
    }catch(e){
      console.error(e);
      toast('Failed to resolve pool (API/CORS).');
    }
  }

  async function openPool(net, pool){
    setActiveNet(net);
    selected = null;
    poolAddr = pool;
    // fetch pool meta and derive token fields
    await bootstrapToken();
  }

  async function openByAddressGuess(raw){
    const addr = raw.trim();
    // Attempt dex token-pairs for the chain currently selected
    const dexChain = NETS[activeNet].dexChain;
    try{
      const pairs = await fetchJson(`https://api.dexscreener.com/token-pairs/v1/${encodeURIComponent(dexChain)}/${encodeURIComponent(addr)}`, {timeoutMs: 12000, retries: 1});
      const p = Array.isArray(pairs) ? pairs[0] : null;
      if(p) return openFromDexPair(p);
    }catch(_e){}
    // fallback: search
    q.value = addr;
    runSearch(addr);
    toast('Select a result');
  }

  async function resolveBestPool(net, tokenAddr, pairAddrHint){
    // 1) If we have a pairAddress from DexScreener, try that as pool address.
    if(pairAddrHint){
      try{
        const j = await fetchJson(`${GECKO}/networks/${encodeURIComponent(NETS[net].gecko)}/pools/${encodeURIComponent(pairAddrHint)}?include=base_token,quote_token`, {timeoutMs: 12000, retries: 1});
        if(j?.data?.attributes?.address) return {pool: j.data.attributes.address};
      }catch(_e){}
    }

    // 2) Token pools endpoint
    const url = `${GECKO}/networks/${encodeURIComponent(NETS[net].gecko)}/tokens/${encodeURIComponent(tokenAddr)}/pools?include=base_token,quote_token&page[size]=25`;
    const j = await fetchJson(url, {timeoutMs: 12000, retries: 2});
    const pools = Array.isArray(j?.data) ? j.data : [];
    if(!pools.length) throw new Error('No pools');

    // best by reserve_usd / volume
    const scored = pools.map(p=>{
      const a = p?.attributes||{};
      const liq = Number(a?.reserve_in_usd||0);
      const vol = Number(a?.volume_usd?.h24||a?.volume_usd_24h||0);
      return {p, score: liq*2 + vol};
    }).sort((a,b)=>b.score-a.score);

    const best = scored[0].p;
    const addr = best?.attributes?.address || best?.id || '';
    if(!addr) throw new Error('Bad pool');
    return {pool: addr};
  }

  async function fetchPoolMeta(){
    const net = geckoNet();
    const j = await fetchJson(`${GECKO}/networks/${encodeURIComponent(net)}/pools/${encodeURIComponent(poolAddr)}?include=base_token,quote_token`, {timeoutMs: 12000, retries: 2});
    return j;
  }

  function extractIncludedMap(included){
    const m = new Map();
    for(const inc of (included||[])){
      if(!inc || !inc.id) continue;
      m.set(String(inc.id), inc);
      if(inc.type) m.set(String(inc.type)+':'+String(inc.id), inc);
    }
    return m;
  }

  // -------------------------- Chart (lightweight-charts)
  let chart = null;
  let candleSeries = null;
  let volumeSeries = null;
  let rawCandles = [];

  const TF = {
    '1m': {tf:'minute', agg: 60, maxBars: 900},
    '5m': {tf:'minute', agg: 300, maxBars: 1200},
    '15m': {tf:'minute', agg: 900, maxBars: 1500},
    '1h': {tf:'hour', agg: 3600, maxBars: 2000},
    '4h': {tf:'hour', agg: 14400, maxBars: 2600},
    '1d': {tf:'day', agg: 86400, maxBars: 4000},
    'ALL': {tf:'hour', agg: 14400, maxBars: 5000},
  };
  let activeTFKey = '15m';
  let pollTradesTimer = null;
  let pollMetaTimer = null;

  function ensureChart(){
    if(chart) return;
    chart = LightweightCharts.createChart(chartEl, {
      layout: { background: { type: 'solid', color: 'rgba(0,0,0,0)' }, textColor: 'rgba(255,255,255,.78)' },
      grid: { vertLines: { color: 'rgba(255,255,255,.06)' }, horzLines: { color: 'rgba(255,255,255,.06)' } },
      rightPriceScale: { borderColor: 'rgba(255,255,255,.10)' },
      timeScale: { borderColor: 'rgba(255,255,255,.10)' },
      crosshair: { mode: 1 },
      handleScroll: { mouseWheel: true, pressedMouseMove: true, horzTouchDrag: true, vertTouchDrag: true },
      handleScale: { axisPressedMouseMove: true, mouseWheel: true, pinch: true },
    });

    candleSeries = chart.addCandlestickSeries({
      upColor: 'rgba(20,241,149,.95)',
      downColor: 'rgba(255,77,109,.95)',
      borderVisible: false,
      wickUpColor: 'rgba(20,241,149,.95)',
      wickDownColor: 'rgba(255,77,109,.95)',
    });

    volumeSeries = chart.addHistogramSeries({
      priceFormat: { type: 'volume' },
      priceScaleId: '',
      scaleMargins: { top: 0.80, bottom: 0 },
    });

    const ro = new ResizeObserver(()=>{
      chart.applyOptions({ width: chartEl.clientWidth, height: chartEl.clientHeight });
    });
    ro.observe(chartEl);
  }

  async function fetchOhlcvPage({net, pool, tfKey, beforeTs=null, limit=1000}){
    const cfg = TF[tfKey];
    const timeframe = cfg.tf;
    const agg = cfg.agg;

    const params = new URLSearchParams();
    params.set('aggregate', String(agg));
    params.set('limit', String(clamp(limit, 1, 1000)));
    if(beforeTs) params.set('before_timestamp', String(beforeTs));

    const url = `${GECKO}/networks/${encodeURIComponent(net)}/pools/${encodeURIComponent(pool)}/ohlcv/${encodeURIComponent(timeframe)}?${params.toString()}`;
    return await fetchJson(url, {timeoutMs: 14000, retries: 2, retryBaseMs: 900});
  }

  function toCandle(row){
    // GeckoTerminal OHLCV usually: [timestamp, open, high, low, close, volume]
    const t = Number(row?.[0]);
    if(!Number.isFinite(t)) return null;
    const ts = Math.floor(t);
    const o = Number(row?.[1]);
    const h = Number(row?.[2]);
    const l = Number(row?.[3]);
    const c = Number(row?.[4]);
    const v = Number(row?.[5] ?? 0);
    if(![o,h,l,c].every(Number.isFinite)) return null;
    return { time: ts, open:o, high:h, low:l, close:c, volume: Number.isFinite(v)?v:0 };
  }

  async function loadCandlesFull(){
    if(!poolAddr) return;
    ensureChart();

    const net = geckoNet();
    const cfg = TF[activeTFKey];

    chartStatus.textContent = 'Loading candlesâ€¦';

    const want = cfg.maxBars;
    let all = [];
    let before = null;
    let guard = 0;

    while(all.length < want && guard < 12){
      guard += 1;
      const j = await fetchOhlcvPage({net, pool: poolAddr, tfKey: activeTFKey, beforeTs: before, limit: 1000});
      const rows = j?.data?.attributes?.ohlcv_list || j?.data?.attributes?.ohlcv_list || j?.data?.attributes?.ohlcv_list;
      const list = Array.isArray(rows) ? rows : (Array.isArray(j?.data?.attributes?.ohlcv_list) ? j.data.attributes.ohlcv_list : []);
      if(!list.length) break;

      const candles = list.map(toCandle).filter(Boolean);
      if(!candles.length) break;

      // Gecko returns newest->oldest usually. Normalize.
      candles.sort((a,b)=>a.time-b.time);

      // prepend older to front
      all = candles.concat(all);

      // next page: before oldest time
      before = candles[0].time;

      // stop if repeating
      if(all.length && before <= all[0].time) break;

      // throttle
      await new Promise(r=>setTimeout(r, 120));
    }

    // unique + sort
    const map = new Map();
    for(const c of all){ map.set(c.time, c); }
    const merged = Array.from(map.values()).sort((a,b)=>a.time-b.time);

    rawCandles = merged;

    candleSeries.setData(merged.map(c=>({time:c.time, open:c.open, high:c.high, low:c.low, close:c.close})));
    volumeSeries.setData(merged.map(c=>({time:c.time, value:c.volume, color:(c.close>=c.open)?'rgba(20,241,149,.35)':'rgba(255,77,109,.35)'})));

    chart.timeScale().fitContent();
    chartStatus.textContent = 'Live.';
  }

  fitBtn.addEventListener('click', ()=>{ try{ chart?.timeScale()?.fitContent(); }catch(_e){} });
  refreshBtn.addEventListener('click', ()=>{ if(poolAddr) bootstrapToken(true); });

  // timeframe buttons
  document.querySelectorAll('.tfBtn').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.tfBtn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      activeTFKey = b.getAttribute('data-tf');
      if(poolAddr) bootstrapToken(true);
    });
  });

  // -------------------------- Trades (live)
  const tradesSeen = new Set();

  async function geckoTrades(limit=60){
    const net = geckoNet();
    const url = `${GECKO}/networks/${encodeURIComponent(net)}/pools/${encodeURIComponent(poolAddr)}/trades?page[size]=${encodeURIComponent(String(clamp(limit,1,100)))}&include=tx,token`;
    return await fetchJson(url, {timeoutMs: 12000, retries: 2, retryBaseMs: 900});
  }

  function normalizeTrade(t){
    const a = t?.attributes || {};
    const ts = a?.block_timestamp || a?.timestamp || a?.created_at || a?.time || null;
    let tsMs = null;
    if(typeof ts==='number') tsMs = ts>1e12 ? ts : ts*1000;
    else if(typeof ts==='string') tsMs = Date.parse(ts);
    if(!tsMs) tsMs = Date.now();

    const price = Number(a?.price_in_usd || a?.price_usd || a?.price || a?.price_in_quote || NaN);
    const usd = Number(a?.volume_in_usd || a?.amount_in_usd || a?.total_in_usd || a?.trade_volume_in_usd || NaN);

    // direction fields vary; try common keys
    const kind = String(a?.kind || a?.trade_type || a?.side || a?.type || '').toLowerCase();
    const isBuy = kind.includes('buy');
    const isSell = kind.includes('sell');

    const maker = String(a?.tx_from_address || a?.maker || a?.taker || a?.buyer || a?.seller || '');

    // base/quote amounts
    const amount = Number(a?.base_token_amount || a?.base_amount || a?.token_amount || a?.amount || a?.volume || NaN);

    return {
      id: String(t?.id || a?.tx_hash || tsMs + ':' + price),
      tsMs,
      kind: isBuy ? 'buy' : (isSell ? 'sell' : (usd>=0 ? 'buy' : 'sell')),
      usd: Number.isFinite(usd) ? usd : null,
      amount: Number.isFinite(amount) ? amount : null,
      price: Number.isFinite(price) ? price : null,
      maker,
    };
  }

  function tradeRow(tr){
    const age = timeAgo(tr.tsMs);
    const type = tr.kind==='buy' ? 'Buy' : 'Sell';
    const typeCls = tr.kind==='buy' ? 'typeBuy' : 'typeSell';
    const usd = tr.usd!=null ? '$'+(tr.usd>=1000?formatCompact(tr.usd):tr.usd.toFixed(2)) : 'â€”';
    const amt = tr.amount!=null ? formatCompact(tr.amount) : 'â€”';
    const price = tr.price!=null ? '$'+tr.price.toLocaleString(undefined,{maximumFractionDigits:10}) : 'â€”';
    const makerShort = tr.maker ? (tr.maker.slice(0,4)+'â€¦'+tr.maker.slice(-4)) : 'â€”';
    return `<tr data-id="${esc(tr.id)}" data-ts="${esc(String(tr.tsMs))}">
      <td class="addr">${esc(age)}</td>
      <td class="${typeCls}">${esc(type)}</td>
      <td>${esc(usd)}</td>
      <td>${esc(amt)}</td>
      <td>${esc(price)}</td>
      <td class="addr" title="${esc(tr.maker||'')}">${esc(makerShort)}</td>
    </tr>`;
  }

  function updateAgeCells(){
    document.querySelectorAll('#tradeBody tr[data-ts]').forEach(row=>{
      const ts = Number(row.getAttribute('data-ts')||0);
      const cell = row.querySelector('td');
      if(cell && ts) cell.textContent = timeAgo(ts);
    });
  }

  function applyTradeToCandles(tr){
    if(!rawCandles || !rawCandles.length) return;
    if(!Number.isFinite(tr.price)) return;
    const cfg = TF[activeTFKey];
    const bucket = Math.floor((tr.tsMs/1000) / cfg.agg) * cfg.agg;

    const last = rawCandles[rawCandles.length-1];
    const usdVol = Number.isFinite(tr.usd) ? tr.usd : 0;

    if(bucket < last.time - cfg.agg*5) return;

    if(bucket === last.time){
      last.close = tr.price;
      last.high = Math.max(last.high, tr.price);
      last.low = Math.min(last.low, tr.price);
      last.volume = (Number(last.volume)||0) + usdVol;
      candleSeries.update({time:last.time, open:last.open, high:last.high, low:last.low, close:last.close});
      volumeSeries.update({time:last.time, value:last.volume, color:(last.close>=last.open)?'rgba(20,241,149,.35)':'rgba(255,77,109,.35)'});
      return;
    }

    if(bucket > last.time){
      const open = Number.isFinite(last.close) ? last.close : tr.price;
      const close = tr.price;
      const high = Math.max(open, close);
      const low = Math.min(open, close);
      const c = {time: bucket, open, high, low, close, volume: usdVol};
      rawCandles.push(c);
      candleSeries.update({time:c.time, open:c.open, high:c.high, low:c.low, close:c.close});
      volumeSeries.update({time:c.time, value:c.volume, color:(c.close>=c.open)?'rgba(20,241,149,.35)':'rgba(255,77,109,.35)'});
    }
  }

  async function loadTrades(reset=false){
    if(!poolAddr) return;
    try{
      const j = await geckoTrades(80);
      const list = Array.isArray(j?.data) ? j.data : [];
      const parsed = list.map(normalizeTrade).filter(t=>t.id);

      // newest first
      parsed.sort((a,b)=>b.tsMs-a.tsMs);

      if(reset){
        tradesSeen.clear();
        tradeBody.innerHTML = '';
      }

      let added = 0;
      const newly = [];
      for(const tr of parsed){
        if(tradesSeen.has(tr.id)) continue;
        tradesSeen.add(tr.id);
        newly.push(tr);
      }

      // apply oldest->newest to candles for correctness
      newly.slice().sort((a,b)=>a.tsMs-b.tsMs).forEach(applyTradeToCandles);

      // render newest on top
      if(newly.length){
        const html = newly.sort((a,b)=>b.tsMs-a.tsMs).map(tradeRow).join('');
        const tmp = document.createElement('tbody');
        tmp.innerHTML = html;
        // prepend
        tradeBody.prepend(...Array.from(tmp.children));
        added = newly.length;
      }

      // cap rows
      const rows = tradeBody.querySelectorAll('tr[data-id]');
      if(rows.length > 120){
        Array.from(rows).slice(120).forEach(r=>r.remove());
      }

      const total = tradeBody.querySelectorAll('tr[data-id]').length;
      tradesStat.textContent = total ? `${total} trades` : '0 trades';

      if(!total){
        tradeBody.innerHTML = `<tr><td colspan="6" style="padding: 14px 10px; color: rgba(255,255,255,.65)">No recent trades found.</td></tr>`;
      }

      updateAgeCells();
      return added;

    }catch(e){
      console.error(e);
      tradesStat.textContent = 'Trades error.';
    }
  }

  // -------------------------- Meta refresh
  async function loadMeta(){
    if(!poolAddr) return;
    try{
      const net = geckoNet();
      const j = await fetchJson(`${GECKO}/networks/${encodeURIComponent(net)}/pools/${encodeURIComponent(poolAddr)}?include=base_token,quote_token`, {timeoutMs: 12000, retries: 1});
      const data = j?.data;
      if(!data) return;
      const a = data.attributes || {};
      const inc = extractIncludedMap(j?.included);
      const rel = data.relationships || {};
      const baseRef = rel?.base_token?.data;
      const base = baseRef ? (inc.get(baseRef.type+':'+baseRef.id)?.attributes || {}) : {};

      const symbol = (base?.symbol || selected?.symbol || 'TOKEN');
      const name = (base?.name || selected?.name || symbol);
      let logoUrl = String(base?.image_url || base?.image || selected?.logo || '').trim();
      if(logoUrl && logoUrl.startsWith('/')) logoUrl = 'https://www.geckoterminal.com'+logoUrl;

      const priceUsd = a?.base_token_price_usd != null ? Number(a.base_token_price_usd) : (a?.price_in_usd!=null?Number(a.price_in_usd):null);
      const liqUsd = a?.reserve_in_usd != null ? Number(a.reserve_in_usd) : null;
      const mcapUsd = a?.market_cap_usd != null ? Number(a.market_cap_usd) : (a?.fdv_usd!=null?Number(a.fdv_usd):null);

      const pctRaw = (a?.price_change_percentage && (a.price_change_percentage.h24 ?? a.price_change_percentage['h24'] ?? a.price_change_percentage['24h']))
        ?? a?.price_change_percentage_24h ?? null;
      const ch24 = (pctRaw==null ? null : Number(pctRaw));

      setTokenHeader({symbol,name,logoUrl,priceUsd,liqUsd,mcapUsd,ch24});

    }catch(_e){}
  }

  // -------------------------- Bootstrap token
  async function bootstrapToken(force=false){
    if(!poolAddr) return;

    // reset UI
    chartStatus.textContent = 'Loadingâ€¦';
    tradesStat.textContent = 'Loadingâ€¦';

    try{
      // Always load meta first so token name/logo is correct
      await loadMeta();

      // candles
      await loadCandlesFull();

      // trades
      await loadTrades(true);

      clearInterval(pollTradesTimer);
      clearInterval(pollMetaTimer);
      pollTradesTimer = setInterval(()=>loadTrades(false), 2500);
      pollMetaTimer = setInterval(()=>loadMeta(), 8000);

      setInterval(updateAgeCells, 1500);

    }catch(e){
      console.error(e);
      chartStatus.textContent = 'Load error.';
      toast('Failed to load chart/trades. API blocked or pool unsupported.');
    }
  }

  // -------------------------- Mobile tabs
  const mobileTabs = $('mobileTabs');
  function updateMobileTabs(){
    if(window.matchMedia('(max-width: 980px)').matches){
      mobileTabs.style.display = 'flex';
      // start chart visible
      showPane('chart');
    }else{
      mobileTabs.style.display = 'none';
      $('paneChart').classList.add('show');
      $('paneTrades').classList.add('show');
    }
  }

  function showPane(which){
    const pc = $('paneChart');
    const pt = $('paneTrades');
    if(which==='chart'){
      pc.classList.add('show');
      pt.classList.remove('show');
    }else{
      pt.classList.add('show');
      pc.classList.remove('show');
    }

    document.querySelectorAll('.mTab').forEach(t=>{
      t.classList.toggle('active', t.getAttribute('data-tab')===which);
    });
  }

  document.querySelectorAll('.mTab').forEach(t=>{
    t.addEventListener('click', ()=>showPane(t.getAttribute('data-tab')));
  });

  window.addEventListener('resize', updateMobileTabs, {passive:true});

  // -------------------------- Buttons
  $('closeBtn').addEventListener('click', ()=>{
    // simple close: scroll top + clear token
    q.value='';
    hideResults();
    poolAddr='';
    selected=null;
    tokenTop.style.display='none';
    chartStatus.textContent='â€”';
    chartEl.innerHTML='';
    chart=null; candleSeries=null; volumeSeries=null; rawCandles=[];
    tradeBody.innerHTML = `<tr><td colspan="6" style="padding: 14px 10px; color: rgba(255,255,255,.65)">Paste a token / choose a trending token.</td></tr>`;
    tradesStat.textContent='â€”';
    toast('Closed');
  });

  $('buyBtn').addEventListener('click', ()=>{
    toast('Add your Buy routing here');
  });

  // -------------------------- Init
  updateMobileTabs();
  setActiveNet('solana');

})();
</script>

</body>
</html>
