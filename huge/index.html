<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DexGuard — No Birdeye (Solana live via Helius)</title>
  <style>
    :root { color-scheme: dark; --bg:#0b0f14; --panel:#101722; --muted:#9fb0c3; --fg:#e7edf4; --acc:#f5c84c; --red:#ff4d4f; --green:#2ecc71; }
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.35 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 14px;background:linear-gradient(180deg,#0f151f,#0b0f14);border-bottom:1px solid rgba(255,255,255,.06);position:sticky;top:0;z-index:50}
    .brand{display:flex;gap:10px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--acc);box-shadow:0 0 0 4px rgba(245,200,76,.08)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button{background:var(--panel);color:var(--fg);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:10px 12px;outline:none}
    input{min-width:320px}
    button{cursor:pointer}
    button.primary{border-color:rgba(245,200,76,.35);}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:12px;padding:12px}
    @media (max-width:980px){.grid{grid-template-columns:1fr} input{min-width:0;width:100%}}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px}
    .kpis{display:flex;gap:12px;flex-wrap:wrap}
    .kpi{min-width:140px}
    .kpi .l{color:var(--muted);font-size:12px}
    .kpi .v{font-size:16px;font-weight:700;margin-top:4px}
    .muted{color:var(--muted)}
    .warn{color:var(--acc)}
    .err{color:var(--red)}
    .ok{color:var(--green)}
    .tbl{width:100%;border-collapse:collapse;margin-top:8px}
    .tbl th,.tbl td{padding:8px 6px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;font-size:12px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);color:var(--muted);font-size:11px}
    #chart{height:360px}
    .small{font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="brand"><span class="dot"></span><div><div style="font-weight:800">DexGuard</div><div class="muted small">No Birdeye — Live SOL trades via Helius + DexScreener price</div></div></div>
    <div class="row">
      <select id="chain">
        <option value="solana" selected>SOL</option>
        <option value="ethereum">ETH (price only)</option>
        <option value="bsc">BNB (price only)</option>
        <option value="base">BASE (price only)</option>
      </select>
      <input id="worker" placeholder="Worker base URL (e.g. https://xxxx.workers.dev)" />
      <input id="mint" placeholder="Token address/mint" /><input id="pair" placeholder="Pair/Pool (optional)" />
      <button id="btnLoad" class="primary">Load</button>
    </div>
  </header>

  <div class="grid">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <div id="title" style="font-weight:800;font-size:16px">—</div>
          <div class="muted small" id="subtitle">—</div>
        </div>
        <div class="row">
          <span class="pill" id="srcPrice">price: —</span>
          <span class="pill" id="srcTrades">trades: —</span>
          <span class="pill" id="srcCandles">candles: —</span>
        </div>
      </div>
      <div class="kpis" style="margin-top:10px">
        <div class="kpi"><div class="l">Price (USD)</div><div class="v" id="kpiPrice">—</div></div>
        <div class="kpi"><div class="l">Last Trade</div><div class="v" id="kpiLast">—</div></div>
        <div class="kpi"><div class="l">Status</div><div class="v" id="kpiStatus">—</div></div>
      </div>
      <div style="margin-top:10px" class="muted small">Chart is a lightweight placeholder here (your main Dex UI can keep using lightweight-charts). This page is for API verification without Birdeye.</div>
      <div id="chart" class="card" style="margin-top:10px;background:#0b0f14;border-style:dashed;border-color:rgba(255,255,255,.15)">
        <div class="muted" style="padding:14px">(Use your main app chart. If you want, I can patch your main HTML to read /api/candles + /api/trades from this worker.)</div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:800">Live Trades</div>
      <div class="muted small">Solana only (needs HELIUS_API_KEY in Worker env)</div>
      <table class="tbl" id="tradesTbl">
        <thead><tr><th>Time</th><th>Side</th><th>Price</th><th>USD</th><th>TX</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  const state = {
    chain: 'solana',
    address: '',
    timer: null,
    workerBase: '',
    pair: '',
  };

  
  // ----- setters (were missing in v1.3.2) -----
  function dgNormalizeBase(u){
    u = String(u || '').trim();
    if (!u) return '';
    // strip trailing slash
    while (u.endsWith('/')) u = u.slice(0, -1);
    return u;
  }
  function dgSetWorkerBase(u){
    const base = dgNormalizeBase(u);
    state.workerBase = base;
    try { localStorage.setItem('dg_worker_base', base); } catch(_){}
    const el = document.getElementById('worker');
    if (el && el.value !== base) el.value = base;
    return base;
  }
  function dgSetChain(c){
    c = String(c || 'solana').trim().toLowerCase();
    if (c === 'eth') c = 'ethereum';
    if (c === 'bnb') c = 'bsc';
    state.chain = c || 'solana';
    try { localStorage.setItem('dg_chain', state.chain); } catch(_){}
    const el = document.getElementById('chain');
    if (el && el.value !== state.chain) el.value = state.chain;
    return state.chain;
  }
  function dgSetAddr(a){
    a = String(a || '').trim();
    state.address = a;
    try { localStorage.setItem('dg_addr', a); } catch(_){}
    const el = document.getElementById('mint');
    if (el && el.value !== a) el.value = a;
    return a;
  }

function fmtNum(x, d=8){
    const n = Number(x);
    if(!isFinite(n)) return '—';
    return n.toLocaleString(undefined,{maximumFractionDigits:d});
  }

  function fmtTime(sec){
    if(!sec) return '—';
    const dt = new Date(sec*1000);
    return dt.toLocaleTimeString();
  }

  function shortTx(s){
    if(!s) return '—';
    return s.slice(0,6)+'…'+s.slice(-6);
  }

  function setStatus(msg, cls){
    const el = $('kpiStatus');
    el.textContent = msg;
    el.className = 'v ' + (cls||'');
  }

  async async function api(path){
    const base = state.workerBase || location.origin;
    const url = base.replace(/\/$/,'') + path;
    const res = await fetch(url, { cache: 'no-store' });
    const j = await res.json().catch(()=>null);
    return { res, j, url };
  }

  async function refreshOnce(){
    if(!state.address) return;
    const chain = state.chain;
    const addr = state.address;
    const pairParam = state.pair ? `&pair=${encodeURIComponent(state.pair)}` : '';

    // price
    try{
      const r = await api(`/api/price?chain=${encodeURIComponent(chain)}&address=${encodeURIComponent(addr)}${pairParam}`);
      if(!state.pair && r.j?.pair) state.pair = r.j.pair;
      $('srcPrice').textContent = 'price: ' + (r.j?.source || '—');
      $('kpiPrice').textContent = fmtNum(r.j?.price, 10);
    }catch(e){
      $('srcPrice').textContent = 'price: error';
    }

    // trades
    try{
      const r = await api(`/api/trades?chain=${encodeURIComponent(chain)}&address=${encodeURIComponent(addr)}${pairParam}&limit=30`);
      if(!state.pair && r.j?.pair) state.pair = r.j.pair;
      $('srcTrades').textContent = 'trades: ' + (r.j?.source || '—');
      const items = Array.isArray(r.j?.items) ? r.j.items : [];
      $('kpiLast').textContent = items[0]?.price ? fmtNum(items[0].price, 10) : '—';

      const tb = $('tradesTbl').querySelector('tbody');
      tb.innerHTML = '';
      for(const tr of items.slice(0,30)){
        const trEl = document.createElement('tr');
        const side = (tr.side||'').toLowerCase();
        trEl.innerHTML = `
          <td class="muted">${fmtTime(tr.t)}</td>
          <td class="${side==='buy'?'ok':side==='sell'?'err':'muted'}">${(tr.side||'—').toUpperCase()}</td>
          <td>${fmtNum(tr.price, 10)}</td>
          <td class="muted">${fmtNum(tr.usd, 2)}</td>
          <td class="muted">${shortTx(tr.tx)}</td>
        `;
        tb.appendChild(trEl);
      }

      if(chain !== 'solana'){
        setStatus('EVM chains: price only (no free live trades).', 'warn');
      } else if(r.j?.source === 'missing_helius_key'){
        setStatus('Missing HELIUS_API_KEY in Worker env.', 'err');
      } else {
        setStatus('OK', 'ok');
      }
    }catch(e){
      $('srcTrades').textContent = 'trades: error';
      setStatus('Error fetching trades', 'err');
    }

    // candles (smoke test)
    try{
      const now = Math.floor(Date.now()/1000);
      const r = await api(`/api/candles?chain=${encodeURIComponent(chain)}&address=${encodeURIComponent(addr)}${pairParam}&tf=15m&limit=60&to=${now}`);
      $('srcCandles').textContent = 'candles: ' + (r.j?.source || '—') + ' ('+(r.j?.count ?? '0')+')';
    }catch(e){
      $('srcCandles').textContent = 'candles: error';
    }
  }

  async function start(){
    if(state.timer) clearInterval(state.timer);

    // Resolve best pair so /api/price|candles|trades can work reliably
    state.pair = '';
    try{
      const tp = await api(`/api/token-pairs?chain=${encodeURIComponent(state.chain)}&address=${encodeURIComponent(state.address)}`);
      const items = Array.isArray(tp?.j?.items) ? tp.j.items : [];
      if(items.length){
        items.sort((a,b)=>(Number(b.liquidityUsd||0)-Number(a.liquidityUsd||0)));
        state.pair = items[0]?.pairAddress || '';
      }
    }catch(_){
      state.pair = '';
    }

    await refreshOnce();
    state.timer = setInterval(refreshOnce, 3000);
  }

  
  // Autofill worker base URL (from ?worker=, localStorage, or if hosted on workers.dev)
  try {
    const guess = dgGuessWorkerBase();
    if (!$('worker').value.trim() && guess) $('worker').value = guess;
    if ($('worker').value.trim()) dgSetWorkerBase($('worker').value.trim());
    $('worker').addEventListener('input', ()=> dgSetWorkerBase($('worker').value.trim()));
  } catch(_) {}

  $('chain').addEventListener('change', ()=>{
    state.chain = $('chain').value;
  });

  $('btnLoad').addEventListener('click', ()=>{
    state.chain = $('chain').value;
    state.workerBase = $('worker').value.trim();
    dgSetWorkerBase(state.workerBase);
    state.address = $('mint').value.trim();
    $('title').textContent = `${state.chain.toUpperCase()} / ${state.address || '—'}`;
    $('subtitle').textContent = state.workerBase ? state.workerBase : '(same origin)';
    start();
  });

  // Prefill (optional)
  $('worker').value = '';
  $('mint').value = 'DezXA8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263';

  // ----- boot -----
  window.addEventListener('DOMContentLoaded', () => {
    try {
      const savedBase = (localStorage.getItem('dg_worker_base') || '').trim();
      const savedChain = (localStorage.getItem('dg_chain') || '').trim();
      const savedAddr = (localStorage.getItem('dg_addr') || '').trim();

      if (savedBase) document.getElementById('worker').value = savedBase;
      if (savedChain) document.getElementById('chain').value = savedChain;
      if (savedAddr) document.getElementById('mint').value = savedAddr;

      dgSetWorkerBase(document.getElementById('worker').value);
      dgSetChain(document.getElementById('chain').value);
      dgSetAddr(document.getElementById('mint').value);

      start();
      // one immediate refresh so UI doesn't look stuck
      refreshOnce().catch(()=>{});
    } catch (e) {
      console.error('[DG] boot error', e);
    }
  });

</script>
</body>
</html>
