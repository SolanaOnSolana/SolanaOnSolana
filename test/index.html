<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#070711" />
  <title>$SOS — Guardian Check (Multi-Chain)</title>
  <meta name="description" content="Guardian Approved — token risk score + launch readiness checklist (on-chain verifiable)." />

  <style>
    :root{
      --bg:#070711;
      --panel: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --g:#14F195;
      --c:#00D1FF;
      --p:#9945FF;
      --radius: 22px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --max: 1180px;
      --sol-g1:#14F195;
      --sol-g2:#00D1FF;
      --sol-g3:#9945FF;
      --bnb-yellow:#F0B90B;
      --base-blue:#0052FF;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font: 15.5px/1.55 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg);
      position:relative;
      overflow-x:hidden;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      z-index:-1;
      pointer-events:none;
      background:
        radial-gradient(1200px 700px at 10% 5%, rgba(153,69,255,.22), transparent 60%),
        radial-gradient(1000px 650px at 90% 10%, rgba(20,241,149,.18), transparent 55%),
        radial-gradient(900px 600px at 70% 85%, rgba(0,209,255,.14), transparent 55%),
        var(--bg);
      transform: translateZ(0);
    }
    a{color:inherit; text-decoration:none}
    .wrap{max-width:var(--max); margin:0 auto; padding:0 18px; width:100%;}
    main{padding:22px 0 42px}
    .topbar{
      position:sticky;
      top:0;
      z-index:20;
      backdrop-filter: blur(14px);
      background: rgba(7,7,17,.62);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 0;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 260px;
      user-select:none;
    }
    .brand img{
      width:40px;
      height:40px;
      object-fit:contain;
      filter: drop-shadow(0 10px 25px rgba(0,0,0,.45));
    }
    .bt{display:flex; flex-direction:column; line-height:1.05}
    .bt .t{font-weight:1000; letter-spacing:-.2px; font-size:16px}
    .bt .s{font-weight:850; color:var(--muted); font-size:12.5px}

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      width:100%;
    }
    @media (min-width: 980px){ .actions{width:auto} }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
      font-weight:950;
      font-size:13px;
      transition: .15s ease;
      user-select:none;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
    }
    .btn:hover{background: rgba(255,255,255,.10); transform: translateY(-1px)}
    .btn.grad{
      border:0;
      background: linear-gradient(90deg, var(--g), var(--c), var(--p));
      color:#061012;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .btn[disabled]{opacity:.55; pointer-events:none}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .inner{padding:22px}

    .hero{
      position:relative;
      overflow:hidden;
      isolation:isolate;
    }
    .hero::before{
      content:"";
      position:absolute;
      inset:-70px -40px;
      background:
        radial-gradient(900px 520px at 18% 28%, rgba(20,241,149,.16), transparent 60%),
        radial-gradient(900px 520px at 82% 20%, rgba(0,209,255,.12), transparent 60%),
        radial-gradient(900px 520px at 70% 86%, rgba(153,69,255,.14), transparent 60%);
      z-index:0;
      pointer-events:none;
    }
    .hero > *{position:relative; z-index:1}

    .h1{
      margin:0;
      font-weight:1000;
      letter-spacing:-1px;
      line-height:1.05;
      font-size: clamp(36px, 4.6vw, 62px);
    }
    .gradText{
      background: linear-gradient(90deg, var(--g), var(--c), var(--p));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .sub{
      margin-top:10px;
      color: rgba(255,255,255,.76);
      font-weight:850;
      max-width: 940px;
    }

    .classified{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .stamp{
      font-weight:1000;
      font-size:12px;
      letter-spacing: .45px;
      text-transform:uppercase;
      color: rgba(255,255,255,.76);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      padding:7px 10px;
    }

    .layout{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){ .layout{grid-template-columns:1fr} }

    .panel{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      padding:16px;
      overflow:hidden;
    }

    label{
      display:block;
      font-weight:950;
      font-size:12.5px;
      letter-spacing:.35px;
      color: rgba(255,255,255,.82);
      margin-bottom:8px;
    }
    input{
      width:100%;
      padding:14px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      outline:none;
      font-weight:900;
      letter-spacing:.2px;
      font-size:16px;
      max-width:100%;
    }
    input:focus{
      border-color: rgba(0,209,255,.45);
      box-shadow: 0 0 0 3px rgba(0,209,255,.12);
    }

    .statusLine{
      margin-top:12px;
      color: rgba(255,255,255,.72);
      font-weight:900;
      min-height: 18px;
      font-size:13px;
      overflow-wrap:anywhere;
      word-break:break-word;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:7px 11px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
    }
    .badge.good{border:0; background: linear-gradient(90deg,var(--g),var(--c),var(--p)); color:#061012}
    .badge.warn{border-color: rgba(255,220,130,.35); background: rgba(255,220,130,.08); color: rgba(255,240,210,.92)}
    .badge.bad{border-color: rgba(255,120,150,.35); background: rgba(255,120,150,.10); color: rgba(255,190,205,.95)}

    .resultTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .resultTitle{
      margin:0;
      font-weight:1000;
      font-size:22px;
      letter-spacing:-.4px;
    }
    .mono{
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-weight:900;
      color: rgba(255,255,255,.86);
      margin-top:6px;
      overflow-wrap:anywhere;
      word-break:break-word;
    }

    .tokenHead{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:10px;
      min-width:0;
    }
    .tokenLogoWrap{
      width:44px;
      height:44px;
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      display:none;
      flex:0 0 auto;
    }
    .tokenLogoWrap img{ width:100%; height:100%; object-fit:cover; display:block; }
    .tokenName{
      font-weight:1000;
      font-size:16px;
      letter-spacing:-.2px;
      line-height:1.15;
      overflow-wrap:anywhere;
      word-break:break-word;
    }
    .tokenSymbol{
      margin-top:2px;
      color: rgba(255,255,255,.70);
      font-weight:900;
      font-size:12.5px;
    }

    .metricStack{margin-top:12px; display:grid; gap:10px;}
    .metric{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding:12px 12px;
    }
    .metricK{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: rgba(255,255,255,.70);
      font-weight:1000;
      font-size:12px;
      letter-spacing:.45px;
      text-transform:uppercase;
    }
    .metricV{
      margin-top:8px;
      font-weight:1000;
      font-size:20px;
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .metricMini{
      margin-top:6px;
      font-weight:850;
      font-size:12px;
      color: rgba(255,255,255,.62);
      overflow-wrap:anywhere;
      word-break:break-word;
    }
    .bar{
      margin-top:10px;
      height:12px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--g), var(--c), var(--p));
      border-radius:999px;
      transition: width .25s ease;
    }

    .list{
      margin:10px 0 0;
      padding:0;
      list-style:none;
      display:grid;
      gap:10px;
    }
    .li{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      border-radius: 16px;
      padding:12px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      min-width:0;
    }
    .li .left{min-width:0;}
    .li .t{font-weight:1000; font-size:13px; letter-spacing:.2px;}
    .li .d{
      margin-top:4px;
      color: rgba(255,255,255,.70);
      font-weight:750;
      font-size:12.5px;
      line-height:1.35;
      overflow-wrap:anywhere;
      word-break:break-word;
    }

    .pillRow{
      display:flex;
      gap:8px;
      align-items:center;
      flex:0 0 auto;
      justify-content:flex-end;
    }
    .pill{
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      cursor:pointer;
    }
    .pill.ok{border:0; background: linear-gradient(90deg,var(--g),var(--c),var(--p)); color:#061012}
    .pill.warn{border-color: rgba(255,220,130,.35); background: rgba(255,220,130,.08); color: rgba(255,240,210,.92)}
    .pill.bad{border-color: rgba(255,120,150,.35); background: rgba(255,120,150,.10); color: rgba(255,190,205,.95)}
    .infoBtn{
      width:26px;
      height:26px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.86);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      font-weight:1000;
      font-size:13px;
      line-height:1;
      -webkit-tap-highlight-color: transparent;
    }
    .infoBtn:hover{ background: rgba(255,255,255,.10); transform: translateY(-1px); }
    .infoBtn:active{ transform: translateY(0px); }
    .infoBtn span{ transform: translateY(-0.5px); }

    .explorerBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .explorerBtn:hover{ background: rgba(255,255,255,.10); transform: translateY(-1px); }

    /* Bubble map */
    .bubbleWrap{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      border-radius: 16px;
      padding:12px;
    }
    .bubbleHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .bubbleTitle{
      font-weight:1000; letter-spacing:.35px; font-size:12px; text-transform:uppercase; color: rgba(255,255,255,.72);
    }
    canvas{ display:block; width:100%; height:240px; border-radius: 12px; }

    footer{
      padding: 18px 0 34px;
      color: rgba(255,255,255,.45);
      font-weight:650;
      text-align:center;
      font-size:12px;
    }

    /* Modal + Toast */
    .modalWrap{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:100;
    }
    .modal{
      width:min(920px, 100%);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(7,7,17,.92);
      box-shadow: 0 16px 50px rgba(0,0,0,.5);
      overflow:hidden;
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .modalTitle{ font-weight:1000; letter-spacing:-.3px; }
    .modalBody{
      padding:14px 16px 16px;
      color: rgba(255,255,255,.84);
      font-weight:850;
      line-height:1.5;
      overflow-wrap:anywhere;
      word-break:break-word;
    }

    .chainRow{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .chainBtn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
      font-weight:1000;
      font-size:13px;
      color: rgba(255,255,255,.88);
      -webkit-tap-highlight-color: transparent;
    }
    .chainBtn:hover{ background: rgba(255,255,255,.10); }
    .chainBtn.active{
      border:0;
      background: linear-gradient(90deg, var(--g), var(--c), var(--p));
      color:#061012;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .chainIcon{
      width:18px;
      height:18px;
      border-radius:6px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
    }
    .chainIcon svg{ width:18px; height:18px; display:block; }
    .chainMiniHint{
      margin-top:10px;
      font-size:12.5px;
      color: rgba(255,255,255,.62);
      font-weight:850;
      line-height:1.35;
    }

    .toast{
      position:fixed;
      top: max(16px, env(safe-area-inset-top));
      left:50%;
      transform:translateX(-50%);
      width:min(920px, calc(100% - 28px));
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(7,7,17,.90);
      box-shadow: 0 16px 50px rgba(0,0,0,.45);
      padding:14px 14px;
      display:none;
      z-index:120;
      backdrop-filter: blur(12px);
    }
    .toastRow{display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .toastTitle{font-weight:1000; font-size:18px; letter-spacing:-.3px;}
    .toastClose{
      padding:9px 12px;
      border-radius:999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
      font-weight:950;
      cursor:pointer;
    }
    .toastClose:hover{background: rgba(255,255,255,.10);}

    @media (max-width: 980px){
      .wrap{ padding: 0 14px; }
      .inner{ padding: 16px; }
      .panel{ padding: 14px; }
      .brand{ min-width: 0; width: 100%; }
      .actions{ width: 100%; justify-content: flex-start; }
      .actions .btn{ width: 100%; justify-content: center; padding: 12px 14px; font-size: 14px; }
      .resultTop{ flex-direction: column; align-items: stretch; }
      .resultTop > div:last-child{ width: 100%; justify-content: flex-start; }
      .resultTop .badge{ width: fit-content; }
      .metricV{ flex-direction: column; align-items: flex-start; gap: 6px; font-size: 22px; }
      .li{ flex-direction: column; align-items: flex-start; gap: 10px; }
      .pillRow{ width:100%; justify-content:flex-start; flex-wrap:wrap; }
      .toast{ left:14px; right:14px; transform:none; width:auto; }
      canvas{ height:220px; }
    }
    @media (prefers-reduced-motion: reduce){
      .btn:hover{transform:none}
      .bar > div{transition:none}
      .infoBtn:hover{transform:none}
      .explorerBtn:hover{transform:none}
    }
  </style>
</head>

<body>
  <!-- Toast -->
  <div class="toast" id="toast">
    <div class="toastRow">
      <div class="toastTitle" id="toastTitle">—</div>
      <button class="toastClose" id="toastClose" type="button">Close</button>
    </div>
  </div>

  <!-- Topbar -->
  <div class="topbar">
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <img src="/assets/logo.png" alt="$SOS" onerror="this.style.display='none'">
          <div class="bt">
            <div class="t">$SOS</div>
            <div class="s">Contract Scanner • Token Risk</div>
          </div>
        </div>

        <div class="actions">
          <a class="btn" href="https://solanax1.com/" rel="noreferrer">← Back to Main</a>
          <button class="btn grad" id="btnScan" type="button">Run Guardian Check</button>
          <button class="btn grad" id="btnExport" type="button" disabled>Download Scan Report</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main -->
  <main class="wrap">
    <section class="card hero">
      <div class="inner">
        <div class="classified">
          <div class="stamp">GUARDIAN SYSTEM • MAINNET • ON-CHAIN VERIFIED</div>
          <div class="stamp" id="stampTime">—</div>
        </div>

        <h1 class="h1" style="margin-top:12px;">
          <span class="gradText">Guardian Contract</span> Scanner
        </h1>

        <div class="sub">Multi-chain scan: Solana + ETH + BNB + Base.</div>

        <div class="layout">
          <!-- INPUT -->
          <div class="panel">
            <label>Choose Chain</label>
            <div class="chainRow" id="chainRow"></div>
            <div class="chainMiniHint" id="chainHint">—</div>

            <label for="addr" style="margin-top:14px;" id="addrLabel">Token Address</label>
            <input id="addr" placeholder="Paste token address..." autocomplete="off" spellcheck="false" inputmode="text" />
            <button class="btn grad" id="btnScanInline" type="button" style="width:100%; margin-top:12px;">Run Guardian Check</button>
            <div class="statusLine" id="status"></div>
          </div>

          <!-- RESULTS -->
          <div class="panel" id="resultsPanel">
            <div class="resultTop">
              <div style="min-width:0">
                <div class="tokenHead">
                  <div class="tokenLogoWrap" id="tokenLogoWrap"><img id="tokenLogo" alt=""></div>
                  <div style="min-width:0">
                    <div class="tokenName" id="tokenName">—</div>
                    <div class="tokenSymbol" id="tokenSymbol">—</div>
                  </div>
                </div>

                <h3 class="resultTitle" id="verdictTitle">—</h3>
                <div class="mono" id="addrShort">—</div>
              </div>

              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <span class="badge" id="verdictBadge">—</span>
                <span class="badge good" id="scoreBadge">—</span>
              </div>
            </div>

            <div class="metricStack" id="metrics"></div>
            <div class="statusLine" id="summary">—</div>

            <!-- Bubble map -->
            <div class="bubbleWrap" id="bubbleWrap" style="display:none;">
              <div class="bubbleHead">
                <div class="bubbleTitle">Holder Bubble Map (Top holders)</div>
                <span class="badge" id="bubbleBadge">—</span>
              </div>
              <canvas id="bubbleCanvas" width="920" height="240"></canvas>
              <div class="statusLine" style="margin-top:8px; color:rgba(255,255,255,.62)">
                Bubble size = holder % (preview). Visual heuristic.
              </div>
            </div>
          </div>
        </div>

        <!-- Checks -->
        <div class="panel" style="margin-top:16px;">
          <div class="classified">
            <div class="stamp">GUARDIAN CHECKS</div>
            <div class="stamp" id="scanHint">—</div>
          </div>
          <ul class="list" id="checksList" style="margin-top:10px;"></ul>
        </div>

        <!-- Launch readiness -->
        <div class="panel" style="margin-top:16px;">
          <div class="classified">
            <div class="stamp">LAUNCH READINESS</div>
            <div class="stamp">ACTION LIST</div>
          </div>
          <ul class="list" id="todoList" style="margin-top:10px;"></ul>
        </div>

        <!-- Token standard details -->
        <div class="panel" style="margin-top:16px;">
          <div class="classified">
            <div class="stamp">TOKEN STANDARD DETAILS</div>
            <div class="stamp">ON-CHAIN</div>
          </div>
          <ul class="list" id="stdList" style="margin-top:10px;"></ul>
        </div>

        <!-- Metadata -->
        <div class="panel" style="margin-top:16px;">
          <div class="classified">
            <div class="stamp">TOKEN METADATA</div>
            <div class="stamp">RPC / ON-CHAIN</div>
          </div>
          <ul class="list" id="metaList" style="margin-top:10px;"></ul>
        </div>

        <!-- Top holders -->
        <div class="panel" style="margin-top:16px;">
          <div class="classified">
            <div class="stamp">TOP HOLDERS (PREVIEW)</div>
            <div class="stamp" id="holdersStamp">MAINNET</div>
          </div>
          <ul class="list" id="holdersList" style="margin-top:10px;"></ul>
        </div>
      </div>
    </section>

    <footer>© <span id="y"></span> $SOS • Guardian Check</footer>
  </main>

  <!-- Modal -->
  <div class="modalWrap" id="modalWrap" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle" id="modalTitle">Guardian Details</div>
        <button class="btn" id="modalClose" type="button">Close</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>
<script>
/* =========================================================
  GUARDIAN CHECK — Stable Rebuild (5 Parts)
  TEIL 2/5: Core UI / State / Chain Switch / Bubble Map (fixed)
========================================================= */

const CFG = {
  HELIUS_KEY: "b566a086-57d4-4433-8661-faed9ad07ba0",
  GOLDRUSH_API_KEY: "cqt_rQVTMTXwYkPJBrwf7ff6JWmdkywR",

  TOKEN_PROGRAM: "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA",
  TOKEN_2022_PROGRAM: "TokenzQdBNbLqP5VEhdkAS6EPFLC1PHnBqCXEpPxuEb",

  CHAINS: [
    { id:"sol",  name:"Solana",   kind:"solana", stamp:"MAINNET",       addrLabel:"Token Mint Address",       placeholder:"Paste token mint (Solana)..." },
    { id:"eth",  name:"Ethereum", kind:"evm",    chainId:1,    stamp:"ETH MAINNET",  addrLabel:"Token Contract Address", placeholder:"Paste ERC-20 contract (0x...)" },
    { id:"bnb",  name:"BNB",      kind:"evm",    chainId:56,   stamp:"BNB MAINNET",  addrLabel:"Token Contract Address", placeholder:"Paste BEP-20 contract (0x...)" },
    { id:"base", name:"Base",     kind:"evm",    chainId:8453, stamp:"BASE MAINNET", addrLabel:"Token Contract Address", placeholder:"Paste Base token contract (0x...)" }
  ],

  EVM_RPCS: {
    1:    ["https://ethereum.publicnode.com", "https://rpc.ankr.com/eth",  "https://eth.llamarpc.com", "https://cloudflare-eth.com"],
    56:   ["https://bsc.publicnode.com",      "https://rpc.ankr.com/bsc",  "https://bsc-dataseed.binance.org"],
    8453: ["https://base.publicnode.com",     "https://rpc.ankr.com/base", "https://mainnet.base.org"]
  },

  UI: { REPORT_LOGO_URL: "https://solanax1.com/assets/logo.png" }
};

/* =============== ICONS =============== */
const CSSV = (k, fb) => (getComputedStyle(document.documentElement).getPropertyValue(k).trim() || fb);
const ICONS = {
  sol: `
    <svg viewBox="0 0 64 64" aria-hidden="true">
      <defs><linearGradient id="solg" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0" stop-color="${CSSV('--sol-g1','#14F195')}"/>
        <stop offset="0.5" stop-color="${CSSV('--sol-g2','#00D1FF')}"/>
        <stop offset="1" stop-color="${CSSV('--sol-g3','#9945FF')}"/>
      </linearGradient></defs>
      <path d="M14 18c1.6-1.8 3.5-2.7 5.7-2.7h33.6c3.3 0 5 4 2.8 6.5l-6.1 6.8c-1.6 1.8-3.5 2.7-5.7 2.7H10.7c-3.3 0-5-4-2.8-6.5L14 18Z" fill="url(#solg)"/>
      <path d="M14 38.9c1.6-1.8 3.5-2.7 5.7-2.7h33.6c3.3 0 5 4 2.8 6.5l-6.1 6.8c-1.6 1.8-3.5 2.7-5.7 2.7H10.7c-3.3 0-5-4-2.8-6.5L14 38.9Z" fill="url(#solg)" opacity=".7"/>
    </svg>`,
  eth: `<svg viewBox="0 0 64 64"><path d="M32 6l16 26-16 9-16-9L32 6Z" fill="currentColor" opacity=".95"/><path d="M32 58l16-22-16 9-16-9 16 22Z" fill="currentColor" opacity=".75"/></svg>`,
  bnb: `<svg viewBox="0 0 64 64"><path fill="${CSSV('--bnb-yellow','#F0B90B')}" d="M32 6l8.6 8.6L32 23.2l-8.6-8.6L32 6Zm15.4 15.4L56 30l-8.6 8.6-8.6-8.6L47.4 21.4ZM16.6 21.4 25.2 30l-8.6 8.6L8 30l8.6-8.6ZM32 32.8l8.6 8.6L32 50l-8.6-8.6L32 32.8Zm0-6.9 5.1 5.1L32 36.2 26.9 31 32 25.9Z"/></svg>`,
  base:`<svg viewBox="0 0 64 64"><circle cx="32" cy="32" r="26" fill="${CSSV('--base-blue','#0052FF')}"/><path d="M27.5 22h8.1c6.2 0 11.2 5 11.2 11.1S41.8 44.2 35.6 44.2h-8.1V22Zm5.3 5.1v12h2.4c3.3 0 6-2.7 6-6s-2.7-6-6-6h-2.4Z" fill="#fff"/></svg>`
};

/* =============== DOM + Helpers =============== */
const qs = (id) => document.getElementById(id);
const on = (id, ev, fn) => { const el = qs(id); if(el) el.addEventListener(ev, fn); };
const esc = (x) => String(x ?? "")
  .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

const setText = (id, v) => { const el = qs(id); if(el) el.textContent = (v ?? ""); };
const setHTML = (id, v) => { const el = qs(id); if(el) el.innerHTML = (v ?? ""); };

function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function shortAddr(a){ return a ? (a.slice(0,6) + "…" + a.slice(-4)) : "—"; }
function fmtInt(n){
  if (n === null || n === undefined || Number.isNaN(n)) return "—";
  try { return new Intl.NumberFormat("en-US").format(Math.round(Number(n))); } catch { return String(n); }
}
function fmtPct(n){
  if (n === null || n === undefined || Number.isNaN(n)) return "—";
  return `${Number(n).toFixed(2)}%`;
}
function setStatus(msg){ setText("status", msg || ""); }

function looksBase58(s){
  return typeof s === "string"
    && s.length >= 32 && s.length <= 52
    && /^[1-9A-HJ-NP-Za-km-z]+$/.test(s);
}
function looksEvmAddress(s){ return typeof s === "string" && /^0x[0-9a-fA-F]{40}$/.test(s.trim()); }

/* =============== Modal / Toast =============== */
function openModal(title, bodyHtml){
  setText("modalTitle", title || "Guardian Details");
  setHTML("modalBody", bodyHtml || "");
  const w = qs("modalWrap");
  if(w){ w.style.display="flex"; w.setAttribute("aria-hidden","false"); }
}
function closeModal(){
  const w = qs("modalWrap");
  if(w){ w.style.display="none"; w.setAttribute("aria-hidden","true"); }
}
function showToast(title){
  const t = qs("toast");
  if(!t) return;
  setText("toastTitle", title || "");
  t.style.display="block";
}
function hideToast(){
  const t = qs("toast");
  if(!t) return;
  t.style.display="none";
}

/* =============== Info system (no duplicates) =============== */
const INFO_MAP = new Map();
function newInfoId(){ return "i_" + Math.random().toString(36).slice(2) + Date.now().toString(36); }
function registerInfo(html){
  const id = newInfoId();
  INFO_MAP.set(id, html);
  return id;
}
function getInfo(id){ return INFO_MAP.get(id) || ""; }

function explain(title, bullets){
  const body = (bullets||[]).map(b => `<div style="margin:6px 0">${esc(b)}</div>`).join("");
  return `
    <div style="font-weight:1000; font-size:18px; margin-bottom:10px">${esc(title)}</div>
    <div style="color:rgba(255,255,255,.72); font-weight:850; line-height:1.55">
      ${body}
    </div>`;
}
function pillLabel(sev){ return sev==="ok" ? "PASS" : sev==="bad" ? "FAIL" : "WATCH"; }
function pillClass(sev){ return sev==="ok" ? "pill ok" : sev==="bad" ? "pill bad" : "pill warn"; }

function setBadge(el, txt, mode){
  if(!el) return;
  el.textContent = txt ?? "";
  el.classList.remove("good","warn","bad");
  if(mode) el.classList.add(mode);
}

/* =============== State =============== */
let activeChain = CFG.CHAINS[0];
const SCAN_STATE = {
  scanning:false,
  completed:false,
  chain:null,
  addr:null,
  result:null,
  lastError:null
};

/* =============== Lists / Metrics render =============== */
function renderList(listEl, items){
  if(!listEl) return;
  listEl.innerHTML = "";
  for(const it of (items||[])){
    const sev = it.sev || "warn";
    const title = it.t || "Details";
    const desc = it.d || "—";
    const infoTitle = it.infoTitle || title;

    const html = (it.infoHtml && String(it.infoHtml).trim())
      ? String(it.infoHtml)
      : explain(infoTitle, [it.why || "—"]);

    const infoId = registerInfo(html);

    const li = document.createElement("li");
    li.className = "li";
    li.innerHTML = `
      <div class="left">
        <div class="t">${esc(title)}</div>
        <div class="d">${esc(desc)}</div>
      </div>
      <div class="pillRow">
        <span class="${pillClass(sev)}" role="button" tabindex="0"
              data-open="1" data-title="${esc(infoTitle)}" data-info="${esc(infoId)}">${pillLabel(sev)}</span>
        <button class="infoBtn" type="button" aria-label="Info"
                data-open="1" data-title="${esc(infoTitle)}" data-info="${esc(infoId)}"><span>i</span></button>
      </div>`;
    listEl.appendChild(li);
  }
}

function renderMetrics(rows){
  const wrap = qs("metrics");
  if(!wrap) return;
  wrap.innerHTML = "";
  for(const r of (rows || [])){
    const d = document.createElement("div");
    d.className = "metric";
    const bar = (typeof r.barPct === "number")
      ? `<div class="bar"><div style="width:${clamp(r.barPct,0,100)}%"></div></div>`
      : "";
    d.innerHTML = `
      <div class="metricK">
        <span>${esc(r.label || "—")}</span>
        <span class="badge" style="opacity:.9">${esc(r.badge || r.value || "—")}</span>
      </div>
      <div class="metricV">${esc(r.value || "—")}</div>
      <div class="metricMini">${esc(r.mini || "")}</div>
      ${bar}`;
    wrap.appendChild(d);
  }
}

function applyTokenHeader(meta, addr){
  const nameEl = qs("tokenName");
  const symEl  = qs("tokenSymbol");
  const wrap   = qs("tokenLogoWrap");
  const img    = qs("tokenLogo");

  const name = (meta?.name || "Token").trim() || "Token";
  const sym  = (meta?.symbol || "").trim();

  if(nameEl) nameEl.textContent = name;
  if(symEl)  symEl.textContent  = sym ? `$${sym}` : `Addr: ${shortAddr(addr)}`;

  if(wrap && img){
    if(meta?.image){
      img.src = meta.image;
      img.alt = name;
      wrap.style.display = "block";
      img.onerror = () => { wrap.style.display = "none"; };
    }else{
      wrap.style.display = "none";
      img.removeAttribute("src");
      img.alt = "";
    }
  }
}

function explorerBase(chain){
  if(chain.id === "sol")  return {name:"Solscan",   base:"https://solscan.io/account/"};
  if(chain.id === "eth")  return {name:"Etherscan", base:"https://etherscan.io/address/"};
  if(chain.id === "bnb")  return {name:"BscScan",   base:"https://bscscan.com/address/"};
  if(chain.id === "base") return {name:"BaseScan",  base:"https://basescan.org/address/"};
  return {name:"Explorer", base:"#"};
}

/* =============== Holders render + Bubble Map FIX (resize-safe) =============== */
function renderHoldersEmpty(){
  const el = qs("holdersList");
  if(!el) return;
  renderList(el, [{
    t:"No holder data",
    sev:"warn",
    d: activeChain.kind === "solana"
      ? "Top holders appear after scan."
      : (CFG.GOLDRUSH_API_KEY
          ? "No holders returned (indexer). Try again / different token."
          : "EVM holders need an indexer (GoldRush)."),
    infoHtml: explain("Top holders", [
      "Solana: largest token accounts (preview).",
      "EVM: JSON-RPC cannot enumerate holders; requires GoldRush indexer."
    ])
  }]);
}

function renderHoldersWithExplorer(items, chain){
  const el = qs("holdersList");
  if(!el) return;
  el.innerHTML = "";
  const ex = explorerBase(chain);

  for(const it of items){
    const infoId = registerInfo(it.infoHtml || explain("Top holder", [
      "Meaning: Share of supply (heuristic/preview).",
      "Why it matters: High % can mean dump risk."
    ]));

    const li = document.createElement("li");
    li.className = "li";
    li.innerHTML = `
      <div class="left">
        <div class="t">${esc(it.t || "Holder")}</div>
        <div class="d">${esc(it.d || "—")}</div>
      </div>
      <div class="pillRow">
        <a class="explorerBtn" href="${esc(ex.base + (it.addr||""))}" target="_blank" rel="noreferrer">${esc(ex.name)}</a>
        <button class="infoBtn" type="button" aria-label="Info"
                data-open="1" data-title="${esc(it.t || "Holder")}" data-info="${esc(infoId)}"><span>i</span></button>
      </div>`;
    el.appendChild(li);
  }
}

function holdersToBubbles(holders){
  return (holders||[]).slice(0, 20).map(h => ({
    addr: h.wallet,
    pct: Number(h.pct || 0),
    label: shortAddr(h.wallet || "")
  }));
}

function ensureCanvasSize(canvas, cssHeight=240){
  const rect = canvas.getBoundingClientRect();
  const w = Math.max(1, Math.floor(rect.width));
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  canvas.width = Math.floor(w * dpr);
  canvas.height = Math.floor(cssHeight * dpr);
  return { w: canvas.width, h: canvas.height, dpr };
}

function renderBubbleMap(holderBubbles){
  const wrap = qs("bubbleWrap");
  const canvas = qs("bubbleCanvas");
  const badge = qs("bubbleBadge");
  if(!wrap || !canvas || !badge) return;

  const items = Array.isArray(holderBubbles) ? holderBubbles.slice(0, 20) : [];
  if(!items.length){
    wrap.style.display = "none";
    window.__BUBBLE_MAP_DATA_URL = "";
    return;
  }

  wrap.style.display = "block";
  badge.textContent = `${items.length} wallets`;

  const { w, h, dpr } = ensureCanvasSize(canvas, 240);
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,w,h);

  ctx.globalAlpha = 0.25;
  for(let x=0;x<w;x+=Math.floor(48*dpr)){
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.strokeStyle="rgba(255,255,255,.08)"; ctx.stroke();
  }
  for(let y=0;y<h;y+=Math.floor(48*dpr)){
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.strokeStyle="rgba(255,255,255,.08)"; ctx.stroke();
  }
  ctx.globalAlpha = 1;

  const cx = w/2, cy = h/2;
  const maxPct = Math.max(...items.map(x => x.pct || 0), 1);
  const placed = [];

  function overlaps(x,y,r){
    for(const p of placed){
      const dx=x-p.x, dy=y-p.y;
      if(Math.sqrt(dx*dx+dy*dy) < r + p.r + 6*dpr) return true;
    }
    return false;
  }

  items.forEach((it, idx) => {
    const pct = Number(it.pct || 0);
    const r = (12 + (pct/maxPct)*42) * dpr;

    let angle = idx * 0.7, rad = 0;
    let x=cx, y=cy;
    for(let k=0;k<900;k++){
      rad += 0.7*dpr; angle += 0.35;
      x = cx + Math.cos(angle)*rad;
      y = cy + Math.sin(angle)*rad;
      if(x-r<8*dpr || x+r>w-8*dpr || y-r<8*dpr || y+r>h-8*dpr) continue;
      if(!overlaps(x,y,r)) break;
    }
    placed.push({x,y,r,label: it.label || shortAddr(it.addr || ""), pct});
  });

  for(const p of placed){
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
    ctx.fillStyle="rgba(255,255,255,.08)";
    ctx.fill();
    ctx.lineWidth = 2*dpr;
    ctx.strokeStyle="rgba(20,241,149,.55)";
    ctx.stroke();

    ctx.font = `${Math.max(10, Math.floor(11*dpr))}px ui-sans-serif, system-ui`;
    ctx.fillStyle="rgba(255,255,255,.85)";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(`${p.pct.toFixed(1)}%`, p.x, p.y - 6*dpr);

    ctx.font = `${Math.max(9, Math.floor(10*dpr))}px ui-monospace, Menlo, Consolas, monospace`;
    ctx.fillStyle="rgba(255,255,255,.62)";
    ctx.fillText(p.label, p.x, p.y + 10*dpr);
  }

  try{ window.__BUBBLE_MAP_DATA_URL = canvas.toDataURL("image/png"); }
  catch{ window.__BUBBLE_MAP_DATA_URL = ""; }
}

/* =============== Reset UI =============== */
function resetUIForNewScan(){
  SCAN_STATE.completed = false;
  SCAN_STATE.result = null;
  SCAN_STATE.lastError = null;

  setText("addrShort","—");
  setText("verdictTitle","—");
  setBadge(qs("verdictBadge"),"—");
  setText("scoreBadge","—");
  setText("summary","—");
  setText("scanHint","—");
  setText("tokenName","—");
  setText("tokenSymbol","—");

  const lw = qs("tokenLogoWrap");
  const img = qs("tokenLogo");
  if(lw) lw.style.display = "none";
  if(img){ img.removeAttribute("src"); img.alt = ""; }

  renderMetrics([]);
  renderList(qs("checksList"), [{
    t:"Waiting for scan", sev:"warn",
    d:"Paste an address and run the Guardian Check.",
    infoHtml: explain("Guardian Checks", [
      "After scanning, we generate checks & explanations per chain.",
      "Solana: mint/freeze authorities, supply, largest accounts.",
      "EVM: code/proxy/owner/paused + ERC-20 metadata."
    ])
  }]);
  renderList(qs("todoList"), [{
    t:"Waiting for scan", sev:"warn",
    d:"Launch readiness tasks appear after scan.",
    infoHtml: explain("Launch Readiness", ["We derive an action list from detected on-chain signals."])
  }]);
  renderList(qs("stdList"), [{
    t:"Waiting for scan", sev:"warn",
    d:"Standard details appear after scan.",
    infoHtml: explain("Token Standard", ["Solana: SPL vs Token-2022.", "EVM: ERC-20 selectors + proxy detection."])
  }]);
  renderList(qs("metaList"), [{
    t:"Waiting for scan", sev:"warn",
    d:"Metadata appears after scan.",
    infoHtml: explain("Token Metadata", ["Solana: Helius DAS getAsset().", "EVM: name/symbol/decimals/totalSupply via eth_call."])
  }]);

  renderHoldersEmpty();
  renderBubbleMap([]);

  const ex = qs("btnExport");
  if(ex){ ex.disabled = true; ex.textContent = "Download Scan Report"; }
}

/* =============== Chain UI =============== */
function renderChainButtons(){
  const row = qs("chainRow");
  if(!row) return;
  row.innerHTML = "";
  for(const c of CFG.CHAINS){
    const b = document.createElement("button");
    b.type = "button";
    b.className = "chainBtn" + (c.id === activeChain.id ? " active" : "");
    b.innerHTML = `<span class="chainIcon">${ICONS[c.id] || ""}</span><span>${esc(c.name)}</span>`;
    b.addEventListener("click", () => setActiveChain(c.id, true));
    row.appendChild(b);
  }
}
function setActiveChain(chainId, pushUrl){
  const found = CFG.CHAINS.find(x => x.id === chainId) || CFG.CHAINS[0];
  activeChain = found;

  renderChainButtons();
  setText("holdersStamp", activeChain.stamp || "MAINNET");
  setText("addrLabel", activeChain.addrLabel || "Token Address");

  const addr = qs("addr");
  if(addr) addr.placeholder = activeChain.placeholder || "Paste token address...";

  setText("chainHint", activeChain.kind === "evm"
    ? (CFG.GOLDRUSH_API_KEY ? "EVM holders enabled (GoldRush)." : "Tip: add GoldRush key to show EVM holders.")
    : "Solana: Helius RPC for on-chain signals.");

  setStatus("");
  resetUIForNewScan();

  if(pushUrl){
    const url = new URL(location.href);
    url.searchParams.set("chain", activeChain.id);
    history.replaceState({}, "", url.toString());
  }
}

/* =============== Live time =============== */
let STAMP_TIMER = null;
function updateStampTime(){
  const el = qs("stampTime");
  if(!el) return;
  const now = new Date();
  const live = new Intl.DateTimeFormat("de-DE", {
    timeZone: "Europe/Berlin",
    year:"numeric", month:"2-digit", day:"2-digit",
    hour:"2-digit", minute:"2-digit", second:"2-digit"
  }).format(now);
  el.textContent = live;
}
function startLiveStampTime(){
  if(STAMP_TIMER) clearInterval(STAMP_TIMER);
  updateStampTime();
  STAMP_TIMER = setInterval(updateStampTime, 1000);
}

/* =============== One-time bindings (NO duplicates) =============== */
let __BOUND = false;
function bindOnce(){
  if(__BOUND) return;
  __BOUND = true;

  on("modalClose","click",closeModal);
  on("modalWrap","click",(e)=>{ if(e.target===qs("modalWrap")) closeModal(); });
  on("toastClose","click",hideToast);

  // One delegate for info buttons
  document.addEventListener("click",(e)=>{
    const t = e.target;
    const node = t?.closest?.("[data-open='1']");
    if(!node) return;
    const title = node.getAttribute("data-title") || "Details";
    const infoId = node.getAttribute("data-info") || "";
    const html = getInfo(infoId) || explain(title, ["No details available."]);
    openModal(title, html);
  });

  document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeModal(); });

  // Bubble map rerender on resize (keeps it from "disappearing")
  window.addEventListener("resize", ()=>{
    if(SCAN_STATE.completed && SCAN_STATE.result?.holders){
      renderBubbleMap(holdersToBubbles(SCAN_STATE.result.holders));
    }
  }, { passive:true });
}

function initCore(){
  setText("y", String(new Date().getFullYear()));
  startLiveStampTime();
  bindOnce();

  const url = new URL(location.href);
  const chainParam = url.searchParams.get("chain");
  if(chainParam) setActiveChain(chainParam, false);
  else setActiveChain(activeChain.id, false);

  const addrParam = url.searchParams.get("addr");
  if(addrParam && qs("addr")) qs("addr").value = addrParam;

  resetUIForNewScan();
}

if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", initCore);
else initCore();
<script>
/* =========================================================
  TEIL 3/5 — SCAN ENGINE
  Solana + EVM (ETH / BNB / BASE)
========================================================= */

/* =============== EVM ABI / Helpers =============== */
const ERC20_SIG = {
  name:"0x06fdde03",
  symbol:"0x95d89b41",
  decimals:"0x313ce567",
  totalSupply:"0x18160ddd",
  owner:"0x8da5cb5b",
  paused:"0x5c975abb"
};

const EIP1967 = {
  impl:"0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc"
};

function strip0x(x){ return String(x||"").replace(/^0x/,""); }
function hexToBigInt(x){ try{return BigInt("0x"+strip0x(x));}catch{return null;} }

async function evmRpc(url, method, params){
  const r = await fetch(url,{
    method:"POST",
    headers:{ "content-type":"application/json" },
    body:JSON.stringify({ jsonrpc:"2.0", id:1, method, params })
  });
  const j = await r.json();
  if(j.error) throw new Error(j.error.message);
  return j.result;
}

async function evmFallback(chainId, fn){
  for(const rpc of CFG.EVM_RPCS[chainId] || []){
    try{ return await fn(rpc); }catch{}
  }
  throw new Error("All RPCs failed");
}

/* =============== GoldRush Holders =============== */
async function fetchGoldrushHolders(chainId, addr){
  if(!CFG.GOLDRUSH_API_KEY) return [];
  const url = `https://api.covalenthq.com/v1/${chainId}/tokens/${addr}/token_holders/?page-size=20&key=${CFG.GOLDRUSH_API_KEY}`;
  const r = await fetch(url);
  const j = await r.json();
  const items = j?.data?.items || [];
  return items.map(x=>({
    wallet:x.address,
    balance:BigInt(x.balance||"0")
  }));
}

/* =============== Solana RPC =============== */
function heliusUrl(){
  return `https://mainnet.helius-rpc.com/?api-key=${CFG.HELIUS_KEY}`;
}
async function solRpc(method, params){
  const r = await fetch(heliusUrl(),{
    method:"POST",
    headers:{ "content-type":"application/json" },
    body:JSON.stringify({ jsonrpc:"2.0", id:1, method, params })
  });
  const j = await r.json();
  if(j.error) throw new Error(j.error.message);
  return j.result;
}

/* =============== Solana Scan =============== */
async function scanSolana(mint){
  const info = await solRpc("getParsedAccountInfo",[mint,{commitment:"confirmed"}]);
  const p = info?.value?.data?.parsed?.info || {};

  const supplyRes = await solRpc("getTokenSupply",[mint]);
  const supplyRaw = BigInt(supplyRes?.value?.amount || "0");
  const supplyUi = Number(supplyRes?.value?.uiAmount || 0);

  const largest = await solRpc("getTokenLargestAccounts",[mint]);
  const accs = largest?.value || [];

  const holders = accs.map(a=>{
    const raw = BigInt(a.amount||"0");
    return {
      wallet:a.address,
      pct: supplyRaw>0n ? Number((raw*10000n)/supplyRaw)/100 : 0
    };
  }).sort((a,b)=>b.pct-a.pct).slice(0,10);

  let meta = { name:"Token", symbol:"", image:"" };
  try{
    const asset = await solRpc("getAsset",{ id:mint });
    meta.name = asset?.content?.metadata?.name || meta.name;
    meta.symbol = asset?.content?.metadata?.symbol || meta.symbol;
    meta.image = asset?.content?.links?.image || "";
  }catch{}

  return {
    meta,
    signals:{
      kind:"solana",
      mintAuthActive:!!p.mintAuthority,
      freezeAuthActive:!!p.freezeAuthority,
      program:info?.value?.owner,
      supplyUi,
      topHolderPct:holders[0]?.pct ?? null
    },
    holders
  };
}

/* =============== EVM Scan =============== */
async function scanEvm(chain, addr){
  const chainId = chain.chainId;

  const code = await evmFallback(chainId,(rpc)=>evmRpc(rpc,"eth_getCode",[addr,"latest"]));
  const hasCode = code && code !== "0x";

  let name=null,symbol=null,decimals=null,totalSupplyRaw=null;

  if(hasCode){
    try{
      name = await evmFallback(chainId,(r)=>evmRpc(r,"eth_call",[{to:addr,data:ERC20_SIG.name},"latest"]));
    }catch{}
    try{
      symbol = await evmFallback(chainId,(r)=>evmRpc(r,"eth_call",[{to:addr,data:ERC20_SIG.symbol},"latest"]));
    }catch{}
    try{
      decimals = Number(hexToBigInt(await evmFallback(chainId,(r)=>evmRpc(r,"eth_call",[{to:addr,data:ERC20_SIG.decimals},"latest"]))));
    }catch{}
    try{
      totalSupplyRaw = hexToBigInt(await evmFallback(chainId,(r)=>evmRpc(r,"eth_call",[{to:addr,data:ERC20_SIG.totalSupply},"latest"])));
    }catch{}
  }

  let holders=[], topHolderPct=null;
  if(totalSupplyRaw && CFG.GOLDRUSH_API_KEY){
    const raw = await fetchGoldrushHolders(chainId, addr);
    holders = raw.map(h=>({
      wallet:h.wallet,
      pct:Number((h.balance*10000n)/totalSupplyRaw)/100
    })).sort((a,b)=>b.pct-a.pct).slice(0,10);
    topHolderPct = holders[0]?.pct ?? null;
  }

  return {
    meta:{ name:"Token", symbol:"", image:"" },
    signals:{
      kind:"evm",
      hasCode,
      decimals,
      totalSupplyUi: totalSupplyRaw && decimals!=null ? Number(totalSupplyRaw/(10n**BigInt(decimals))) : null,
      topHolderPct
    },
    holders
  };
}

/* =============== Main Scan Runner =============== */
async function runGuardianScan(){
  if(SCAN_STATE.scanning) return;

  const addr = (qs("addr")?.value||"").trim();
  if(activeChain.kind==="solana" && !looksBase58(addr)){
    setStatus("Invalid Solana address"); return;
  }
  if(activeChain.kind==="evm" && !looksEvmAddress(addr)){
    setStatus("Invalid EVM address"); return;
  }

  SCAN_STATE.scanning = true;
  SCAN_STATE.addr = addr;
  SCAN_STATE.chain = activeChain;

  setStatus("Scanning…");
  resetUIForNewScan();
  setText("addrShort", addr);

  try{
    const res = activeChain.kind==="solana"
      ? await scanSolana(addr)
      : await scanEvm(activeChain, addr);

    SCAN_STATE.result = res;
    SCAN_STATE.completed = true;

    applyTokenHeader(res.meta, addr);
    renderHoldersWithExplorer(
      res.holders.map(h=>({
        t:"Holder",
        d:`${shortAddr(h.wallet)} • ${fmtPct(h.pct)}`,
        addr:h.wallet
      })),
      activeChain
    );
    renderBubbleMap(holdersToBubbles(res.holders));

    setStatus("Scan complete");
    qs("btnExport").disabled = false;
  }catch(e){
    setStatus("Scan failed: "+e.message);
  }finally{
    SCAN_STATE.scanning = false;
  }
}

/* Bind scan buttons */
qs("btnScan").addEventListener("click",runGuardianScan);
qs("btnScanInline").addEventListener("click",runGuardianScan);
</script>

<script>
/* =========================================================
  TEIL 4/5 — RENDER PIPELINE (Score/Verdict/Checks/Todos/Meta/Std)
  WICHTIG:
  - Wir lassen TEIL 3 unverändert
  - Wir intercepten Button-Clicks im CAPTURE-Phase, damit die alten
    Listener nicht mehr feuern (stopImmediatePropagation)
  - Alle UI-Sektionen werden wieder sauber gefüllt (kein "Bubble only" Bug)
========================================================= */

/* =============== Score / Verdict =============== */
function verdictFrom(score, critical){
  if(critical) return { label:"FLAGGED", mode:"bad",  title:"FLAGGED • High Risk" };
  if(score >= 80) return { label:"APPROVED", mode:"good", title:"APPROVED • Guardian Grade" };
  if(score >= 50) return { label:"OBSERVED", mode:"warn", title:"OBSERVED • Mixed Signals" };
  return { label:"FLAGGED", mode:"bad", title:"FLAGGED • High Risk" };
}

function computeScore(sig){
  let score = 100;
  let critical = false;

  if(sig.kind === "solana"){
    if(sig.mintAuthActive){ score -= 35; critical = true; }
    if(sig.freezeAuthActive){ score -= 15; }
    if(sig.program && String(sig.program) === CFG.TOKEN_2022_PROGRAM){ score -= 8; }
  }else{
    if(!sig.hasCode){ score = 0; critical = true; }
    if(Number.isFinite(sig.decimals) === false) score -= 6;
  }

  if(Number.isFinite(sig.topHolderPct)){
    const p = sig.topHolderPct;
    if(p >= 35){ score -= 30; critical = true; }
    else if(p >= 20) score -= 18;
    else if(p >= 10) score -= 8;
  }

  score = clamp(Math.round(score), 0, 100);
  return { score, critical };
}

/* =============== Builders for UI sections =============== */
function buildMetricRows(meta, sig){
  const rows = [];
  if(sig.kind === "solana"){
    rows.push({
      label:"Supply (UI)",
      value: Number.isFinite(sig.supplyUi) ? fmtInt(sig.supplyUi) : "—",
      badge:"ON-CHAIN",
      mini:"getTokenSupply() uiAmount"
    });
    rows.push({
      label:"Mint Authority",
      value: sig.mintAuthActive ? "Active" : "Revoked",
      badge: sig.mintAuthActive ? "RISK" : "OK",
      barPct: sig.mintAuthActive ? 85 : 10,
      mini: sig.mintAuthActive ? "Minting possible" : "Fixed supply signal"
    });
    rows.push({
      label:"Freeze Authority",
      value: sig.freezeAuthActive ? "Active" : "Revoked",
      badge: sig.freezeAuthActive ? "WATCH" : "OK",
      barPct: sig.freezeAuthActive ? 55 : 10,
      mini: sig.freezeAuthActive ? "Freezing possible" : "No freeze control"
    });
    rows.push({
      label:"Top Holder (preview)",
      value: Number.isFinite(sig.topHolderPct) ? fmtPct(sig.topHolderPct) : "—",
      badge:"HOLDERS",
      barPct: Number.isFinite(sig.topHolderPct) ? clamp(sig.topHolderPct,0,100) : 0,
      mini:"largest accounts (preview)"
    });
    rows.push({
      label:"Token Program",
      value: sig.program ? (sig.program === CFG.TOKEN_2022_PROGRAM ? "Token-2022" : "SPL Token") : "—",
      badge:"PROGRAM",
      mini: sig.program || "—"
    });
  }else{
    rows.push({
      label:"Contract",
      value: sig.hasCode ? "Deployed" : "Not found",
      badge: sig.hasCode ? "OK" : "FAIL",
      barPct: sig.hasCode ? 90 : 0,
      mini:"eth_getCode()"
    });
    rows.push({
      label:"Decimals",
      value: Number.isFinite(sig.decimals) ? String(sig.decimals) : "—",
      badge:"ERC-20",
      mini:"decimals() best-effort"
    });
    rows.push({
      label:"Total Supply (UI)",
      value: Number.isFinite(sig.totalSupplyUi) ? fmtInt(sig.totalSupplyUi) : "—",
      badge:"ERC-20",
      mini:"totalSupply normalized"
    });
    rows.push({
      label:"Top Holder (preview)",
      value: Number.isFinite(sig.topHolderPct) ? fmtPct(sig.topHolderPct) : "—",
      badge: CFG.GOLDRUSH_API_KEY ? "HOLDERS" : "INDEXER",
      barPct: Number.isFinite(sig.topHolderPct) ? clamp(sig.topHolderPct,0,100) : 0,
      mini: CFG.GOLDRUSH_API_KEY ? "GoldRush token_holders" : "Needs GoldRush key"
    });
  }
  return rows;
}

function makeChecks(sig){
  const out = [];
  if(sig.kind === "solana"){
    out.push({
      t:"Mint Authority",
      sev: sig.mintAuthActive ? "bad" : "ok",
      d: sig.mintAuthActive ? "Active mint authority detected." : "Mint authority revoked.",
      infoHtml: explain("Mint Authority", [
        "If mint authority is active, supply can be increased.",
        "For fixed supply, revoke mint authority."
      ])
    });
    out.push({
      t:"Freeze Authority",
      sev: sig.freezeAuthActive ? "warn" : "ok",
      d: sig.freezeAuthActive ? "Freeze authority active." : "Freeze authority revoked.",
      infoHtml: explain("Freeze Authority", [
        "Freeze authority can block transfers for accounts.",
        "If not required, revoke it."
      ])
    });
    out.push({
      t:"Top Holder Concentration",
      sev: (sig.topHolderPct >= 35) ? "bad" : (sig.topHolderPct >= 15 ? "warn" : "ok"),
      d: Number.isFinite(sig.topHolderPct) ? `Largest holder ~${sig.topHolderPct.toFixed(2)}% (preview).` : "No holder signal.",
      infoHtml: explain("Top Holder Concentration", [
        "High concentration increases dump risk.",
        "Preview is based on largest accounts returned by RPC."
      ])
    });
    out.push({
      t:"Token Program",
      sev: (sig.program === CFG.TOKEN_2022_PROGRAM) ? "warn" : "ok",
      d: sig.program ? (sig.program === CFG.TOKEN_2022_PROGRAM ? "Token-2022 detected (extensions possible)." : "SPL Token detected.") : "Unknown program.",
      infoHtml: explain("Token Program", [
        "Token-2022 can include extensions (fees/hooks).",
        "Classic SPL Token is widely supported."
      ])
    });
  }else{
    out.push({
      t:"Contract Code",
      sev: sig.hasCode ? "ok" : "bad",
      d: sig.hasCode ? "Bytecode found (deployed contract)." : "No code at address.",
      infoHtml: explain("Contract Code", [
        "If eth_getCode returns 0x, it is not a contract or not deployed."
      ])
    });
    out.push({
      t:"ERC-20 Metadata",
      sev: (Number.isFinite(sig.decimals) ? "ok" : "warn"),
      d: Number.isFinite(sig.decimals) ? `Decimals = ${sig.decimals}` : "Decimals not detected (best-effort).",
      infoHtml: explain("ERC-20", [
        "We call standard selectors via eth_call.",
        "Some tokens are non-standard; decoding may fail."
      ])
    });
    out.push({
      t:"Top Holder Concentration",
      sev: (sig.topHolderPct >= 35) ? "bad" : (sig.topHolderPct >= 15 ? "warn" : "ok"),
      d: Number.isFinite(sig.topHolderPct)
        ? `Largest holder ~${sig.topHolderPct.toFixed(2)}% (preview).`
        : (CFG.GOLDRUSH_API_KEY ? "No holder signal from indexer." : "Needs GoldRush key to show holders."),
      infoHtml: explain("Holders (EVM)", [
        "RPC cannot enumerate all holders on EVM.",
        "We use GoldRush token_holders when available."
      ])
    });
  }
  return out;
}

function makeTodos(sig){
  const out = [];
  out.push({
    t:"Publish verified links",
    sev:"warn",
    d:"Add official website/docs/socials + verified explorer links.",
    infoHtml: explain("Links", [
      "Reduces impersonation/scam clones.",
      "Users need a single source of truth."
    ])
  });

  if(sig.kind === "solana"){
    if(sig.mintAuthActive){
      out.push({
        t:"Revoke mint authority",
        sev:"bad",
        d:"If supply should be fixed, revoke mint authority.",
        infoHtml: explain("Revoke mint authority", [
          "Active mint authority can inflate supply."
        ])
      });
    }
    if(sig.freezeAuthActive){
      out.push({
        t:"Revoke freeze authority",
        sev:"warn",
        d:"If not needed, revoke freeze authority.",
        infoHtml: explain("Revoke freeze authority", [
          "Freeze can block transfers and is often abused."
        ])
      });
    }
  }

  if(Number.isFinite(sig.topHolderPct) && sig.topHolderPct >= 15){
    out.push({
      t:"Reduce whale concentration",
      sev:"warn",
      d:`Largest holder is ~${sig.topHolderPct.toFixed(2)}%. Consider vesting/locks/distribution.`,
      infoHtml: explain("Concentration", [
        "High concentration increases dump risk.",
        "Use vesting, LP locks, or distribution changes."
      ])
    });
  }

  return out;
}

function makeStd(sig){
  if(sig.kind === "solana"){
    const is2022 = sig.program === CFG.TOKEN_2022_PROGRAM;
    return [{
      t:"Standard",
      sev: is2022 ? "warn" : "ok",
      d: is2022 ? "Token-2022 (extensions possible)" : "SPL Token (classic)",
      infoHtml: explain("Token Standard", [
        is2022 ? "Token-2022 may include extensions." : "Classic SPL Token is widely supported."
      ])
    }];
  }
  return [{
    t:"Standard",
    sev:"ok",
    d:"ERC-20 (best-effort via selectors)",
    infoHtml: explain("ERC-20", [
      "Uses eth_call for standard function selectors.",
      "Some contracts are non-standard."
    ])
  }];
}

function makeMeta(meta, sig){
  const name = (meta?.name || "Token").trim() || "Token";
  const symbol = (meta?.symbol || "").trim() || "—";
  const img = meta?.image ? "Image URL detected" : "No image detected";

  if(sig.kind === "solana"){
    return [
      { t:"Name / Symbol", sev:"ok", d:`${name} (${symbol})`, infoHtml: explain("Metadata", ["Helius DAS getAsset() (best-effort)."]) },
      { t:"Image", sev: meta?.image ? "ok" : "warn", d: img, infoHtml: explain("Image", ["Not all tokens publish an image in metadata."]) }
    ];
  }
  return [
    { t:"Name / Symbol", sev:"ok", d:`${name} (${symbol})`, infoHtml: explain("Metadata", ["EVM meta is limited without token lists/indexers."]) },
    { t:"Decimals / Supply", sev:"ok", d:`decimals=${Number.isFinite(sig.decimals)?sig.decimals:"—"} • supply=${Number.isFinite(sig.totalSupplyUi)?fmtInt(sig.totalSupplyUi):"—"}`, infoHtml: explain("Decimals / Supply", ["Best-effort decoded via eth_call."]) }
  ];
}

/* =============== Final render (ALL sections) =============== */
function renderScanResult(meta, sig, holders){
  applyTokenHeader(meta, SCAN_STATE.addr);
  setText("addrShort", SCAN_STATE.addr || "—");

  const { score, critical } = computeScore(sig);
  const v = verdictFrom(score, critical);

  setText("verdictTitle", v.title);
  setBadge(qs("verdictBadge"), v.label, v.mode);
  setText("scoreBadge", `${score}/100`);

  renderMetrics(buildMetricRows(meta, sig));

  // summary line
  const bits = [];
  if(sig.kind === "solana"){
    bits.push(sig.program === CFG.TOKEN_2022_PROGRAM ? "Token-2022" : "SPL");
    if(sig.mintAuthActive) bits.push("mint active");
    if(sig.freezeAuthActive) bits.push("freeze active");
  }else{
    bits.push(sig.hasCode ? "contract ok" : "no code");
    if(Number.isFinite(sig.decimals)) bits.push(`decimals ${sig.decimals}`);
  }
  if(Number.isFinite(sig.topHolderPct)) bits.push(`top holder ${sig.topHolderPct.toFixed(2)}%`);
  setText("summary", bits.length ? `Signals: ${bits.join(" • ")}` : "Signals: —");

  renderList(qs("checksList"), makeChecks(sig));
  renderList(qs("todoList"), makeTodos(sig));
  renderList(qs("stdList"), makeStd(sig));
  renderList(qs("metaList"), makeMeta(meta, sig));

  // holders + bubble
  if(Array.isArray(holders) && holders.length){
    renderHoldersWithExplorer(
      holders.map(h=>({
        t:"Holder",
        d:`${shortAddr(h.wallet)} • ${fmtPct(h.pct)}`,
        addr:h.wallet
      })),
      activeChain
    );
    renderBubbleMap(holdersToBubbles(holders));
  }else{
    renderHoldersEmpty();
    renderBubbleMap([]);
  }

  // export unlock (Teil 5 macht echte Export-Logik)
  const ex = qs("btnExport");
  if(ex){ ex.disabled = false; ex.textContent = "Download Scan Report"; }

  setText("scanHint", `${activeChain.stamp || "MAINNET"} • done`);
}

/* =============== V2 Runner (intercepts old listeners) =============== */
async function runGuardianScanV2(){
  if(SCAN_STATE.scanning) return;

  const addr = (qs("addr")?.value||"").trim();
  if(activeChain.kind==="solana" && !looksBase58(addr)){
    setStatus("Invalid Solana mint address (base58)."); showToast("Invalid address"); return;
  }
  if(activeChain.kind==="evm" && !looksEvmAddress(addr)){
    setStatus("Invalid EVM address (0x + 40 hex)."); showToast("Invalid address"); return;
  }

  SCAN_STATE.scanning = true;
  SCAN_STATE.completed = false;
  SCAN_STATE.chain = activeChain;
  SCAN_STATE.addr = addr;
  SCAN_STATE.result = null;
  SCAN_STATE.lastError = null;

  setStatus("Scanning…");
  setText("scanHint", `${activeChain.stamp || "MAINNET"} • scanning…`);
  resetUIForNewScan();
  setText("addrShort", addr);

  try{
    const res = (activeChain.kind==="solana")
      ? await scanSolana(addr)
      : await scanEvm(activeChain, addr);

    SCAN_STATE.result = res;
    SCAN_STATE.completed = true;

    renderScanResult(res.meta, res.signals, res.holders);

    setStatus("Scan complete.");
    hideToast();
  }catch(e){
    SCAN_STATE.lastError = String(e?.message || e);
    setStatus("Error: " + SCAN_STATE.lastError);
    setText("scanHint", `${activeChain.stamp || "MAINNET"} • error`);
    showToast("Scan failed");
  }finally{
    SCAN_STATE.scanning = false;
  }
}

/* =============== Intercept Buttons (capture) =============== */
(function bindScanCapture(){
  const b1 = qs("btnScan");
  const b2 = qs("btnScanInline");
  if(b1){
    b1.addEventListener("click",(e)=>{
      e.preventDefault();
      e.stopImmediatePropagation();
      runGuardianScanV2();
    }, true);
  }
  if(b2){
    b2.addEventListener("click",(e)=>{
      e.preventDefault();
      e.stopImmediatePropagation();
      runGuardianScanV2();
    }, true);
  }

  const input = qs("addr");
  if(input){
    input.addEventListener("keydown",(e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        runGuardianScanV2();
      }
    }, true);
  }
})();
<script>
/* =========================================================
  TEIL 5/5 — EXPORT (Download Scan Report) + FINAL SAFE WIRES
  Ziel:
  - Export Button funktioniert immer (auch wenn alte Listener existieren)
  - Report ist "clean" wie Website: dark + gradient + cards + mobile grid
  - Enthält: Verdict/Score, Metrics, Checks, Todos, Standard, Metadata,
            Top holders + Bubble Map PNG (wenn vorhanden)
========================================================= */

function nowBerlinStamp(){
  const dt = new Date();
  const fmt = new Intl.DateTimeFormat("de-DE", {
    timeZone:"Europe/Berlin",
    year:"numeric", month:"2-digit", day:"2-digit",
    hour:"2-digit", minute:"2-digit", second:"2-digit"
  }).format(dt);
  // "16.01.2026, 12:34:56" -> "2026-01-16_12-34-56" (approx)
  const parts = fmt.replace(",","").split(" ");
  const d = (parts[0]||"").split(".").reverse().join("-");
  const t = (parts[1]||"").replaceAll(":","-");
  return `${d}_${t}`;
}

function reportCss(){
  return `
:root{
  --bg:#070711;
  --panel: rgba(255,255,255,.06);
  --stroke: rgba(255,255,255,.12);
  --text: rgba(255,255,255,.92);
  --muted: rgba(255,255,255,.70);
  --g:#14F195;
  --c:#00D1FF;
  --p:#9945FF;
  --r:18px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font: 14.5px/1.55 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  color:var(--text);
  background: var(--bg);
  padding: 22px;
}
body::before{
  content:"";
  position:fixed;
  inset:0;
  z-index:-1;
  pointer-events:none;
  background:
    radial-gradient(1200px 700px at 10% 5%, rgba(153,69,255,.20), transparent 60%),
    radial-gradient(1000px 650px at 90% 10%, rgba(20,241,149,.16), transparent 55%),
    radial-gradient(900px 600px at 70% 85%, rgba(0,209,255,.12), transparent 55%),
    var(--bg);
}
.wrap{max-width:980px; margin:0 auto}
.card{
  border:1px solid rgba(255,255,255,.10);
  background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.05));
  border-radius: var(--r);
  padding: 16px;
  margin-bottom: 14px;
}
.row{display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:space-between}
.h1{
  margin:0;
  font-weight:1000;
  letter-spacing:-.6px;
  font-size: 28px;
  line-height:1.1;
}
.grad{
  background: linear-gradient(90deg, var(--g), var(--c), var(--p));
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;
}
.sub{color: rgba(255,255,255,.74); font-weight:850; margin-top:6px}
.badge{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:7px 11px;
  border-radius:999px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  font-weight:1000;
  font-size:12px;
  white-space:nowrap;
}
.badge.good{border:0; background: linear-gradient(90deg,var(--g),var(--c),var(--p)); color:#061012}
.badge.warn{border-color: rgba(255,220,130,.35); background: rgba(255,220,130,.08); color: rgba(255,240,210,.92)}
.badge.bad{border-color: rgba(255,120,150,.35); background: rgba(255,120,150,.10); color: rgba(255,190,205,.95)}
.mono{font-family: ui-monospace, Menlo, Consolas, monospace; font-weight:900; color: rgba(255,255,255,.86)}
.grid{display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top: 12px}
@media (max-width: 720px){ body{padding:14px} .grid{grid-template-columns:1fr} }
.metric{
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  border-radius: 14px;
  padding: 12px;
}
.mk{display:flex; align-items:center; justify-content:space-between; gap:10px; color:rgba(255,255,255,.70); font-weight:1000; font-size:12px; letter-spacing:.45px; text-transform:uppercase}
.mv{margin-top:8px; font-weight:1000; font-size:18px}
.mini{margin-top:6px; color: rgba(255,255,255,.65); font-weight:850; font-size:12px}
.bar{margin-top:10px; height:10px; border-radius:999px; background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.10); overflow:hidden}
.bar > div{height:100%; background: linear-gradient(90deg, var(--g), var(--c), var(--p)); width:0%}
h2{margin:0 0 10px; font-size: 16px; letter-spacing:-.3px}
ul{margin:0; padding:0; list-style:none; display:grid; gap:10px}
li{
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.14);
  border-radius: 14px;
  padding: 12px;
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
}
.lt{font-weight:1000; font-size:13px}
.ld{margin-top:4px; color: rgba(255,255,255,.70); font-weight:800; font-size:12.5px; line-height:1.35}
.pill{font-weight:1000; font-size:12px; border-radius:999px; padding:6px 10px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06)}
.pill.ok{border:0; background: linear-gradient(90deg,var(--g),var(--c),var(--p)); color:#061012}
.pill.warn{border-color: rgba(255,220,130,.35); background: rgba(255,220,130,.08); color: rgba(255,240,210,.92)}
.pill.bad{border-color: rgba(255,120,150,.35); background: rgba(255,120,150,.10); color: rgba(255,190,205,.95)}
table{width:100%; border-collapse:collapse; overflow:hidden; border-radius: 14px; border:1px solid rgba(255,255,255,.10)}
th,td{padding:10px 10px; text-align:left; font-size:12.5px; border-bottom:1px solid rgba(255,255,255,.08)}
th{color: rgba(255,255,255,.72); font-weight:1000; letter-spacing:.35px; text-transform:uppercase; font-size:11.5px; background: rgba(255,255,255,.04)}
tr:last-child td{border-bottom:0}
a{color: rgba(255,255,255,.92); text-decoration:none}
a:hover{text-decoration:underline}
.imgBox{
  margin-top:12px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.14);
  border-radius: 14px;
  padding: 12px;
}
.imgBox img{width:100%; height:auto; display:block; border-radius: 10px}
.foot{color: rgba(255,255,255,.50); font-weight:800; font-size:12px; text-align:center; margin-top:18px}
  `;
}

function sevToPill(sev){
  return sev === "ok" ? "pill ok" : sev === "bad" ? "pill bad" : "pill warn";
}
function modeToBadge(mode){
  return mode === "good" ? "badge good" : mode === "bad" ? "badge bad" : "badge warn";
}

function reportListItemHtml(it){
  const sev = it?.sev || "warn";
  const t = esc(it?.t || "—");
  const d = esc(it?.d || "—");
  return `
    <li>
      <div style="min-width:0">
        <div class="lt">${t}</div>
        <div class="ld">${d}</div>
      </div>
      <div class="${sevToPill(sev)}">${esc(pillLabel(sev))}</div>
    </li>
  `;
}

function reportMetricsHtml(rows){
  const cards = (rows||[]).map(r=>{
    const bar = (typeof r.barPct === "number")
      ? `<div class="bar"><div style="width:${clamp(r.barPct,0,100)}%"></div></div>`
      : "";
    return `
      <div class="metric">
        <div class="mk">
          <span>${esc(r.label || "—")}</span>
          <span class="badge" style="opacity:.9">${esc(r.badge || r.value || "—")}</span>
        </div>
        <div class="mv">${esc(r.value || "—")}</div>
        <div class="mini">${esc(r.mini || "")}</div>
        ${bar}
      </div>
    `;
  }).join("");
  return `<div class="grid">${cards}</div>`;
}

function holdersTableHtml(holders, chain){
  const ex = explorerBase(chain);
  if(!Array.isArray(holders) || !holders.length){
    return `<div class="sub" style="margin-top:8px;">No holder data available.</div>`;
  }
  const rows = holders.map((h,i)=>{
    const addr = String(h.wallet||"");
    const link = ex.base + addr;
    return `
      <tr>
        <td>${i+1}</td>
        <td class="mono"><a href="${esc(link)}" target="_blank" rel="noreferrer">${esc(addr)}</a></td>
        <td>${esc(Number(h.pct||0).toFixed(2))}%</td>
      </tr>
    `;
  }).join("");
  return `
    <table>
      <thead><tr><th>#</th><th>Wallet</th><th>Share</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function buildReportHtml(){
  if(!SCAN_STATE.completed || !SCAN_STATE.result) throw new Error("No completed scan to export.");

  const chain = SCAN_STATE.chain;
  const addr  = SCAN_STATE.addr;
  const res   = SCAN_STATE.result;

  const meta = res.meta || {name:"Token",symbol:"",image:""};
  const sig  = res.signals || {kind:chain?.kind || "evm"};
  const holders = Array.isArray(res.holders) ? res.holders : [];

  const stamp = nowBerlinStamp();
  const name = (meta.name || "Token").trim() || "Token";
  const sym  = (meta.symbol || "").trim();

  const { score, critical } = computeScore(sig);
  const v = verdictFrom(score, critical);

  const metricRows = buildMetricRows(meta, sig);
  const checks = makeChecks(sig);
  const todos  = makeTodos(sig);
  const std    = makeStd(sig);
  const metaList = makeMeta(meta, sig);

  const ex = explorerBase(chain);
  const explorerLink = ex.base + addr;

  const bubblePng = window.__BUBBLE_MAP_DATA_URL || "";
  const bubbleBlock = bubblePng
    ? `<div class="imgBox">
         <div class="mk" style="margin-bottom:8px;">
           <span>Holder Bubble Map</span><span class="badge">PNG</span>
         </div>
         <img src="${esc(bubblePng)}" alt="Holder Bubble Map"/>
         <div class="mini">Bubble size = holder % (preview). Visual heuristic.</div>
       </div>`
    : "";

  const tokenImg = meta.image
    ? `<div style="width:52px;height:52px;border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.14);flex:0 0 auto">
         <img src="${esc(meta.image)}" alt="" style="width:100%;height:100%;object-fit:cover;display:block" />
       </div>`
    : "";

  // compact JSON snapshot for later debugging (optional)
  const snapshot = {
    generated_at_berlin: stamp,
    chain: chain?.id,
    chain_stamp: chain?.stamp,
    address: addr,
    meta,
    signals: sig,
    holders
  };

  return `<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="theme-color" content="#070711"/>
  <title>Guardian Report — ${esc(chain?.name || "Chain")} — ${esc(shortAddr(addr))}</title>
  <style>${reportCss()}</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div style="display:flex; gap:12px; align-items:center; min-width:0">
          ${tokenImg}
          <div style="min-width:0">
            <div class="h1"><span class="grad">Guardian Report</span></div>
            <div class="sub">${esc(chain?.name || "Chain")} • ${esc(chain?.stamp || "MAINNET")} • ${esc(stamp.replaceAll("_"," "))}</div>
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
          <span class="${modeToBadge(v.mode)}">${esc(v.label)}</span>
          <span class="badge good">${esc(score)}/100</span>
        </div>
      </div>

      <div style="margin-top:12px; display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap">
        <div style="min-width:0">
          <div style="font-weight:1000; font-size:16px; letter-spacing:-.2px">${esc(name)}</div>
          <div class="sub">${sym ? esc("$"+sym) : "—"}</div>
          <div class="mono" style="margin-top:10px;">
            <a href="${esc(explorerLink)}" target="_blank" rel="noreferrer">${esc(addr)}</a>
          </div>
        </div>
        <div style="min-width:240px">
          <div class="sub" style="margin-top:2px">Verdict</div>
          <div style="font-weight:1000; font-size:18px; letter-spacing:-.2px">${esc(v.title)}</div>
          <div class="mini" style="margin-top:6px">
            Heuristic risk scan — always verify sources and audited code.
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Metrics</h2>
      ${reportMetricsHtml(metricRows)}
    </div>

    <div class="card">
      <h2>Guardian Checks</h2>
      <ul>${checks.map(reportListItemHtml).join("")}</ul>
    </div>

    <div class="card">
      <h2>Launch Readiness</h2>
      <ul>${todos.map(reportListItemHtml).join("")}</ul>
    </div>

    <div class="card">
      <h2>Token Standard</h2>
      <ul>${std.map(reportListItemHtml).join("")}</ul>
    </div>

    <div class="card">
      <h2>Token Metadata</h2>
      <ul>${metaList.map(reportListItemHtml).join("")}</ul>
    </div>

    <div class="card">
      <h2>Top Holders (preview)</h2>
      ${holdersTableHtml(holders, chain)}
      ${bubbleBlock}
    </div>

    <div class="foot">
      © ${new Date().getFullYear()} • Guardian Check • exported from ${esc(location.origin)}
    </div>

    <script type="application/json" id="guardian_snapshot">${esc(JSON.stringify(snapshot))}</script>
  </div>
</body>
</html>`;
}

function downloadText(filename, text){
  const blob = new Blob([text], { type:"text/html;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 2500);
}

async function exportReportV2(){
  try{
    if(!SCAN_STATE.completed || !SCAN_STATE.result){
      showToast("No completed scan to export");
      setStatus("Run a scan first, then export.");
      return;
    }

    // ensure bubble PNG exists (if bubble visible)
    try{
      if(SCAN_STATE.result?.holders?.length){
        renderBubbleMap(holdersToBubbles(SCAN_STATE.result.holders));
      }
    }catch{}

    const chainId = SCAN_STATE.chain?.id || "chain";
    const addrShort = (shortAddr(SCAN_STATE.addr || "addr") || "addr").replaceAll("…","-");
    const stamp = nowBerlinStamp();
    const file = `guardian-report_${chainId}_${addrShort}_${stamp}.html`;

    const html = buildReportHtml();
    downloadText(file, html);

    showToast("Report downloaded");
    setTimeout(hideToast, 1400);
  }catch(e){
    showToast("Export failed");
    setStatus("Export error: " + String(e?.message || e));
  }
}

/* =============== EXPORT Button intercept (capture) =============== */
(function bindExportCapture(){
  const b = qs("btnExport");
  if(!b) return;

  b.addEventListener("click", (e)=>{
    e.preventDefault();
    e.stopImmediatePropagation();
    exportReportV2();
  }, true);
})();

/* =============== Safety: keep bubble PNG fresh for exports =============== */
(function keepBubbleFresh(){
  // After scan: bubble is already rendered in Teil 4.
  // On resize: Teil 2 already re-renders bubble.
  // Here we only ensure export has up-to-date png.
  window.__EXPORT_READY = true;
})();
</script>

</body>
</html>


